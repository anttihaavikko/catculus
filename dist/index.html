<html><head><meta charset="utf-8"/><title>404</title><style>body{margin:0;overflow:hidden;background:#000}</style></head><body><script>/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	// The require scope
/******/ 	var __webpack_require__ = {};
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/************************************************************************/
var __webpack_exports__ = {};

// EXPORTS
__webpack_require__.d(__webpack_exports__, {
  H: () => (/* binding */ HEIGHT),
  m: () => (/* binding */ WIDTH)
});

;// CONCATENATED MODULE: ./src/song.ts
var song = null;

;// CONCATENATED MODULE: ./src/engine/audio-player.ts
/* eslint-disable @typescript-eslint/no-unused-vars */
/* eslint-disable no-var */
/* -*- mode: javascript; tab-width: 4; indent-tabs-mode: nil; -*-
*
*
* Copyright (c) 2011-2013 Marcus Geelnard
*
* This software is provided 'as-is', without any express or implied
* warranty. In no event will the authors be held liable for any damages
* arising from the use of this software.
*
* Permission is granted to anyone to use this software for any purpose,
* including commercial applications, and to alter it and redistribute it
* freely, subject to the following restrictions:
*
* 1. The origin of this software must not be misrepresented; you must not
*    claim that you wrote the original software. If you use this software
*    in a product, an acknowledgment in the product documentation would be
*    appreciated but is not required.
*
* 2. Altered source versions must be plainly marked as such, and must not be
*    misrepresented as being the original software.
*
* 3. This notice may not be removed or altered from any source
*    distribution.
*
*/
/*
* Edited by Antti Haavikko 2023,
* Removed some unused parts to save on final file size.
*/

// Some general notes and recommendations:
//  * This code uses modern ECMAScript features, such as ** instead of
//    Math.pow(). You may have to modify the code to make it work on older
//    browsers.
//  * If you're not using all the functionality (e.g. not all oscillator types,
//    or certain effects), you can reduce the size of the player routine even
//    further by deleting the code.
var CPlayer = function () {
    //--------------------------------------------------------------------------
    // Private methods
    //--------------------------------------------------------------------------
    // Oscillators
    var osc_sin = function (value) {
        return Math.sin(value * 6.283184);
    };
    var osc_saw = function (value) {
        return 2 * (value % 1) - 1;
    };
    var osc_square = function (value) {
        return (value % 1) < 0.5 ? 1 : -1;
    };
    var osc_tri = function (value) {
        var v2 = (value % 1) * 4;
        if (v2 < 2)
            return v2 - 1;
        return 3 - v2;
    };
    var getnotefreq = function (n) {
        // 174.61.. / 44100 = 0.003959503758 (F3)
        return 0.003959503758 * (Math.pow(2, ((n - 128) / 12)));
    };
    var createNote = function (instr, n, rowLen) {
        var osc1 = mOscillators[instr.i[0]], o1vol = instr.i[1], o1xenv = instr.i[3] / 32, osc2 = mOscillators[instr.i[4]], o2vol = instr.i[5], o2xenv = instr.i[8] / 32, noiseVol = instr.i[9], attack = instr.i[10] * instr.i[10] * 4, sustain = instr.i[11] * instr.i[11] * 4, release = instr.i[12] * instr.i[12] * 4, releaseInv = 1 / release, expDecay = -instr.i[13] / 16, arp = instr.i[14], arpInterval = rowLen * (Math.pow(2, (2 - instr.i[15])));
        var noteBuf = new Int32Array(attack + sustain + release);
        // Re-trig oscillators
        var c1 = 0, c2 = 0;
        // Local variables.
        var j, j2, e, t, rsample, o1t, o2t;
        // Generate one note (attack + sustain + release)
        for (j = 0, j2 = 0; j < attack + sustain + release; j++, j2++) {
            if (j2 >= 0) {
                // Switch arpeggio note.
                // arp = (arp >> 8) | ((arp & 255) << 4);
                // j2 -= arpInterval;
                // Calculate note frequencies for the oscillators
                o1t = getnotefreq(n + (arp & 15) + instr.i[2] - 128);
                o2t = getnotefreq(n + (arp & 15) + instr.i[6] - 128) * (1 + 0.0008 * instr.i[7]);
            }
            // Envelope
            e = 1;
            if (j < attack) {
                e = j / attack;
            }
            else if (j >= attack + sustain) {
                e = (j - attack - sustain) * releaseInv;
                e = (1 - e) * (Math.pow(3, (expDecay * e)));
            }
            // Oscillator 1
            c1 += o1t * Math.pow(e, o1xenv);
            rsample = osc1(c1) * o1vol;
            // Oscillator 2
            c2 += o2t * Math.pow(e, o2xenv);
            rsample += osc2(c2) * o2vol;
            // Noise oscillator
            if (noiseVol) {
                rsample += (2 * Math.random() - 1) * noiseVol;
            }
            // Add to (mono) channel buffer
            noteBuf[j] = (80 * rsample * e) | 0;
        }
        return noteBuf;
    };
    //--------------------------------------------------------------------------
    // Private members
    //--------------------------------------------------------------------------
    // Array of oscillator functions
    var mOscillators = [
        osc_sin,
        osc_square,
        osc_saw,
        osc_tri
    ];
    // Private variables set up by init()
    var mSong, mLastRow, mCurrentCol, mNumWords, mMixBuf;
    //--------------------------------------------------------------------------
    // Initialization
    //--------------------------------------------------------------------------
    this.init = function (song) {
        // Define the song
        mSong = song;
        // Init iteration state variables
        mLastRow = song.endPattern;
        mCurrentCol = 0;
        // Prepare song info
        mNumWords = song.rowLen * song.patternLen * (mLastRow + 1) * 2;
        // Create work buffer (initially cleared)
        mMixBuf = new Int32Array(mNumWords);
    };
    //--------------------------------------------------------------------------
    // Public methods
    //--------------------------------------------------------------------------
    // Generate audio data for a single track
    this.generate = function () {
        // Local variables
        var i, j, b, p, row, col, n, cp, k, t, lfor, e, x, rsample, rowStartSample, f, da;
        // Put performance critical items in local variables
        var chnBuf = new Int32Array(mNumWords), instr = mSong.songData[mCurrentCol], rowLen = mSong.rowLen, patternLen = mSong.patternLen;
        // Clear effect state
        var low = 0, band = 0, high;
        var lsample, filterActive = false;
        // Clear note cache.
        var noteCache = [];
        // Patterns
        for (p = 0; p <= mLastRow; ++p) {
            cp = instr.p[p];
            // Pattern rows
            for (row = 0; row < patternLen; ++row) {
                // Execute effect command.
                // var cmdNo = cp ? instr.c[cp - 1].f[row] : 0;
                // if (cmdNo) {
                //     instr.i[cmdNo - 1] = instr.c[cp - 1].f[row + patternLen] || 0;
                //     // Clear the note cache since the instrument has changed.
                //     if (cmdNo < 17) {
                //         noteCache = [];
                //     }
                // }
                // Put performance critical instrument properties in local variables
                var oscLFO = mOscillators[instr.i[16]], lfoAmt = instr.i[17] / 512, lfoFreq = (Math.pow(2, (instr.i[18] - 9))) / rowLen, fxLFO = instr.i[19], fxFilter = instr.i[20], fxFreq = instr.i[21] * 43.23529 * 3.141592 / 44100, q = 1 - instr.i[22] / 255, dist = instr.i[23] * 1e-5, drive = instr.i[24] / 32, panAmt = instr.i[25] / 512, panFreq = 6.283184 * (Math.pow(2, (instr.i[26] - 9))) / rowLen, dlyAmt = instr.i[27] / 255, dly = instr.i[28] * rowLen & ~1; // Must be an even number
                // Calculate start sample number for this row in the pattern
                rowStartSample = (p * patternLen + row) * rowLen;
                // Generate notes for this pattern row
                for (col = 0; col < 4; ++col) {
                    n = cp ? instr.c[cp - 1].n[row + col * patternLen] : 0;
                    if (n) {
                        if (!noteCache[n]) {
                            noteCache[n] = createNote(instr, n, rowLen);
                        }
                        // Copy note from the note cache
                        var noteBuf = noteCache[n];
                        for (j = 0, i = rowStartSample * 2; j < noteBuf.length; j++, i += 2) {
                            chnBuf[i] += noteBuf[j];
                        }
                    }
                }
                // Perform effects for this pattern row
                for (j = 0; j < rowLen; j++) {
                    // Dry mono-sample
                    k = (rowStartSample + j) * 2;
                    rsample = chnBuf[k];
                    // We only do effects if we have some sound input
                    if (rsample || filterActive) {
                        // State variable filter
                        f = fxFreq;
                        if (fxLFO) {
                            f *= oscLFO(lfoFreq * k) * lfoAmt + 0.5;
                        }
                        f = 1.5 * Math.sin(f);
                        low += f * band;
                        high = q * (rsample - band) - low;
                        band += f * high;
                        rsample = fxFilter == 3 ? band : fxFilter == 1 ? high : low;
                        // Distortion
                        if (dist) {
                            rsample *= dist;
                            rsample = rsample < 1 ? rsample > -1 ? osc_sin(rsample * .25) : -1 : 1;
                            rsample /= dist;
                        }
                        // Drive
                        rsample *= drive;
                        // Is the filter active (i.e. still audiable)?
                        filterActive = rsample * rsample > 1e-5;
                        // Panning
                        t = Math.sin(panFreq * k) * panAmt + 0.5;
                        lsample = rsample * (1 - t);
                        rsample *= t;
                    }
                    else {
                        lsample = 0;
                    }
                    // Delay is always done, since it does not need sound input
                    if (k >= dly) {
                        // Left channel = left + right[-p] * t
                        lsample += chnBuf[k - dly + 1] * dlyAmt;
                        // Right channel = right + left[-p] * t
                        rsample += chnBuf[k - dly] * dlyAmt;
                    }
                    // Store in stereo channel buffer (needed for the delay effect)
                    chnBuf[k] = lsample | 0;
                    chnBuf[k + 1] = rsample | 0;
                    // ...and add to stereo mix buffer
                    mMixBuf[k] += lsample | 0;
                    mMixBuf[k + 1] += rsample | 0;
                }
            }
        }
        // Next iteration. Return progress (1.0 == done!).
        mCurrentCol++;
        return mCurrentCol / mSong.numChannels;
    };
    // Create a AudioBuffer from the generated audio data
    this.createAudioBuffer = function (context) {
        var buffer = context.createBuffer(2, mNumWords / 2, 44100);
        for (var i = 0; i < 2; i++) {
            var data = buffer.getChannelData(i);
            for (var j = i; j < mNumWords; j += 2) {
                data[j >> 1] = mMixBuf[j] / 65536;
            }
        }
        return buffer;
    };
    // Create a WAVE formatted Uint8Array from the generated audio data
    this.createWave = function () {
        // Create WAVE header
        var headerLen = 44;
        var l1 = headerLen + mNumWords * 2 - 8;
        var l2 = l1 - 36;
        var wave = new Uint8Array(headerLen + mNumWords * 2);
        wave.set([82, 73, 70, 70,
            l1 & 255, (l1 >> 8) & 255, (l1 >> 16) & 255, (l1 >> 24) & 255,
            87, 65, 86, 69, 102, 109, 116, 32, 16, 0, 0, 0, 1, 0, 2, 0,
            68, 172, 0, 0, 16, 177, 2, 0, 4, 0, 16, 0, 100, 97, 116, 97,
            l2 & 255, (l2 >> 8) & 255, (l2 >> 16) & 255, (l2 >> 24) & 255]);
        // Append actual wave data
        for (var i = 0, idx = headerLen; i < mNumWords; ++i) {
            // Note: We clamp here
            var y = mMixBuf[i];
            y = y < -32767 ? -32767 : (y > 32767 ? 32767 : y);
            wave[idx++] = y & 255;
            wave[idx++] = (y >> 8) & 255;
        }
        // Return the WAVE formatted typed array
        return wave;
    };
    // Get n samples of wave data at time t [s]. Wave data in range [-2,2].
    this.getData = function (t, n) {
        var i = 2 * Math.floor(t * 44100);
        var d = new Array(n);
        for (var j = 0; j < 2 * n; j += 1) {
            var k = i + j;
            d[j] = t > 0 && k < mMixBuf.length ? mMixBuf[k] / 32768 : 0;
        }
        return d;
    };
};

;// CONCATENATED MODULE: ./src/engine/tauri.ts
/* eslint-disable @typescript-eslint/no-explicit-any */
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g = Object.create((typeof Iterator === "function" ? Iterator : Object).prototype);
    return g.next = verb(0), g["throw"] = verb(1), g["return"] = verb(2), typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var unlocked = (/* unused pure expression or super */ null && ([]));
var unlockAchievement = function (id) {
    if (unlocked.includes(id))
        return;
    unlocked.push(id);
    if (!isTauri()) {
        if (window.location.href.includes('localhost'))
            console.log('Unlock achievement ' + id);
        return;
    }
    callTauriWith('achievement', { 'id': id });
};
var isTauri = function () {
    return window.__TAURI__;
};
var callTauri = function (fn) {
    window.__TAURI__.core.invoke(fn);
};
var callTauriWith = function (fn, params) {
    window.__TAURI__.core.invoke(fn, params);
};
var tauriFullscreen = function () { return __awaiter(void 0, void 0, void 0, function () {
    var isFull;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                if (!isTauri()) return [3 /*break*/, 3];
                return [4 /*yield*/, window.__TAURI__.window.getCurrentWindow().isFullscreen()];
            case 1:
                isFull = _a.sent();
                return [4 /*yield*/, window.__TAURI__.window.getCurrentWindow().setFullscreen(!isFull)];
            case 2:
                _a.sent();
                _a.label = 3;
            case 3: return [2 /*return*/];
        }
    });
}); };
var tauriShowMouse = function (visible) { return __awaiter(void 0, void 0, void 0, function () {
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                document.body.style.cursor = visible ? 'default' : 'none';
                if (!isTauri()) return [3 /*break*/, 2];
                return [4 /*yield*/, window.__TAURI__.window.getCurrentWindow().setCursorVisible(visible)];
            case 1:
                _a.sent();
                _a.label = 2;
            case 2: return [2 /*return*/];
        }
    });
}); };

;// CONCATENATED MODULE: ./src/engine/zzfx.ts
/*

ZzFX - Zuper Zmall Zound Zynth v1.2.0 by Frank Force
https://github.com/KilledByAPixel/ZzFX

ZzFX Features

- Tiny synth engine with 20 controllable parameters.
- Play sounds via code, no need for sound assed files!
- Compatible with most modern web browsers.
- Small code footprint, the micro version is under 1 kilobyte.
- Can produce a huge variety of sound effect types.
- Sounds can be played with a short call. zzfx(...[,,,,.1,,,,9])
- A small bit of randomness appied to sounds when played.
- Use ZZFX.GetNote to get frequencies on a standard diatonic scale.
- Sounds can be saved out as wav files for offline playback.
- No additional libraries or dependencies are required.

*/
/*

  ZzFX MIT License
  
  Copyright (c) 2019 - Frank Force
  
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  
  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.
  
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
  
*/
/*
* Edited by Antti Haavikko 2023,
* Removed some unused parts to save on final file size.
*/

// play a zzfx sound
function zzfx() {
    var parameters = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        parameters[_i] = arguments[_i];
    }
    return ZZFX.play.apply(ZZFX, parameters);
}
// zzfx object with some extra functionalty
var ZZFX = {
    // master volume scale
    volume: .3,
    // sample rate for audio
    sampleRate: 44100,
    // create shared audio context
    x: new AudioContext,
    // play a sound from zzfx paramerters
    play: function () {
        var parameters = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            parameters[_i] = arguments[_i];
        }
        // build samples and start sound
        return this.playSamples(this.buildSamples.apply(this, parameters));
    },
    // play an array of samples
    playSamples: function () {
        var samples = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            samples[_i] = arguments[_i];
        }
        // create buffer and source
        var buffer = this.x.createBuffer(samples.length, samples[0].length, this.sampleRate), source = this.x.createBufferSource();
        samples.map(function (d, i) { return buffer.getChannelData(i).set(d); });
        source.buffer = buffer;
        source.connect(this.x.destination);
        source.start();
        return source;
    },
    // build an array of samples
    buildSamples: function (volume, randomness, frequency, attack, sustain, release, shape, shapeCurve, slide, deltaSlide, pitchJump, pitchJumpTime, repeatTime, noise, modulation, bitCrush, delay, sustainVolume, decay, tremolo) {
        if (volume === void 0) { volume = 1; }
        if (randomness === void 0) { randomness = .05; }
        if (frequency === void 0) { frequency = 220; }
        if (attack === void 0) { attack = 0; }
        if (sustain === void 0) { sustain = 0; }
        if (release === void 0) { release = .1; }
        if (shape === void 0) { shape = 0; }
        if (shapeCurve === void 0) { shapeCurve = 1; }
        if (slide === void 0) { slide = 0; }
        if (deltaSlide === void 0) { deltaSlide = 0; }
        if (pitchJump === void 0) { pitchJump = 0; }
        if (pitchJumpTime === void 0) { pitchJumpTime = 0; }
        if (repeatTime === void 0) { repeatTime = 0; }
        if (noise === void 0) { noise = 0; }
        if (modulation === void 0) { modulation = 0; }
        if (bitCrush === void 0) { bitCrush = 0; }
        if (delay === void 0) { delay = 0; }
        if (sustainVolume === void 0) { sustainVolume = 1; }
        if (decay === void 0) { decay = 0; }
        if (tremolo === void 0) { tremolo = 0; }
        // init parameters
        var PI2 = Math.PI * 2, sampleRate = this.sampleRate, sign = function (v) { return v > 0 ? 1 : -1; }, startSlide = slide *= 500 * PI2 / sampleRate / sampleRate, startFrequency = frequency *= (1 + randomness * 2 * Math.random() - randomness) * PI2 / sampleRate, b = [], t = 0, tm = 0, i = 0, j = 1, r = 0, c = 0, s = 0, f, length;
        // scale by sample rate
        attack = attack * sampleRate + 9; // minimum attack to prevent pop
        decay *= sampleRate;
        sustain *= sampleRate;
        release *= sampleRate;
        delay *= sampleRate;
        deltaSlide *= 500 * PI2 / Math.pow(sampleRate, 3);
        modulation *= PI2 / sampleRate;
        pitchJump *= PI2 / sampleRate;
        pitchJumpTime *= sampleRate;
        repeatTime = repeatTime * sampleRate | 0;
        // generate waveform
        for (length = attack + decay + sustain + release + delay | 0; i < length; b[i++] = s) {
            if (!(++c % (bitCrush * 100 | 0))) // bit crush
             {
                s = shape ? shape > 1 ? shape > 2 ? shape > 3 ? // wave shape
                    Math.sin(Math.pow((t % PI2), 3)) : // 4 noise
                    Math.max(Math.min(Math.tan(t), 1), -1) : // 3 tan
                    1 - (2 * t / PI2 % 2 + 2) % 2 : // 2 saw
                    1 - 4 * Math.abs(Math.round(t / PI2) - t / PI2) : // 1 triangle
                    Math.sin(t); // 0 sin
                s = (repeatTime ?
                    1 - tremolo + tremolo * Math.sin(PI2 * i / repeatTime) // tremolo
                    : 1) *
                    sign(s) * (Math.pow(Math.abs(s), shapeCurve)) * // curve 0=square, 2=pointy
                    volume * this.volume * ( // envelope
                i < attack ? i / attack : // attack
                    i < attack + decay ? // decay
                        1 - ((i - attack) / decay) * (1 - sustainVolume) : // decay falloff
                        i < attack + decay + sustain ? // sustain
                            sustainVolume : // sustain volume
                            i < length - delay ? // release
                                (length - i - delay) / release * // release falloff
                                    sustainVolume : // release volume
                                0); // post release
                s = delay ? s / 2 + (delay > i ? 0 : // delay
                    (i < length - delay ? 1 : (length - i) / delay) * // release delay 
                        b[i - delay | 0] / 2) : s; // sample delay
            }
            f = (frequency += slide += deltaSlide) * // frequency
                Math.cos(modulation * tm++); // modulation
            t += f - f * noise * (1 - (Math.sin(i) + 1) * 1e9 % 2); // noise
            if (j && ++j > pitchJumpTime) // pitch jump
             {
                frequency += pitchJump; // apply pitch jump
                startFrequency += pitchJump; // also apply to start
                j = 0; // stop pitch jump time
            }
            if (repeatTime && !(++r % repeatTime)) // repeat
             {
                frequency = startFrequency; // reset frequency
                slide = startSlide; // reset slide
                j || (j = 1); // reset pitch jump time
            }
        }
        return b;
    },
    // get frequency of a musical note on a diatonic scale
    // getNote: function(semitoneOffset=0, rootNoteFrequency=440)
    // {
    //     return rootNoteFrequency * 2**(semitoneOffset/12);
    // }
}; // ZZFX

;// CONCATENATED MODULE: ./src/engine/audio.ts
/* eslint-disable no-sparse-arrays */




var AudioManager = /** @class */ (function () {
    function AudioManager(muted, music, sounds) {
        this.started = false;
        this.musicVolume = 1;
        this.soundVolume = 1;
        this.audio = document.createElement('audio');
        if (muted)
            this.toggleMute();
        if (music)
            this.toggleMusic();
        if (sounds)
            this.toggleSounds();
        document.body.appendChild(this.audio);
        this.updateVolumes();
    }
    AudioManager.prototype.updateVolumes = function () {
        var _a, _b;
        this.musicVolume = parseFloat((_a = localStorage.getItem('CoupAhooMusicVol')) !== null && _a !== void 0 ? _a : '0.5');
        this.soundVolume = parseFloat((_b = localStorage.getItem('CoupAhooSoundVol')) !== null && _b !== void 0 ? _b : '0.5');
        this.setVolume();
    };
    AudioManager.prototype.prepare = function () {
        var _this = this;
        if (this.started || isTauri())
            return;
        this.started = true;
        if (!song)
            return;
        var player = new CPlayer();
        player.init(song);
        player.generate();
        this.loaded = false;
        var timer = setInterval(function () {
            if (_this.loaded)
                return;
            _this.loaded = player.generate() >= 1;
            if (_this.loaded) {
                var wave = player.createWave();
                _this.audio.src = URL.createObjectURL(new Blob([wave], { type: 'audio/wav' }));
                _this.audio.loop = true;
                _this.setVolume();
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                _this.audio.preservesPitch = false;
                clearInterval(timer);
            }
        }, 5);
    };
    AudioManager.prototype.setVolume = function () {
        this.audio.volume = this.getBaseMusicVolume() * (this.musicDimmed ? 0.5 : 1) * this.musicVolume;
    };
    AudioManager.prototype.getPitch = function () {
        return this.audio.playbackRate;
    };
    AudioManager.prototype.setPitch = function (target) {
        if (isTauri()) {
            callTauriWith('set_pitch', { pitch: target });
            return;
        }
        if (target < 0.1) {
            this.audio.volume = 0;
            return;
        }
        this.audio.playbackRate = target;
    };
    AudioManager.prototype.isMuted = function () {
        return this.muted;
    };
    AudioManager.prototype.toggleMuteTo = function (state) {
        this.muted = state;
        if (this.muted) {
            localStorage.setItem('CoupAhooMute', '1');
            this.audio.pause();
            return;
        }
        localStorage.removeItem('CoupAhooMute');
        if (!this.music)
            this.audio.play();
    };
    AudioManager.prototype.toggleMusicTo = function (state) {
        this.music = state;
        if (this.music) {
            localStorage.setItem('CoupAhooMusic', '1');
            this.audio.pause();
            return;
        }
        localStorage.removeItem('CoupAhooMusic');
        if (!this.muted)
            this.audio.play();
    };
    AudioManager.prototype.toggleSoundsTo = function (state) {
        this.sounds = state;
        if (this.sounds) {
            localStorage.setItem('CoupAhooSounds', '1');
            return;
        }
        localStorage.removeItem('CoupAhooSounds');
    };
    AudioManager.prototype.toggleMute = function () {
        this.toggleMuteTo(!this.muted);
        if (isTauri()) {
            this.setTauriVolume();
            return;
        }
        this.setVolume();
    };
    AudioManager.prototype.toggleMusic = function () {
        this.toggleMusicTo(!this.music);
        if (isTauri()) {
            this.setTauriVolume();
            return;
        }
        this.setVolume();
    };
    AudioManager.prototype.getEitherMute = function () {
        return this.sounds && this.music;
    };
    AudioManager.prototype.toggleSounds = function () {
        this.toggleSoundsTo(!this.sounds);
    };
    AudioManager.prototype.setTauriVolume = function () {
        if (isTauri()) {
            callTauriWith('set_volume', { volume: this.getBaseMusicVolume() * this.musicVolume });
        }
    };
    AudioManager.prototype.getBaseMusicVolume = function () {
        return !this.muted && !this.music ? 0.7 : 0;
    };
    AudioManager.prototype.dimMusic = function (state) {
        if (this.muted || this.music)
            return;
        this.setPitch(state ? 0.95 : 1);
        this.musicDimmed = state;
        if (isTauri()) {
            this.setTauriVolume();
            return;
        }
        this.setVolume();
    };
    AudioManager.prototype.startMusic = function () {
        var _this = this;
        if (isTauri()) {
            callTauri('play_music');
            this.setTauriVolume();
            return;
        }
        var timer = setInterval(function () {
            if (!_this.loaded)
                return;
            if (!_this.muted && !_this.music)
                _this.audio.play();
            clearInterval(timer);
        }, 5);
        // restart early for better looping
        // this.audio.addEventListener('timeupdate', () => {
        //     if(this.audio.currentTime > this.audio.duration - 0.21) {
        //         this.audio.currentTime = 0;
        //         this.audio.play();
        //     }
        // });
    };
    AudioManager.prototype.play = function (values, name, volume) {
        var _this = this;
        if (name === void 0) { name = 'button'; }
        if (volume === void 0) { volume = 1; }
        if (this.muted || this.sounds)
            return;
        if (isTauri()) {
            callTauriWith('play_sound', { 'effect': name, volume: 0.6 * volume * this.soundVolume });
            return;
        }
        zzfx.apply(void 0, values.map(function (v, i) { return i === 0 ? (v !== null && v !== void 0 ? v : 1) * 0.6 * _this.soundVolume : v; }));
    };
    AudioManager.prototype.button = function () {
        // this.play([2.5,,321,.01,,.02,,.7,-62,-30,116,.15,,.6,35,,.04,.51,.03,,99]);
        this.play([1, , 9, .01, .01, .01, , 2.6, -17, , 214, .01, , , , , , .72, .01, , -1386]);
    };
    AudioManager.prototype.buttonHover = function () {
    };
    AudioManager.prototype.select = function () {
    };
    AudioManager.prototype.jump = function () {
        this.play([1.3, , 298, .02, .03, .05, , 2.3, 8, -29, , , , , , , .01, .83, .07]);
        this.play([.5, , 678, , .01, .17, , 2.1, -1, , , , , .1, 40, , , .78, .03, , 387]);
    };
    AudioManager.prototype.dig = function () {
        this.play([1.5, , 633, .01, .01, .04, 4, 4.2, , , 141, , , , 12, , .01, .84, .01, .15]);
        // [.8,,498,.02,.04,.24,4,.7,,,,,.01,.6,,.5,,.69,.02,.06,1399]
    };
    AudioManager.prototype.land = function (vol) {
        this.play([vol * 0.1, , 33, .01, .03, .01, 4, 3.6, -34, 2, , , , , , , .43, .53, .03, .06, 171]);
    };
    AudioManager.prototype.miss = function () {
        this.play([1.6, , 472, .01, .02, .22, 2, 2.2, , , , , .03, .8, 1.8, , .16, .47, , .32, -1767]);
    };
    AudioManager.prototype.loosen = function () {
        this.play([.9, , 409, , .04, .06, , .9, , 2, 210, .08, .02, , , .1, , .5, .02, , -1495]);
    };
    AudioManager.prototype.gem = function () {
        this.play([1.3, , 615, .01, .07, .09, , 1.1, , , 273, .05, , , , , .05, .98, .02]);
    };
    AudioManager.prototype.build = function () {
        this.play([3.5, , 913, , .01, .03, 1, 4.2, -22, 23, -43, .01, , , 2.5, .4, .2, .6, .02, , 375]);
    };
    AudioManager.prototype.fail = function () {
        this.play([1.3, , 449, .02, .05, .16, 1, 1.7, , , 352, .07, .08, , 30, .1, .04, .85, .02, , -1498]);
    };
    AudioManager.prototype.step = function (left) {
        if (left) {
            this.play([0.2, , 210, .02, .04, .04, 3, 2.3, 21, , , , .17, .4, , .1, .33, .61, .02, .4, -1437]);
            return;
        }
        this.play([.2, , 217, , .01, .02, , 1.8, -37, , -93, , , , , , , .56, .03, , 103]);
    };
    AudioManager.prototype.teleport = function () {
        this.play([.9, , 514, .07, .28, .44, 1, 2.8, , 37, , , .09, .5, , , , .93, .14, .04, -1331]);
    };
    AudioManager.prototype.die = function () {
        this.play([, , 95, .02, .24, .34, 1, 3.5, -9, , , , , .1, 41, .2, , .35, .15, .47, -3344]);
        this.play([2.2, , 48, , .01, .56, 4, 3.1, 7, , , , .1, .6, , .9, .43, .49, .18, .05]);
    };
    AudioManager.prototype.enter = function () {
        this.play([.5, , 189, , .27, .26, , .9, 3, 2, , , .07, .4, , , , .77, .16, .19, 112]);
    };
    AudioManager.prototype.station = function () {
        this.play([1.4, , 113, .03, .29, .14, 1, .8, , , 124, .08, .02, , , , .14, .92, .11, .17]);
    };
    AudioManager.prototype.shutDown = function () {
        // this.play([2.1,,298,,.1,.12,1,1.5,-7,2,,,.04,,4.3,,,.58,.24,.4,352]);
        this.play([0.5, , 585, .07, .14, .06, 1, 3.5, , , -55, .09, .05, , , .1, , .52, .15, .46]);
    };
    AudioManager.prototype.craft = function () {
        this.play([2.1, , 577, .03, .26, .07, , 3.3, , -191, 232, .08, .09, , , , .19, .5, .28, .41]);
    };
    AudioManager.prototype.noMaterials = function () {
        this.play([0.8, , 387, .1, .13, .06, , 3.1, , , -142, .08, .03, .4, , , , .53, .14]);
    };
    AudioManager.prototype.jetpack = function () {
        this.play([3, , 264, .02, .17, .09, 1, 1.3, -12, -15, , , .09, , , .1, .17, .54, .16, .28]);
    };
    AudioManager.prototype.prompt = function () {
        this.play([.2, , 22, .02, .01, .04, , .7, -28, -56, , , , , , .1, , .63, .03, , -1010]);
    };
    AudioManager.prototype.detatch = function () {
        this.play([0.6, , 571, .02, .09, .08, , 1.2, 5, , , , , .3, , , , .53, .03]);
    };
    AudioManager.prototype.switch = function () {
        this.play([0.6, , 146, , , .03, , 1.6, , , -2, .11, , .1, , , , .83, .02]);
    };
    AudioManager.prototype.talk = function () {
        this.play([7, , 59, .02, .01, .03, 3, 4.4, 1, -73, -2, .03, .01, .3, 118, , , .61, .03, .28, -534]);
        this.play([.9, , 164, .04, .07, .14, 1, 1.7, , 18, , , , .1, , .1, , .88, .05, , -767]);
    };
    return AudioManager;
}());


;// CONCATENATED MODULE: ./src/engine/math.ts
var clamp = function (num, min, max) {
    return Math.min(Math.max(num, min), max);
};
var clamp01 = function (num) {
    return clamp(num, 0, 1);
};
var moveTowards = function (num, target, max) {
    return num + (target > num ? Math.min((target - num), max) : Math.max((target - num), -max));
};
var lerp = function (a, b, alpha, ease) {
    if (ease === void 0) { ease = function (v) { return v; }; }
    return a + ease(alpha) * (b - a);
};
var asScore = function (value) {
    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
};
var asScoreWithSuffix = function (value, limit) {
    var text = asScore(value);
    if (text.length <= limit)
        return text;
    // if (text.length > 29) return text.substring(0, text.length - 28) + ' Z';
    // if (text.length > 25) return text.substring(0, text.length - 24) + ' E';
    if (text.length > 21)
        return asScore(Math.floor(value / 1000000000000000)) + ' P';
    if (text.length > 17)
        return text.substring(0, text.length - 16) + ' T';
    if (text.length > 13)
        return text.substring(0, text.length - 12) + ' G';
    if (text.length > 9)
        return text.substring(0, text.length - 8) + ' M';
    if (text.length > 5)
        return text.substring(0, text.length - 4) + ' k';
    return text;
};
var numbersAsText = (/* unused pure expression or super */ null && (['zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen', 'twenty', 'twenty-one', 'twenty-two', 'twenty-three', 'twenty-four', 'twenty-five']));
var numbersAsTextWithArticle = (/* unused pure expression or super */ null && (['a zero', 'a one', 'a two', 'a three', 'a four', 'a five', 'a six', 'a seven', 'an eight', 'a nine', 'a ten']));

;// CONCATENATED MODULE: ./src/engine/vector.ts
var ZERO = { x: 0, y: 0 };
var normalize = function (v, multi) {
    if (multi === void 0) { multi = 1; }
    var m = magnitude(v);
    if (m == 0)
        return ZERO;
    return { x: v.x / m * multi, y: v.y / m * multi };
};
var distance = function (a, b) {
    var dx = Math.abs(a.x - b.x);
    var dy = Math.abs(a.y - b.y);
    return Math.sqrt(dx * dx + dy * dy);
};
var dot = function (a, b) {
    // const al = magnitude(a);
    // const bl = magnitude(b);
    return a.x * b.x + a.y * b.y;
};
var magnitude = function (v) {
    return Math.sqrt(v.x * v.x + v.y * v.y);
};
var vector_lerp = function (a, b, t, ease) {
    if (ease === void 0) { ease = function (v) { return v; }; }
    return {
        x: a.x + ease(t) * (b.x - a.x),
        y: a.y + ease(t) * (b.y - a.y)
    };
};
var offset = function (v, x, y) {
    return {
        x: v.x + x,
        y: v.y + y
    };
};
var randomVector = function (length) {
    return {
        x: -length + 2 * length * Math.random(),
        y: -length + 2 * length * Math.random()
    };
};

;// CONCATENATED MODULE: ./src/engine/easings.ts
var quadEaseIn = function (p) { return p * p; };
var quadEaseOut = function (p) { return -(p * (p - 2)); };
var quadEaseInOut = function (p) { return p < 0.5 ? (2 * p * p) : (-2 * p * p) + (4 * p) - 1; };
var bounce = function (p) {
    if (p < 4 / 11) {
        return (121 * p * p) / 16;
    }
    else if (p < 8 / 11) {
        return (363 / 40 * p * p) - (99 / 10 * p) + 17 / 5;
    }
    else if (p < 9 / 10) {
        return (4356 / 361 * p * p) - (35442 / 1805 * p) + 16061 / 1805;
    }
    else {
        return (54 / 5 * p * p) - (513 / 25 * p) + 268 / 25;
    }
};

;// CONCATENATED MODULE: ./src/engine/tween.ts



var Tween = /** @class */ (function () {
    function Tween(entity) {
        this.entity = entity;
        this.time = 0;
        this.type = 'none';
        this.easeFn = function (val) { return bounce(val); };
    }
    Tween.prototype.isActive = function () {
        return this.active;
    };
    Tween.prototype.scale = function (target, duration) {
        this.type = 'scale';
        var p = this.entity.scale;
        this.start = { x: p.x, y: p.y };
        this.startTween(target, duration);
    };
    Tween.prototype.move = function (target, duration) {
        this.type = 'move';
        var p = this.entity.p;
        this.start = { x: p.x, y: p.y };
        this.startTween(target, duration);
    };
    Tween.prototype.rotate = function (target, duration) {
        this.type = 'rotate';
        var rot = this.entity.rotation;
        this.start = { x: rot, y: rot };
        this.startTween({ x: target, y: target }, duration);
    };
    Tween.prototype.setEase = function (ease) {
        this.easeFn = ease;
    };
    Tween.prototype.startTween = function (target, duration) {
        this.target = target;
        this.duration = duration * 1000;
        this.active = true;
        this.startTime = -1;
    };
    Tween.prototype.stop = function () {
        this.type == 'none';
        this.active = false;
    };
    Tween.prototype.update = function (tick) {
        if (this.startTime < 0 || this.type == 'none') {
            this.startTime = tick;
            return;
        }
        if (!this.active)
            return;
        this.time = clamp01((tick - this.startTime) / this.duration);
        if (!this.start || !this.target)
            return;
        var p = vector_lerp(this.start, this.target, this.time, this.easeFn);
        if (this.type == 'move')
            this.entity.p = { x: p.x, y: p.y };
        if (this.type == 'scale')
            this.entity.scale = { x: p.x, y: p.y };
        if (this.type == 'rotate')
            this.entity.rotation = p.x;
        this.active = this.time < 1;
    };
    Tween.run = function (fn, duration) {
        if (duration === void 0) { duration = 1000; }
        var _loop_1 = function (i) {
            setTimeout(function () { return fn(i); }, i * duration);
        };
        for (var i = 0; i < 1; i += 0.01) {
            _loop_1(i);
        }
    };
    return Tween;
}());


;// CONCATENATED MODULE: ./src/engine/entity.ts

var Entity = /** @class */ (function () {
    function Entity(game, x, y, width, height) {
        this.game = game;
        this.scale = { x: 1, y: 1 };
        this.d = 0;
        this.rotation = 0;
        this.animationOffset = 0;
        this.previousTick = 0;
        this.animationPhase = 0;
        this.animationPhaseAbs = 0;
        this.animationSpeed = 0.005;
        this.delta = 0;
        this.p = { x: x, y: y };
        this.s = { x: width, y: height };
        this.tween = new Tween(this);
        this.animationOffset = Math.random();
    }
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Entity.prototype.update = function (tick, mouse) {
        this.delta = tick - this.previousTick;
        this.previousTick = tick;
        this.tween.update(tick);
        this.animationPhase = Math.sin(tick * this.animationSpeed + this.animationOffset);
        this.animationPhaseAbs = Math.abs(this.animationPhase);
    };
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Entity.prototype.draw = function (ctx) {
    };
    Entity.prototype.getCenter = function () {
        return {
            x: this.p.x + this.s.x * 0.5,
            y: this.p.y + this.s.y * 0.5
        };
    };
    Entity.prototype.setPosition = function (x, y) {
        this.p = { x: x, y: y };
    };
    Entity.prototype.isInside = function (point, radius) {
        if (radius === void 0) { radius = 0; }
        var c = this.getCenter();
        return point.x > c.x - this.s.x * 0.5 * this.scale.x - radius * 0.5 &&
            point.x < c.x + this.s.x * 0.5 * this.scale.x + radius * 0.5 &&
            point.y > c.y - this.s.y * 0.5 * this.scale.y - radius * 0.5 &&
            point.y < c.y + this.s.y * 0.5 * this.scale.y + radius * 0.5;
    };
    Entity.prototype.drawWithTranslate = function (ctx) {
        ctx.save();
        ctx.translate(this.p.x, this.p.y);
        this.draw(ctx);
        ctx.restore();
    };
    return Entity;
}());

var sortByDepth = function (a, b) { return a.d - b.d; };

;// CONCATENATED MODULE: ./src/engine/blinders.ts
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var Blinders = /** @class */ (function (_super) {
    __extends(Blinders, _super);
    function Blinders(game, delay) {
        if (delay === void 0) { delay = 0; }
        var _this = _super.call(this, game, 0, 0, 0, 0) || this;
        _this.d = 500;
        setTimeout(function () { return _this.open(); }, delay);
        return _this;
    }
    Blinders.prototype.open = function (after) {
        if (after === void 0) { after = function () { }; }
        this.tween.scale({ x: 0, y: 0 }, 0.5);
        setTimeout(after, 500);
    };
    Blinders.prototype.close = function (after) {
        if (after === void 0) { after = function () { }; }
        this.tween.scale({ x: 1, y: 1 }, 0.4);
        setTimeout(after, 500);
    };
    Blinders.prototype.draw = function (ctx) {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, WIDTH * 0.55 * this.scale.x, HEIGHT);
        ctx.fillRect(WIDTH - WIDTH * 0.55 * this.scale.x, 0, WIDTH * this.scale.x, HEIGHT);
    };
    return Blinders;
}(Entity));


;// CONCATENATED MODULE: ./src/engine/random.ts
var random = function (min, max) {
    if (min === void 0) { min = 0; }
    if (max === void 0) { max = 1; }
    return min + Math.random() * (max - min);
};
var randomInt = function (min, max) {
    return min + Math.floor(Math.random() * (max - min + 1));
};
var randomChance = function () {
    return Math.random() < 0.5;
};
var randomCell = function (arr) {
    return arr[Math.floor(Math.random() * arr.length)];
};
var randomSorter = function () { return Math.random() < 0.5 ? 1 : -1; };
var plusMinus = (/* unused pure expression or super */ null && (randomSorter));
var randomWeighted = function (arr, weighter) {
    var sum = arr.reduce(function (tot, a) { return tot + weighter(a); }, 0);
    var roll = Math.random() * sum;
    var acc = 0;
    return arr.find(function (a) {
        acc += weighter(a);
        return roll < acc;
    });
};

;// CONCATENATED MODULE: ./src/engine/camera.ts


var Camera = /** @class */ (function () {
    function Camera() {
        this.offset = ZERO;
        this.pan = ZERO;
        this.shift = 0;
        this.shakeStrength = 0;
        this.shakeRotation = 0;
    }
    Camera.prototype.shake = function (amount, duration, rotation) {
        var _this = this;
        if (rotation === void 0) { rotation = 0; }
        this.shakeStrength = amount;
        this.shakeRotation = rotation / 360 * Math.PI;
        clearTimeout(this.timer);
        this.timer = setTimeout(function () { return _this.reset(); }, duration * 1000);
    };
    Camera.prototype.update = function () {
        this.offset = {
            x: random(-this.shakeStrength, this.shakeStrength),
            y: random(-this.shakeStrength, this.shakeStrength)
        };
        this.rotation = random(-this.shakeRotation, this.shakeRotation);
    };
    Camera.prototype.reset = function () {
        this.shakeStrength = 0;
        this.shakeRotation = 0;
    };
    return Camera;
}());


;// CONCATENATED MODULE: ./src/engine/pitcher.ts
var Pitcher = /** @class */ (function () {
    function Pitcher(audio) {
        this.audio = audio;
        this.value = this.target = this.audio.getPitch();
        var ua = navigator.userAgent.toLowerCase();
        this.disabled = ['iphone', 'ipad'].some(function (s) { return ua.includes(s); }) ||
            ua.includes('macintosh') && navigator.maxTouchPoints > 0;
    }
    Pitcher.prototype.update = function (delta) {
        if (this.disabled)
            return;
        var diff = this.target - this.value;
        if (Math.abs(diff) < 0.01)
            return;
        this.value += Math.sign(diff) * 0.0001 * delta * this.speed;
        this.audio.setPitch(this.value);
    };
    Pitcher.prototype.pitchFrom = function (to, speed) {
        if (speed === void 0) { speed = 1; }
        this.speed = speed;
        this.value = to;
    };
    Pitcher.prototype.pitchTo = function (t, speed) {
        if (speed === void 0) { speed = 1; }
        this.speed = speed;
        this.target = t;
    };
    return Pitcher;
}());


;// CONCATENATED MODULE: ./src/engine/game.ts
var game_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};




var Game = /** @class */ (function (_super) {
    game_extends(Game, _super);
    function Game(audio, canvas) {
        var _this = _super.call(this, null, 0, 0, 0, 0) || this;
        _this.audio = audio;
        _this.canvas = canvas;
        _this.camera = new Camera();
        _this.keyDownListeners = [];
        _this.keyUpListeners = [];
        _this.pitcher = new Pitcher(audio);
        _this.blinders = new Blinders(_this, 400);
        return _this;
    }
    Game.prototype.click = function (mouse, right) {
        var _a;
        this.usingPad = false;
        (_a = this.scene) === null || _a === void 0 ? void 0 : _a.getButtons().forEach(function (b) {
            if (b.visible && b.isInside(mouse))
                b.trigger(right);
        });
    };
    Game.prototype.onKeyDown = function (callback) {
        this.keyDownListeners.push(callback);
    };
    Game.prototype.onKeyUp = function (callback) {
        this.keyUpListeners.push(callback);
    };
    Game.prototype.clearKeyListeners = function () {
        this.keyDownListeners = [];
        this.keyUpListeners = [];
    };
    Game.prototype.pressed = function (event) {
        if (event.repeat)
            return;
        this.keyDownListeners.forEach(function (k) { return k(event); });
    };
    Game.prototype.released = function (event) {
        this.keyUpListeners.forEach(function (k) { return k(event); });
    };
    Game.prototype.getMouse = function () {
        return this.curMouse;
    };
    Game.prototype.update = function (tick, mouse) {
        var _a;
        _super.prototype.update.call(this, tick, mouse);
        (_a = this.scene) === null || _a === void 0 ? void 0 : _a.update(tick, mouse);
        this.camera.update();
        this.blinders.update(tick, mouse);
        this.pitcher.update(this.delta);
        mouse.pressing = false;
        this.curMouse = __assign({}, mouse);
    };
    Game.prototype.draw = function (ctx) {
        var _a, _b;
        ctx.fillStyle = (_a = this.scene) === null || _a === void 0 ? void 0 : _a.getBgColor();
        ctx.fillRect(0, 0, 800, 600);
        ctx.save();
        ctx.rotate(this.camera.rotation);
        ctx.scale(this.camera.zoom, this.camera.zoom);
        ctx.translate(this.camera.offset.x - this.camera.pan.x + this.camera.shift, this.camera.offset.y + this.camera.pan.y);
        (_b = this.scene) === null || _b === void 0 ? void 0 : _b.draw(ctx);
        ctx.restore();
        // this.blinders.draw(ctx);
    };
    Game.prototype.changeScene = function (scene) {
        var _this = this;
        this.blinders.close(function () {
            _this.scene = scene;
            _this.blinders.open();
        });
    };
    Game.prototype.getBlinders = function () {
        return this.blinders;
    };
    return Game;
}(Entity));


;// CONCATENATED MODULE: ./src/engine/constants.ts
var font = 'Saira Condensed,Arial Black,HelveticaNeue-CondensedBlack,arial,sans-serif';
var altFont = 'Matemasie,Arial Black,HelveticaNeue-CondensedBlack,arial,sans-serif';

;// CONCATENATED MODULE: ./src/engine/particle.ts
var particle_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var Particle = /** @class */ (function (_super) {
    particle_extends(Particle, _super);
    function Particle(game, x, y, width, height, life, velocity) {
        var _this = _super.call(this, game, x, y, width, height) || this;
        _this.life = life;
        _this.velocity = velocity;
        _this.ratio = 1;
        _this.start = -1;
        return _this;
    }
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Particle.prototype.update = function (tick, mouse) {
        if (this.dead || this.life < 0)
            return;
        this.p = {
            x: this.p.x + this.velocity.x,
            y: this.p.y + this.velocity.y
        };
        this.ratio = 1 - (tick - this.start) / (this.life * 1000);
        if (this.start < 0)
            this.start = tick;
        if (tick - this.start > this.life * 1000) {
            this.dead = true;
        }
    };
    return Particle;
}(Entity));


;// CONCATENATED MODULE: ./src/engine/text.ts
var text_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var TextEntity = /** @class */ (function (_super) {
    text_extends(TextEntity, _super);
    function TextEntity(game, content, fontSize, x, y, life, velocity, options) {
        var _this = _super.call(this, game, x, y, 0, 0, life, velocity) || this;
        _this.content = content;
        _this.fontSize = fontSize;
        _this.options = options;
        return _this;
    }
    TextEntity.prototype.draw = function (ctx) {
        var _a, _b, _c, _d, _e, _f, _g, _h;
        ctx.save();
        ctx.rotate((_b = (_a = this.options) === null || _a === void 0 ? void 0 : _a.angle) !== null && _b !== void 0 ? _b : 0);
        var mod = ((_c = this.options) === null || _c === void 0 ? void 0 : _c.scales) ? this.ratio : 1;
        ctx.font = "".concat(this.fontSize * mod, "px ").concat(font);
        ctx.textAlign = (_e = (_d = this.options) === null || _d === void 0 ? void 0 : _d.align) !== null && _e !== void 0 ? _e : 'center';
        if ((_f = this.options) === null || _f === void 0 ? void 0 : _f.shadow) {
            ctx.fillStyle = '#000';
            ctx.fillText(this.content, this.p.x + this.options.shadow, this.p.y + this.options.shadow);
        }
        ctx.fillStyle = (_h = (_g = this.options) === null || _g === void 0 ? void 0 : _g.color) !== null && _h !== void 0 ? _h : '#fff';
        ctx.fillText(this.content, this.p.x, this.p.y);
        ctx.restore();
    };
    // public setColor(color: string): void {
    //     this.options.color = color;
    // }
    TextEntity.prototype.getWidth = function (ctx) {
        var _a;
        var mod = ((_a = this.options) === null || _a === void 0 ? void 0 : _a.scales) ? this.ratio : 1;
        ctx.font = "".concat(this.fontSize * mod, "px ").concat(font);
        return Math.max.apply(Math, this.content.split('\n').map(function (t) { return ctx.measureText(t).width; }));
    };
    return TextEntity;
}(Particle));


;// CONCATENATED MODULE: ./src/engine/multiline-text.ts
var multiline_text_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var MultilineTextEntity = /** @class */ (function (_super) {
    multiline_text_extends(MultilineTextEntity, _super);
    function MultilineTextEntity() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    MultilineTextEntity.prototype.draw = function (ctx) {
        var _this = this;
        var _a, _b, _c, _d, _e;
        ctx.save();
        ctx.rotate((_b = (_a = this.options) === null || _a === void 0 ? void 0 : _a.angle) !== null && _b !== void 0 ? _b : 0);
        var mod = ((_c = this.options) === null || _c === void 0 ? void 0 : _c.scales) ? this.ratio : 1;
        ctx.font = "".concat(this.fontSize * mod, "px ").concat(font);
        ctx.textAlign = (_e = (_d = this.options) === null || _d === void 0 ? void 0 : _d.align) !== null && _e !== void 0 ? _e : 'center';
        var lineHeight = this.fontSize * 1.25;
        var lines = this.content.split('\n');
        lines.forEach(function (line, row) {
            var _a, _b, _c;
            var offset = +row * lineHeight - (lines.length - 1) * lineHeight;
            if ((_a = _this.options) === null || _a === void 0 ? void 0 : _a.shadow) {
                ctx.fillStyle = '#000';
                ctx.fillText(line.replace(/\|/g, ''), _this.p.x + _this.options.shadow, _this.p.y + _this.options.shadow + offset);
            }
            ctx.fillStyle = (_c = (_b = _this.options) === null || _b === void 0 ? void 0 : _b.color) !== null && _c !== void 0 ? _c : '#fff';
            ctx.fillText(line, _this.p.x, _this.p.y + offset);
        });
        ctx.restore();
    };
    MultilineTextEntity.prototype.getHeight = function () {
        var _a;
        return (((_a = this.content.match(/\n/g)) !== null && _a !== void 0 ? _a : []).length + 1) * this.fontSize * 1.25;
    };
    return MultilineTextEntity;
}(TextEntity));


;// CONCATENATED MODULE: ./src/engine/bubble.ts
var bubble_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var bubble_assign = (undefined && undefined.__assign) || function () {
    bubble_assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return bubble_assign.apply(this, arguments);
};




var Bubble = /** @class */ (function (_super) {
    bubble_extends(Bubble, _super);
    function Bubble(game, content, x, y, options) {
        if (options === void 0) { options = {}; }
        var _this = _super.call(this, game, x, y, 0, 0) || this;
        _this.d = -50;
        _this.options = bubble_assign({ color: '#000', bgColor: '#fff', lineWidth: 4, centerThreshold: 100, sound: function () { } }, options);
        _this.text = new MultilineTextEntity(game, content, 15, 0, 0, -1, ZERO, { color: _this.options.color, align: 'left' });
        _this.text.content = '';
        _this.messagePos = 0;
        _this.message = content;
        _this.animationSpeed = 0.004;
        return _this;
    }
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Bubble.prototype.update = function (tick, mouse) {
        _super.prototype.update.call(this, tick, mouse);
        if (this.messagePos < this.message.length && Math.random() < 0.03 * this.delta) {
            this.messagePos++;
            this.text.content = this.message.substring(0, this.messagePos);
            var cur = this.message.substring(this.messagePos, this.messagePos + 1);
            if ([' ', '!', '.', '?', '<'].includes(cur) || this.messagePos == 1) {
                this.options.sound();
                if (this.onWord)
                    this.onWord();
            }
        }
        if (this.messagePos === this.message.length - 1) {
            if (this.onDone)
                this.onDone();
        }
    };
    Bubble.prototype.changeDirection = function (direction) {
        this.options.direction = direction;
    };
    Bubble.prototype.getOffset = function (direction, width) {
        switch (direction) {
            case 'left':
                return width - 20;
            case 'right':
                return 0;
            case 'center':
                return width * 0.5 - 10;
            default:
                return this.getAutoOffset(width);
        }
    };
    Bubble.prototype.getAutoOffset = function (width) {
        if (this.p.x < WIDTH * 0.5 - this.options.centerThreshold)
            return this.getOffset('right', width);
        if (this.p.x > WIDTH * 0.5 + this.options.centerThreshold)
            return this.getOffset('left', width);
        return this.getOffset('center', width);
    };
    Bubble.prototype.draw = function (ctx) {
        if (!this.text.content)
            return;
        ctx.save();
        var height = this.text.getHeight() + 20;
        var width = Math.max(this.text.getWidth(ctx), 20);
        var offset = this.getOffset(this.options.direction, width);
        ctx.fillStyle = this.options.bgColor;
        ctx.strokeStyle = this.options.color;
        ctx.lineWidth = this.options.lineWidth;
        ctx.beginPath();
        var phase = this.animationPhaseAbs * 6;
        ctx.moveTo(this.p.x, this.p.y - phase);
        ctx.lineTo(this.p.x - 10, this.p.y - 10 - phase);
        ctx.lineTo(this.p.x - 20 - offset, this.p.y - 10 - phase);
        ctx.lineTo(this.p.x - 20 - offset, this.p.y - 10 - height - phase);
        ctx.lineTo(this.p.x + 0 + width - offset, this.p.y - 10 - height - phase);
        ctx.lineTo(this.p.x + 0 + width - offset, this.p.y - 10 - phase);
        ctx.lineTo(this.p.x + 10, this.p.y - 10 - phase);
        ctx.closePath();
        ctx.fill();
        if (this.options.lineWidth > 0)
            ctx.stroke();
        ctx.translate(this.p.x - 10 - offset, this.p.y - 25 - phase);
        this.text.draw(ctx);
        ctx.restore();
    };
    Bubble.prototype.setText = function (content) {
        this.messagePos = 0;
        this.message = content;
        this.text.content = '';
    };
    Bubble.prototype.continueText = function (more) {
        this.message += more;
    };
    Bubble.prototype.setSound = function (sound) {
        this.options.sound = sound;
    };
    return Bubble;
}(Entity));


;// CONCATENATED MODULE: ./src/engine/steam-pad.ts
var keys = [
    [' ', 'Enter'],
    ['e'],
    ['r'],
    ['f'],
    ['WheelDown'],
    ['WheelUp'],
    ['Home'],
    ['End', 'Backspace'],
    ['Tab'],
    ['Escape'],
    ['ls'],
    ['rs'],
    ['1', 'ArrowUp'],
    ['3', 'ArrowDown'],
    ['4', 'ArrowLeft'],
    ['2', 'ArrowRight'],
    ['HomeButton']
];
var SteamPad = /** @class */ (function () {
    function SteamPad() {
        this.keyStates = {};
        this.x = 0;
        this.y = 0;
    }
    SteamPad.prototype.press = function (key) {
        if (key === 'w')
            this.y = -1;
        if (key === 's')
            this.y = 1;
        if (key === 'a')
            this.x = -1;
        if (key === 'd')
            this.x = 1;
        this.keyStates[key] = true;
    };
    SteamPad.prototype.release = function (key) {
        if (key === 'w' || key === 's')
            this.y = 0;
        if (key === 'a' || key === 'd')
            this.x = 0;
        this.keyStates[key] = false;
    };
    SteamPad.prototype.get = function (button) {
        var _this = this;
        return keys[button].some(function (k) { return _this.keyStates[k]; });
    };
    SteamPad.prototype.getAsGamepad = function () {
        var _this = this;
        return {
            buttons: keys.map(function (key) { return ({ pressed: key.some(function (k) { return _this.keyStates[k]; }) }); }),
            axes: [this.x, this.y]
        };
    };
    return SteamPad;
}());


;// CONCATENATED MODULE: ./src/engine/pad.ts
var __spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};

var Pad = /** @class */ (function () {
    function Pad() {
        this.steam = new SteamPad();
        this.current = [];
        this.previous = [];
    }
    Pad.prototype.update = function () {
        this.previous = __spreadArray([], this.current, true);
        this.current = this.mapped().map(function (pad) { return pad === null || pad === void 0 ? void 0 : pad.buttons.map(function (b) { return b.pressed || b.touched; }); });
        // console.log(navigator.getGamepads().length, this.current?.some(v => v?.some(val => val)));
    };
    Pad.prototype.isConnected = function () {
        return this.mapped().some(function (pad) { return pad; });
    };
    Pad.prototype.lock = function () {
        var _this = this;
        this.locked = true;
        setTimeout(function () { return _this.locked = false; }, 100);
    };
    Pad.prototype.isDown = function (index) {
        var _this = this;
        if (this.locked || this.current.length === 0 || this.current.every(function (c) { return !c || c.length === 0; }))
            return false;
        return this.current.some(function (cur, i) { return cur && cur[index] && (!_this.previous[i] || !_this.previous[i][index]); });
    };
    Pad.prototype.getHorizontal = function () {
        var _this = this;
        return this.mapped().reduce(function (sum, pad, i) { return sum + _this.getHorizontalFor(pad, i); }, 0);
    };
    Pad.prototype.getVertical = function () {
        var _this = this;
        return this.mapped().reduce(function (sum, pad, i) { return sum + _this.getVerticalFor(pad, i); }, 0);
    };
    Pad.prototype.mapped = function () {
        return __spreadArray(__spreadArray([], navigator.getGamepads(), true), [
            this.steam.getAsGamepad()
        ], false);
    };
    Pad.prototype.isDownFor = function (pad, index, button) {
        if (!pad || !pad.buttons[button])
            return false;
        return pad.buttons[button].pressed && (!this.previous[index] || !this.previous[index][button]);
    };
    Pad.prototype.getVerticalFor = function (pad, index) {
        var _this = this;
        if (!pad || this.cooldown)
            return 0;
        var total = (this.isDownFor(pad, index, PadButton.DOWN) ? -1 : 0) + (this.isDownFor(pad, index, PadButton.UP) ? 1 : 0) - pad.axes[1];
        if (Math.abs(pad.axes[1]) > 0.5) {
            this.cooldown = true;
            setTimeout(function () { return _this.cooldown = false; }, 250);
        }
        return total;
    };
    Pad.prototype.getHorizontalFor = function (pad, index) {
        var _this = this;
        if (!pad || this.cooldown)
            return 0;
        var total = (this.isDownFor(pad, index, PadButton.LEFT) ? -1 : 0) + (this.isDownFor(pad, index, PadButton.RIGHT) ? 1 : 0) + pad.axes[0];
        if (Math.abs(pad.axes[0]) > 0.5) {
            this.cooldown = true;
            setTimeout(function () { return _this.cooldown = false; }, 250);
        }
        return total;
    };
    return Pad;
}());

var PadButton;
(function (PadButton) {
    PadButton[PadButton["NONE"] = -1] = "NONE";
    PadButton[PadButton["A"] = 0] = "A";
    PadButton[PadButton["B"] = 1] = "B";
    PadButton[PadButton["X"] = 2] = "X";
    PadButton[PadButton["Y"] = 3] = "Y";
    PadButton[PadButton["LB"] = 4] = "LB";
    PadButton[PadButton["RB"] = 5] = "RB";
    PadButton[PadButton["LT"] = 6] = "LT";
    PadButton[PadButton["RT"] = 7] = "RT";
    PadButton[PadButton["SELECT"] = 8] = "SELECT";
    PadButton[PadButton["START"] = 9] = "START";
    PadButton[PadButton["LS"] = 10] = "LS";
    PadButton[PadButton["RS"] = 11] = "RS";
    PadButton[PadButton["UP"] = 12] = "UP";
    PadButton[PadButton["DOWN"] = 13] = "DOWN";
    PadButton[PadButton["LEFT"] = 14] = "LEFT";
    PadButton[PadButton["RIGHT"] = 15] = "RIGHT";
    PadButton[PadButton["HOME"] = 16] = "HOME";
})(PadButton || (PadButton = {}));

;// CONCATENATED MODULE: ./src/engine/drawing.ts
var drawCircle = function (ctx, pos, radius, color, stroke) {
    drawEllipse(ctx, pos, radius, radius, color, stroke);
};
var drawEllipse = function (ctx, pos, x, y, color, stroke) {
    ctx.beginPath();
    if (color)
        ctx.fillStyle = color;
    ctx.ellipse(pos.x, pos.y, x, y, 0, 0, Math.PI * 2);
    ctx.fill();
    if (stroke) {
        ctx.strokeStyle = stroke;
        ctx.stroke();
    }
};
var fillRect = function (ctx, x, y, w, h) {
    ctx.fillRect(x - w * 0.5, y - h * 0.5, w, h);
};
var drawRect = function (ctx, pos, size, fill, stroke) {
    ctx.beginPath();
    ctx.fillStyle = fill;
    ctx.strokeStyle = stroke;
    ctx.rect(pos.x - size.x * 0.5, pos.y - size.y * 0.5, size.x, size.y);
    if (fill)
        ctx.fill();
    if (stroke)
        ctx.stroke();
    ctx.fill();
};
var roundRect = function (ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
};
var drawColoredText = function (ctx, content, x, y, baseColor, colors) {
    var parts = content.split('|');
    var color = false;
    var pos = 0;
    var n = 0;
    parts.forEach(function (part) {
        ctx.fillStyle = color ? colors[n] : baseColor;
        if (color)
            n = (n + 1) % colors.length;
        ctx.fillText(part, x + pos, y);
        color = !color;
        pos += ctx.measureText(part).width;
    });
};
var doubleStroke = function (ctx, width, color, lineWidth, lineColor) {
    if (width === void 0) { width = 5; }
    if (color === void 0) { color = '#fff'; }
    if (lineWidth === void 0) { lineWidth = 5; }
    if (lineColor === void 0) { lineColor = '#000'; }
    ctx.strokeStyle = lineColor;
    ctx.lineWidth = width + 2 * lineWidth;
    ctx.stroke();
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.stroke();
};

;// CONCATENATED MODULE: ./src/engine/button.ts
var button_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var BORDER_THICKNESS = 5;
var ButtonEntity = /** @class */ (function (_super) {
    button_extends(ButtonEntity, _super);
    function ButtonEntity(game, content, x, y, width, height, onClick, audio, fontSize) {
        if (fontSize === void 0) { fontSize = 30; }
        var _this = _super.call(this, game, x - width * 0.5, y - height * 0.5, width, height) || this;
        _this.content = content;
        _this.onClick = onClick;
        _this.audio = audio;
        _this.fontSize = fontSize;
        _this.visible = true;
        _this.button = PadButton.NONE;
        _this.hoverRise = 5;
        _this.clickOffset = { x: 0, y: 0 };
        _this.contentColor = '#000';
        _this.borderThickness = BORDER_THICKNESS;
        return _this;
    }
    ButtonEntity.prototype.setClickOffset = function (offset) {
        this.clickOffset = offset;
    };
    ButtonEntity.prototype.setHoverRise = function (val) {
        this.hoverRise = val;
    };
    ButtonEntity.prototype.trigger = function (right) {
        this.audio.button();
        this.onClick(right);
    };
    ButtonEntity.prototype.makeFrameless = function () {
        this.frameless = true;
    };
    ButtonEntity.prototype.setButton = function (button) {
        this.button = button;
    };
    ButtonEntity.prototype.setBorderThickness = function (thickness) {
        this.borderThickness = thickness;
    };
    ButtonEntity.prototype.setText = function (text) {
        this.content = text;
    };
    ButtonEntity.prototype.getText = function () {
        return this.content;
    };
    ButtonEntity.prototype.getCenter = function () {
        return {
            x: this.p.x + this.s.x * 0.5 + this.clickOffset.x,
            y: this.p.y + this.s.y * 0.5 + this.clickOffset.y
        };
    };
    ButtonEntity.prototype.update = function (tick, mouse) {
        if (!this.visible)
            return;
        var wasHovered = this.hovered;
        this.hovered = !mouse.dragging && this.isInside(mouse) && !this.game.usingPad;
        if (!wasHovered && this.hovered)
            this.hover();
        if (!mouse.pressing) {
            if (this.pressed && !mouse.dragging && this.hovered) {
                // this.onClick();
            }
            this.pressed = false;
        }
        if (this.hovered && mouse.pressing && !this.pressed && !mouse.dragging) {
            this.pressed = true;
            return;
        }
    };
    ButtonEntity.prototype.draw = function (ctx) {
        if (!this.visible)
            return;
        ctx.save();
        ctx.translate(0, this.hovered ? -this.hoverRise : 0);
        if (!this.frameless) {
            ctx.fillStyle = '#000';
            ctx.fillRect(this.p.x, this.p.y, this.s.x, this.s.y);
            ctx.fillStyle = this.hovered ? '#f2e949' : '#fff';
            ctx.fillRect(this.p.x + this.borderThickness, this.p.y + this.borderThickness, this.s.x - this.borderThickness * 2, this.s.y - this.borderThickness * 2);
        }
        var showButton = this.button !== PadButton.NONE;
        ctx.font = "".concat(this.fontSize, "px ").concat(font);
        // ctx.textBaseline = '';
        // console.log(ctx.textBaseline);
        ctx.textBaseline = 'alphabetic';
        ctx.textAlign = 'center';
        ctx.fillStyle = this.frameless ? '#fff' : this.contentColor;
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 6;
        if (this.strokeText)
            ctx.strokeText(this.content, this.p.x + this.s.x * 0.5 + (showButton ? 10 : 0), this.p.y + this.s.y * 0.5 + this.fontSize * 0.3);
        ctx.fillText(this.content, this.p.x + this.s.x * 0.5 + (showButton ? 10 : 0), this.p.y + this.s.y * 0.5 + this.fontSize * 0.3);
        if (showButton)
            this.drawIcon(ctx);
        ctx.restore();
    };
    ButtonEntity.prototype.drawIcon = function (ctx) {
        var w = ctx.measureText(this.content).width;
        var color = this.frameless ? '#fff' : '#000';
        if (this.button === PadButton.RT || this.button === PadButton.LT) {
            ctx.lineWidth = 2;
            var size = 13;
            var p = {
                x: this.p.x + this.s.x * 0.5 - w * 0.5 - 2 - size,
                y: this.p.y + this.s.y * 0.5 + 7 - 6 + 10
            };
            // drawRect(ctx, p, { x: size, y: size }, 'transparent', '#000' );
            ctx.strokeStyle = color;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            ctx.bezierCurveTo(p.x + size * 0.5 - size * 0.85, p.y - size * 2.25, p.x + size * 0.75 + size * 0.85, p.y - size * 2.25, p.x + size * 1.3, p.y);
            ctx.closePath();
            ctx.stroke();
            // drawCircle(ctx, { x: this.p.x + this.s.x * 0.5 - w * 0.5 - 7, y: this.p.y + this.s.y * 0.5 + 7 - 8 }, 10, 'transparent', '#000');
            var letter_1 = this.button === PadButton.RT ? 'RT' : 'LT';
            ctx.font = "12px ".concat(font);
            ctx.fillStyle = color;
            ctx.fillText(letter_1, this.p.x + this.s.x * 0.5 - w * 0.5 - 7, this.p.y + this.s.y * 0.5 + 7 - 1);
            return;
        }
        if (this.button === PadButton.START) {
            ctx.lineWidth = 2;
            var size = 9;
            var p = { x: this.p.x + this.s.x * 0.5 - w * 0.5 - 2, y: this.p.y + this.s.y * 0.5 + 7 - 6 };
            drawRect(ctx, p, { x: size, y: size }, 'transparent', color);
            drawRect(ctx, offset(p, -4, -4), { x: size, y: size }, 'transparent', color);
            // drawCircle(ctx, { x: this.p.x + this.s.x * 0.5 - w * 0.5 - 7, y: this.p.y + this.s.y * 0.5 + 7 - 8 }, 10, 'transparent', '#000');
            return;
        }
        ctx.lineWidth = 3;
        var buttonColor = ['#3c8a24', '#de3d28', '#3872c9', '#dbc337'][this.button];
        var letter = 'ABXY'[this.button];
        drawCircle(ctx, { x: this.p.x + this.s.x * 0.5 - w * 0.5 - 7, y: this.p.y + this.s.y * 0.5 + 7 - 8 }, 10, 'transparent', buttonColor);
        ctx.font = "15px ".concat(font);
        ctx.fillStyle = buttonColor;
        ctx.fillText(letter, this.p.x + this.s.x * 0.5 - w * 0.5 - 7, this.p.y + this.s.y * 0.5 + 7 - 3);
    };
    ButtonEntity.prototype.hover = function () {
        this.audio.buttonHover();
    };
    return ButtonEntity;
}(Entity));


;// CONCATENATED MODULE: ./src/engine/line.ts
var line_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var LineParticle = /** @class */ (function (_super) {
    line_extends(LineParticle, _super);
    function LineParticle(game, from, to, life, width, color, midOffset) {
        if (midOffset === void 0) { midOffset = 0; }
        var _this = _super.call(this, game, 0, 0, 0, 0, life, ZERO) || this;
        _this.from = from;
        _this.to = to;
        _this.width = width;
        _this.color = color;
        _this.midOffset = midOffset;
        _this.hDir = Math.random() < 0.5 ? 1 : -1;
        _this.vDir = Math.random() < 0.5 ? 1 : -1;
        _this.half = 0.25 + Math.random() * 0.5;
        return _this;
    }
    LineParticle.prototype.draw = function (ctx) {
        ctx.beginPath();
        ctx.lineWidth = this.width * this.ratio;
        ctx.lineCap = 'butt';
        ctx.strokeStyle = this.color;
        ctx.moveTo(this.from.x, this.from.y);
        if (this.midOffset) {
            var mid = {
                x: this.from.x * this.half + this.to.x * (1 - this.half),
                y: this.from.y * this.half + this.to.y * (1 - this.half)
            };
            var m1 = offset(mid, this.midOffset * this.hDir, this.midOffset * this.vDir);
            var m2 = offset(mid, -this.midOffset * this.hDir, this.midOffset * this.vDir);
            ctx.lineTo(m1.x, m1.y);
            ctx.lineTo(m2.x, m2.y);
        }
        ctx.lineTo(this.to.x, this.to.y);
        ctx.stroke();
    };
    return LineParticle;
}(Particle));


;// CONCATENATED MODULE: ./src/engine/pulse.ts
var pulse_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var Pulse = /** @class */ (function (_super) {
    pulse_extends(Pulse, _super);
    function Pulse(game, x, y, radius, duration, ringWidth, alpha) {
        if (duration === void 0) { duration = 1; }
        if (ringWidth === void 0) { ringWidth = 0; }
        if (alpha === void 0) { alpha = 40; }
        var _this = _super.call(this, game, x, y, radius, radius, (0.3 + Math.random() * 0.1) * duration, ZERO) || this;
        _this.radius = radius;
        _this.ringWidth = ringWidth;
        _this.alpha = alpha;
        return _this;
    }
    Pulse.prototype.draw = function (ctx) {
        var mod = Math.max(0, Math.min(1 - this.ratio, 1));
        var alpha = Math.round(mod * this.alpha).toString(16).padStart(2, '0');
        var color = '#ffffff' + alpha;
        drawCircle(ctx, this.p, mod * this.radius, this.ringWidth > 0 ? '#ffffff00' : color);
        if (this.ringWidth > 0) {
            ctx.strokeStyle = color;
            ctx.lineWidth = this.ringWidth;
            ctx.stroke();
        }
    };
    return Pulse;
}(Particle));


;// CONCATENATED MODULE: ./src/icons.ts
var drawArrows = function (ctx) {
    ctx.beginPath();
    ctx.moveTo(-5, -4);
    ctx.lineTo(0, 0);
    ctx.lineTo(5, -4);
    ctx.translate(0, 6);
    ctx.moveTo(-5, -4);
    ctx.lineTo(0, 0);
    ctx.lineTo(5, -4);
    ctx.stroke();
};
var drawRoller = function (ctx) {
    ctx.beginPath();
    ctx.moveTo(0, 3);
    ctx.lineTo(0, -10);
    ctx.lineTo(-5, -12);
    ctx.lineTo(-5, -14);
    ctx.lineTo(3, -14);
    ctx.stroke();
    ctx.lineWidth *= 2;
    ctx.beginPath();
    ctx.moveTo(-2, -14);
    ctx.lineTo(6, -14);
    ctx.stroke();
};
var drawPick = function (ctx) {
    ctx.beginPath();
    ctx.moveTo(0, 3);
    ctx.lineTo(0, -7);
    ctx.moveTo(0, -7);
    ctx.lineTo(5, -5);
    ctx.moveTo(0, -7);
    ctx.lineTo(-5, -5);
    ctx.stroke();
};
var drawWrench = function (ctx) {
    ctx.beginPath();
    ctx.moveTo(0, 3);
    ctx.lineTo(0, -1);
    ctx.moveTo(0, -1);
    ctx.quadraticCurveTo(3, -4, 1, -6);
    ctx.moveTo(0, -1);
    ctx.quadraticCurveTo(-3, -4, -1, -6);
    ctx.stroke();
};

;// CONCATENATED MODULE: ./src/dude.ts
var dude_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var dude_assign = (undefined && undefined.__assign) || function () {
    dude_assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return dude_assign.apply(this, arguments);
};










var SIZE = 8;
var Dude = /** @class */ (function (_super) {
    dude_extends(Dude, _super);
    function Dude(game, scene, upgrades) {
        var _this = _super.call(this, game, WIDTH * 0.5, -300, 5, 5) || this;
        _this.scene = scene;
        _this.upgrades = upgrades;
        _this.showPrompt = false;
        _this.warps = 0;
        _this.velocity = { x: 0, y: 0 };
        _this.gravity = 1;
        _this.grounded = false;
        _this.movement = 0;
        _this.jumpBuffer = 0;
        _this.groundBuffer = 0;
        _this.mirror = 1;
        _this.stepPhase = 0;
        _this.swingTime = 0;
        _this.tool = 'pick';
        _this.locked = false;
        _this.fallTime = null;
        _this.usedDoubleJump = false;
        _this.boost = 1;
        _this.tickSum = 0;
        _this.bubble = new Bubble(game, '', 0, -10, { bgColor: '#000', color: '#fff' });
        _this.bubble.onDone = function () { return _this.clearBubble(); };
        _this.bubble.onWord = function () { return _this.game.audio.talk(); };
        _this.promptButton = new ButtonEntity(game, 'E', 0, 0, 30, 30, function () { }, game.audio, 12);
        game.onKeyDown(function (e) {
            if (_this.locked)
                return;
            if (e.key === 'F1') {
                _this.scene.debug = !_this.scene.debug;
            }
            if (e.key === 't' && _this.canTeleport()) {
                _this.teleport();
            }
            if (e.key === 'e' || e.key === 'ArrowDown' || e.key === 's') {
                _this.scene.toggleStationMenu();
            }
            if (e.key === '1')
                _this.scene.swapTo(0);
            if (e.key === '2')
                _this.scene.swapTo(1);
            if (e.key === '3')
                _this.scene.swapTo(2);
            if (e.key === '4')
                _this.scene.swapTo(3);
            if (e.key === '5')
                _this.scene.swapTo(4);
            if (e.key === '6')
                _this.scene.swapTo(5);
            if (e.key === '7')
                _this.scene.swapTo(6);
            if (e.key === '8')
                _this.scene.swapTo(7);
            if (e.key === '9')
                _this.scene.swapTo(8);
            if (e.key === 'g') {
                _this.scene.addGem('white');
            }
            if (e.key === 'Backspace') {
                console.log('clearing save');
                localStorage.removeItem('world-404');
            }
            if (e.key === 'q' && _this.upgrades.canWarp && _this.warps > 0) {
                if (_this.scene.isWarpRestricted()) {
                    _this.talk('Some force is preventing me from teleporting here.');
                    _this.game.audio.fail();
                    _this.swing();
                    return;
                }
                _this.warps--;
                _this.teleportTo(dude_assign({}, _this.game.getMouse()));
            }
            // if (e.key === 'p') {
            //     this.switchTool('builder');
            //     this.hold(new PowerStation(this.game, 0, 0));
            //     this.station.placing = true;
            //     this.station.blocked = true;
            // }            
            // if (e.key === 'b') {
            //     this.switchTool('builder');
            //     this.hold(new StorageStation(this.game, 0, 0, 15, 20));
            //     this.station.store(Scene.createGem('white', 99));
            //     this.station.store(Scene.createGem('red', 99));
            //     this.station.store(Scene.createGem('blue', 99));
            //     this.station.store(Scene.createGem('green', 99));
            //     this.station.store(Scene.createGem('orange', 99));
            //     this.station.store(Scene.createGem('yellow', 99));
            //     this.station.store(Scene.createGem('purple', 99));
            //     this.station.store(Scene.createGem('magenta', 99));
            //     this.station.store(Scene.createGem('cyan', 99));
            //     this.station.placing = true;
            //     this.station.blocked = true;
            // }            
            if (e.key === 'ArrowLeft' || e.key === 'a') {
                _this.movement = -1;
                _this.mirror = -1;
            }
            if (e.key === 'ArrowRight' || e.key === 'd') {
                _this.movement = 1;
                _this.mirror = 1;
            }
            if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w') {
                if (!_this.isGrounded()) {
                    _this.jumpBuffer = 5;
                    return;
                }
                _this.jump();
            }
        });
        game.onKeyUp(function (e) {
            if (_this.movement < 0 && (e.key === 'ArrowLeft' || e.key === 'a') ||
                _this.movement > 0 && (e.key === 'ArrowRight' || e.key === 'd')) {
                _this.movement = 0;
            }
        });
        return _this;
    }
    Dude.prototype.teleportTo = function (target) {
        this.scene.throwBits(this.p, 20, '#000', 1, true);
        this.scene.add(new Pulse(this.game, this.p.x, this.p.y, 20, 0.6, 4, 40));
        var pp = offset(this.p, 0, 0);
        this.p = target;
        // this.game.audio.teleport();
        this.game.audio.enter();
        var p = offset(this.p, 0, 0);
        this.scene.throwBits(offset(p, 0, 5), 10, '#fff', 1.5, true);
        this.scene.add(new Pulse(this.game, this.p.x, this.p.y, 20, 0.6, 4, 40));
        this.scene.add(new LineParticle(this.game, p, pp, 0.75, 5, '#fff', 5));
        this.scene.add(new LineParticle(this.game, p, pp, 0.75, 2, '#fff', 10));
        this.scene.add(new LineParticle(this.game, p, pp, 0.75, 1, '#fff', 15));
    };
    Dude.prototype.canTeleport = function () {
        if (this.scene.isInBase()) {
            this.talk('I can not do that here.');
            this.game.audio.fail();
            this.swing();
            return false;
        }
        if (!this.isGrounded()) {
            return false;
        }
        if (!this.scene.canTeleport()) {
            this.talk('I need to see the sky to teleport.');
            this.game.audio.fail();
            this.swing();
            return false;
        }
        return true;
    };
    Dude.prototype.getHeld = function () {
        return this.station;
    };
    Dude.prototype.removeHeld = function () {
        this.station = null;
    };
    Dude.prototype.teleport = function () {
        var _this = this;
        this.game.audio.teleport();
        this.swing();
        this.locked = true;
        this.velocity = { x: 0, y: 0 };
        this.movement = 0;
        this.doBeam(-5);
        setTimeout(function () {
            _this.game.audio.enter();
            _this.scene.switchArea();
            _this.locked = false;
            _this.doBeam(15);
            _this.game.audio.teleport();
        }, 800);
    };
    Dude.prototype.doBeam = function (overShoot) {
        if (overShoot === void 0) { overShoot = 0; }
        var p = offset(this.p, 0, 15 + overShoot);
        var pp = offset(this.p, 0, -HEIGHT - 50);
        this.scene.throwBits(offset(p, 0, 5), 20, '#fff', 1.5, true);
        this.scene.add(new LineParticle(this.game, p, pp, 0.75, 20, '#fff'));
    };
    Dude.prototype.switchTool = function (tool) {
        this.scene.resetTool();
        if (this.tool !== tool)
            this.swing();
        this.tool = tool;
    };
    Dude.prototype.isGrounded = function () {
        return this.grounded || this.groundBuffer > 0;
    };
    Dude.prototype.swing = function () {
        this.swingTime = 1;
    };
    Dude.prototype.jump = function (mod) {
        if (mod === void 0) { mod = 1; }
        if (!this.isGrounded())
            this.usedDoubleJump = true;
        this.game.audio.jump();
        this.velocity.x *= 1.6 * mod;
        this.velocity.y = -4 * mod * 0.7;
        this.gravity = 0.25;
        this.grounded = false;
        this.groundBuffer = 0;
        // this.stepPhase *= -1;
    };
    Dude.prototype.canStepUp = function () {
        if (!this.scene.collides(this.p.x + this.velocity.x, this.p.y + this.velocity.y - SIZE * 0.5, SIZE + 1))
            return true;
        if (!this.scene.collides(this.p.x + this.velocity.x, this.p.y + this.velocity.y - SIZE * 0.7, SIZE + 1))
            return true;
        if (!this.scene.collides(this.p.x + this.velocity.x, this.p.y + this.velocity.y - SIZE * 0.9, SIZE))
            return true;
        // if (!this.scene.collides(this.p.x + this.velocity.x, this.p.y + this.velocity.y - SIZE * 3, SIZE)) return true;
        return false;
    };
    Dude.prototype.getDir = function () {
        return this.mirror;
    };
    Dude.prototype.update = function (tick, mouse) {
        var _this = this;
        var _a, _b, _c;
        _super.prototype.update.call(this, tick, mouse);
        (_a = this.station) === null || _a === void 0 ? void 0 : _a.update(tick, mouse);
        this.bubble.update(tick, mouse);
        this.velocity.x = this.movement * this.boost * this.delta / 18;
        this.velocity.y += this.gravity * this.delta / 15;
        this.grounded = this.scene.collides(this.p.x, this.p.y + this.velocity.y, SIZE);
        if (this.grounded && this.velocity.y > 1.5) {
            this.game.audio.land(this.velocity.y);
        }
        var step = this.canStepUp();
        if (!this.grounded) {
            this.fallTime = (_b = this.fallTime) !== null && _b !== void 0 ? _b : tick;
        }
        this.jumpBuffer--;
        this.groundBuffer--;
        if (this.grounded)
            this.groundBuffer = 10;
        if (this.swingTime > 0)
            this.swingTime -= 0.1;
        if (!this.grounded && this.upgrades.doubleJump && !this.usedDoubleJump && this.jumpBuffer > 0) {
            this.boost = 1.5;
            this.jump(1.1);
            this.jumpBuffer = 0;
            this.game.audio.jetpack();
            this.scene.throwBits(offset(this.p, 0, 15), 15, '#fff', 1.5, true);
            return;
        }
        if (this.isGrounded()) {
            if (this.jumpBuffer > 0) {
                this.jump();
                this.jumpBuffer = 0;
                return;
            }
            var diff = tick - ((_c = this.fallTime) !== null && _c !== void 0 ? _c : tick);
            if (diff > 500) {
                this.scene.throwBits(offset(this.p, 0, 15), 15, '#000', 1.5, true);
                this.game.camera.shake(2, 0.2, 0.05);
            }
            this.fallTime = null;
            this.usedDoubleJump = false;
            this.boost = 1;
            if (Math.abs(this.velocity.x) > 0.1) {
                if (!step)
                    this.velocity.x = 0;
                else {
                    this.p.y -= this.scene.getGroundPos(this.p.x + this.velocity.x, this.p.y + this.velocity.y + SIZE);
                    this.grounded = true;
                }
            }
            this.velocity.y = 0;
            // this.gravity = 1;
        }
        if (this.gravity < 1) {
            this.gravity = Math.min(this.gravity + this.delta * 0.00005, 1);
        }
        if (!this.grounded && !step) {
            this.velocity.x = 0;
        }
        if (this.grounded && Math.abs(this.movement) > 0.1) {
            this.stepPhase = Math.sin(tick * 0.03);
            if (Math.abs(this.stepPhase) > 0.9)
                this.game.audio.step(this.stepPhase > 0);
        }
        var limit = 15;
        this.velocity = {
            x: clamp(this.velocity.x, -limit, limit),
            y: clamp(this.velocity.y, -10, 5),
        };
        this.p.x += this.velocity.x;
        this.p.y += this.velocity.y * this.delta / 10;
        if (this.p.y > HEIGHT && !this.locked) {
            if (this.scene.isInBase()) {
                this.game.audio.enter();
                this.scene.switchArea();
                return;
            }
            this.game.camera.shake(4, 0.3, 0.075);
            this.game.audio.die();
            this.scene.loseHalf();
            setTimeout(function () { return _this.talk('Ouch! I should prepare more\nbefore my next expedition.'); }, 800);
            this.teleport();
        }
    };
    Dude.prototype.talk = function (text) {
        if (this.talkTimer)
            clearTimeout(this.talkTimer);
        var menu = this.scene.isMenuOpen();
        var menuDir = this.p.x < WIDTH * 0.5 ? 'left' : 'right';
        var onEdge = Math.abs(this.p.x - WIDTH * 0.5) > WIDTH * 0.25;
        var baseDir = onEdge ? (this.p.x < WIDTH * 0.5 ? 'right' : 'left') : 'center';
        var dir = menu && !onEdge ? menuDir : baseDir;
        this.bubble.changeDirection(dir);
        // if()
        this.bubble.setText(text);
    };
    Dude.prototype.clearBubble = function () {
        var _this = this;
        if (this.talkTimer)
            clearTimeout(this.talkTimer);
        this.talkTimer = setTimeout(function () { return _this.bubble.setText(''); }, 1700);
    };
    Dude.prototype.hold = function (station) {
        this.station = station;
        station.p = { x: -5, y: -5 };
        this.station.placing = true;
        this.station.blocked = true;
    };
    Dude.prototype.hasTool = function () {
        var tools = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            tools[_i] = arguments[_i];
        }
        return tools.includes(this.tool);
    };
    Dude.prototype.draw = function (ctx) {
        // drawCircle(ctx, this.p, 5, 'white');
        ctx.save();
        ctx.translate(this.p.x, this.p.y);
        ctx.scale(this.mirror, 1);
        ctx.save();
        var swingPhase = this.swingTime > 0 ? Math.sin(this.swingTime * Math.PI * 2) : 0;
        ctx.rotate(swingPhase * -0.2);
        ctx.translate(0, this.animationPhaseAbs * 2);
        drawCircle(ctx, { x: 0, y: 0 }, 4, 'black');
        drawCircle(ctx, { x: 1, y: -5 }, 3, 'black');
        ctx.save();
        ctx.translate(-4, -2);
        ctx.rotate(-this.animationPhaseAbs * 0.2 + this.stepPhase * -0.1);
        if (this.upgrades.doubleJump) {
            ctx.fillRect(-2, -2 + this.animationPhaseAbs, 5, 6);
        }
        // if (this.upgrades.canWarp) {
        //     ctx.lineWidth = 2;
        //     ctx.beginPath();
        //     ctx.moveTo(0, -2 + this.animationPhaseAbs);
        //     ctx.lineTo(0, -15 + this.animationPhaseAbs);
        //     ctx.moveTo(-3,  -12 + this.animationPhaseAbs);
        //     ctx.lineTo(3,  -12 + this.animationPhaseAbs);
        //     ctx.stroke();
        // }
        ctx.restore();
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.rotate(this.animationPhaseAbs * 0.1 + this.stepPhase * 0.2 + swingPhase * 0.5);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(7, 1);
        ctx.stroke();
        ctx.translate(7, 1);
        if (this.tool === 'pick') {
            ctx.rotate(0.5);
            drawPick(ctx);
        }
        if (this.tool === 'roller') {
            ctx.rotate(0.3);
            ctx.scale(0.9, 0.9);
            drawRoller(ctx);
        }
        if (this.tool === 'wrench') {
            ctx.rotate(0.5);
            drawWrench(ctx);
        }
        if (this.tool === 'note') {
            ctx.rotate(0.75);
            ctx.beginPath();
            ctx.moveTo(0, 1);
            ctx.lineTo(0, -5);
            ctx.stroke();
        }
        ctx.restore();
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(-2, this.animationPhaseAbs * 5);
        ctx.quadraticCurveTo(0, 5, -3 + this.stepPhase * 2, 10);
        ctx.moveTo(-1, this.animationPhaseAbs * 5);
        ctx.quadraticCurveTo(6, 5, 3 - this.stepPhase * 2, 10);
        ctx.stroke();
        ctx.scale(this.mirror * 0.7, 1 * 0.7);
        this.bubble.draw(ctx);
        if (this.showPrompt) {
            ctx.translate(0, 40 - this.animationPhaseAbs * 2);
            this.promptButton.draw(ctx);
        }
        ctx.restore();
    };
    return Dude;
}(Entity));


;// CONCATENATED MODULE: ./src/engine/container.ts
var container_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var container_spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};

var Container = /** @class */ (function (_super) {
    container_extends(Container, _super);
    function Container(game, x, y, entities) {
        var _a;
        if (x === void 0) { x = 0; }
        if (y === void 0) { y = 0; }
        if (entities === void 0) { entities = []; }
        var _this = _super.call(this, game, x, y, 0, 0) || this;
        _this.children = [];
        (_a = _this.children).push.apply(_a, entities);
        return _this;
    }
    Container.prototype.getBgColor = function () {
        return '#ccc';
    };
    Container.prototype.update = function (tick, mouse) {
        _super.prototype.update.call(this, tick, mouse);
        this.children.forEach(function (c) { return c.update(tick, mouse); });
        if (this.children.some(function (c) { return c.dead; })) {
            this.children = this.children.filter(function (c) { return !c.dead; });
        }
    };
    Container.prototype.hide = function (duration) {
        if (duration === void 0) { duration = 0.3; }
        this.tween.scale({ x: 0, y: 0 }, duration);
    };
    Container.prototype.show = function (duration) {
        if (duration === void 0) { duration = 0.3; }
        this.tween.scale({ x: 1, y: 1 }, duration);
    };
    Container.prototype.draw = function (ctx) {
        ctx.save();
        container_spreadArray([], this.children, true).sort(function (a, b) { return a.d - b.d; }).forEach(function (c) { return c.draw(ctx); });
        ctx.restore();
    };
    Container.prototype.getChild = function (index) {
        return this.children[index];
    };
    Container.prototype.getChildren = function () {
        return this.children;
    };
    Container.prototype.add = function () {
        var _a;
        var entity = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            entity[_i] = arguments[_i];
        }
        (_a = this.children).push.apply(_a, entity);
    };
    Container.prototype.clear = function () {
        this.children = [];
    };
    Container.prototype.getButtons = function () {
        return [];
    };
    return Container;
}(Entity));


;// CONCATENATED MODULE: ./src/engine/rect.ts
var rect_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var RectParticle = /** @class */ (function (_super) {
    rect_extends(RectParticle, _super);
    function RectParticle(game, x, y, width, height, life, velocity, options) {
        var _a;
        var _this = _super.call(this, game, x, y, width, height, life, velocity) || this;
        _this.options = options;
        if ((_a = _this.options) === null || _a === void 0 ? void 0 : _a.depth) {
            _this.d = _this.options.depth;
        }
        return _this;
    }
    RectParticle.prototype.update = function (tick, mouse) {
        var _a;
        if ((_a = this.options) === null || _a === void 0 ? void 0 : _a.force) {
            this.velocity = {
                x: this.velocity.x + this.options.force.x,
                y: this.velocity.y + this.options.force.y
            };
        }
        _super.prototype.update.call(this, tick, mouse);
    };
    RectParticle.prototype.draw = function (ctx) {
        var _a, _b, _c, _d;
        ctx.save();
        ctx.translate(this.p.x, this.p.y);
        ctx.rotate((_b = (_a = this.options) === null || _a === void 0 ? void 0 : _a.angle) !== null && _b !== void 0 ? _b : 0);
        ctx.fillStyle = (_d = (_c = this.options) === null || _c === void 0 ? void 0 : _c.color) !== null && _d !== void 0 ? _d : '#fff';
        ctx.fillRect(-this.s.x * 0.5, -this.s.y * 0.5, this.s.x, this.s.y);
        ctx.restore();
    };
    return RectParticle;
}(Particle));


;// CONCATENATED MODULE: ./src/gems.ts
var gems = ['white', 'blue', 'green', 'red', 'yellow', 'purple', 'cyan', 'orange', 'magenta'];
var getGemColor = function (gem) {
    switch (gem) {
        case 'white':
            return '#fff';
        case 'red':
            return '#de190b';
        case 'blue':
            return '#4768c4';
        case 'green':
            return '#4fab4f';
        case 'yellow':
            return '#faf61e';
        case 'purple':
            return '#8144e3';
        case 'cyan':
            return '#5de3de';
        case 'orange':
            return '#e3942d';
        case 'magenta':
            return '#e88bdc';
        default:
            return gem;
    }
};
var getGemName = function (gem) {
    switch (gem) {
        case 'white':
            return 'Opal';
        case 'red':
            return 'Ruby';
        case 'blue':
            return 'Sapphire';
        case 'green':
            return 'Emerald';
        case 'yellow':
            return 'Jade';
        case 'purple':
            return 'Amethyst';
        case 'cyan':
            return 'Aquamarine';
        case 'orange':
            return 'Tiger Eye';
        case 'magenta':
            return 'Morganite';
        default:
            return gem;
    }
};
var getGemDescription = function (gem) {
    switch (gem) {
        case 'white':
            return 'Most commonly found of all the gemstones. Can be encountered in almost all worlds. Any worlds with letters A, E or O have them.';
        case 'blue':
            return 'Very common gemstone of blue tint. Can be found in worlds with I, S or T letters';
        case 'green':
            return 'Quite uncommon green gemstone. can be found in worlds with letters U, P or R';
        case 'red':
            return 'Pretty common red colored gemstone. Can be found in worlds with D, N or M letters.';
        case 'yellow':
            return 'An uncommon yellow gem. Can be found in worlds with G, B or H letters.';
        case 'purple':
            return 'Fairly rare and beautiful deep purple gem. Can be found in worlds with L, Y or W letters.';
        case 'cyan':
            return 'Rare cyan colored gem that reminds one of the foamy sea. Can be encountered in worlds with F, C or K letters.';
        case 'orange':
            return 'Very rare orange gem with dark stripes. Can be encountered in worlds with letters V, X or Z.';
        case 'magenta':
            return 'The most rare of all the gemstones. These priceless pink gems can only be found from worlds with J or Q letters.';
        default:
            return gem;
    }
};

;// CONCATENATED MODULE: ./src/inventory.ts
var inventory_assign = (undefined && undefined.__assign) || function () {
    inventory_assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return inventory_assign.apply(this, arguments);
};
var inventory_spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};




var Inventory = /** @class */ (function () {
    function Inventory(capacity) {
        this.capacity = capacity;
        this.items = [];
        this.fullMessage = 'Can\'t fit any more items there.';
        this.items = Array.from(Array(capacity)).fill(null);
    }
    Inventory.prototype.setFullMessage = function (message) {
        this.fullMessage = message;
    };
    Inventory.prototype.get = function () {
        return this.items;
    };
    Inventory.prototype.getRockCount = function () {
        return this.items.reduce(function (count, item) { return (item === null || item === void 0 ? void 0 : item.id) === 'rock' ? count + item.amount : count; }, 0);
    };
    Inventory.prototype.clear = function () {
        var _this = this;
        this.items.forEach(function (_, i) { return _this.clearSlot(i); });
    };
    Inventory.prototype.hasSpace = function () {
        return this.items.some(function (i) { return !i; });
    };
    Inventory.prototype.fill = function (amount) {
        var _this = this;
        this.items.forEach(function (item, index) {
            if (item)
                return;
            _this.items[index] = Scene.createGem(randomCell(inventory_spreadArray([], gems, true)), amount);
        });
    };
    Inventory.prototype.clearSlot = function (index) {
        var _a;
        if (((_a = this.items[index]) === null || _a === void 0 ? void 0 : _a.name) === 'pick')
            return;
        this.items[index] = null;
    };
    Inventory.prototype.canAdd = function (item) {
        return this.items.some(function (i) { return i && i.name === item.name && (item.amount + i.amount) <= MAX_STACK_SIZE; });
    };
    Inventory.prototype.halveGems = function () {
        var _this = this;
        this.items.forEach(function (item) {
            if (!item || item.id !== 'gem')
                return;
            item.amount = Math.floor(item.amount / 2);
            if (item.amount <= 0)
                _this.remove(item);
        });
    };
    Inventory.prototype.consumeRock = function (amount) {
        var item = this.items.find(function (i) { return (i === null || i === void 0 ? void 0 : i.id) === 'rock'; });
        if (item) {
            var have = item.amount;
            if (item.amount > amount) {
                item.amount -= amount;
            }
            else {
                var left = amount - have;
                this.remove(item);
                if (left > 0)
                    this.consumeRock(left);
            }
        }
    };
    Inventory.prototype.consume = function (costs) {
        var _this = this;
        costs.forEach(function (cost) {
            var item = _this.items.find(function (i) { return (i === null || i === void 0 ? void 0 : i.id) === 'gem' && (i === null || i === void 0 ? void 0 : i.name) === cost.color; });
            if (item) {
                var have = item.amount;
                if (item.amount > cost.amount) {
                    item.amount -= cost.amount;
                }
                else {
                    _this.remove(item);
                }
                cost.amount = Math.max(cost.amount - have, 0);
            }
        });
    };
    Inventory.prototype.swap = function (a, b) {
        var temp = this.items[a];
        this.items[a] = this.items[b];
        this.items[b] = temp;
    };
    Inventory.prototype.remove = function (item, one) {
        if (!item)
            return;
        if (one && item.amount > 1) {
            this.items[this.items.indexOf(item)] = inventory_assign(inventory_assign({}, item), { amount: item.amount - 1 });
            return;
        }
        this.items[this.items.indexOf(item)] = null;
    };
    Inventory.canStack = function (item) {
        return item && item.id !== 'station' && item.id !== 'tool' && item.id !== 'note';
    };
    Inventory.prototype.clearEmpties = function () {
        this.items = this.items.map(function (i) { return (i === null || i === void 0 ? void 0 : i.amount) ? i : null; });
    };
    Inventory.prototype.add = function (item, from, dude) {
        if (!item)
            return;
        var match = this.items.find(function (i) { return (i === null || i === void 0 ? void 0 : i.name) === item.name && (i === null || i === void 0 ? void 0 : i.amount) < MAX_STACK_SIZE && Inventory.canStack(item); });
        if (match) {
            match.amount += item.amount;
            if (from)
                from.amount -= item.amount;
            if (match.amount > MAX_STACK_SIZE) {
                if (from)
                    from.amount = match.amount - MAX_STACK_SIZE;
                this.add(inventory_assign(inventory_assign({}, item), { amount: match.amount - MAX_STACK_SIZE }));
                match.amount = MAX_STACK_SIZE;
            }
            return;
        }
        if (this.items.length >= this.capacity) {
            if (this.items.every(function (i) { return !!i; })) {
                dude === null || dude === void 0 ? void 0 : dude.talk(this.fullMessage);
                return;
            }
            this.items[this.items.findIndex(function (i) { return !i; })] = item;
        }
        else {
            this.items.push(item);
        }
        if (from)
            from.amount -= item.amount;
    };
    Inventory.prototype.updateButtons = function (buttons) {
        var _this = this;
        buttons.forEach(function (b, i) { return b === null || b === void 0 ? void 0 : b.setup(_this.items[i]); });
    };
    return Inventory;
}());


;// CONCATENATED MODULE: ./src/toolbar-button.ts
var toolbar_button_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var ToolbarButton = /** @class */ (function (_super) {
    toolbar_button_extends(ToolbarButton, _super);
    function ToolbarButton(game, key, icon, iconColor, x, y, callback) {
        var _this = _super.call(this, game, '', x, y, BUTTON_SIZE, BUTTON_SIZE, callback, game.audio, 12) || this;
        _this.key = key;
        _this.icon = icon;
        _this.amount = 1;
        _this.curColor = '#f3f595';
        _this.contentColor = iconColor;
        _this.setBorderThickness(4);
        return _this;
    }
    ToolbarButton.prototype.isHovered = function () {
        return this.hovered;
    };
    ToolbarButton.prototype.getItem = function () {
        return this.item;
    };
    ToolbarButton.prototype.clear = function () {
        this.item = null;
        this.icon = null;
        this.content = '';
        this.amount = 0;
    };
    ToolbarButton.prototype.setAmount = function (amount) {
        this.amount = amount;
    };
    ToolbarButton.prototype.setup = function (item) {
        if (!item) {
            this.clear();
            return;
        }
        this.item = item;
        this.icon = item.icon;
        this.contentColor = getGemColor(item.color);
        this.amount = item.amount;
        this.strokeText = !!item.outline;
    };
    ToolbarButton.prototype.draw = function (ctx, current) {
        var _a, _b;
        ctx.save();
        var rise = (this.hovered ? 5 : 0);
        ctx.save();
        ctx.translate(this.p.x, this.p.y - rise);
        ctx.fillStyle = this.curColor;
        if (current)
            ctx.fillRect(-2, -2, BUTTON_SIZE + 4, BUTTON_SIZE + 4);
        ctx.restore();
        _super.prototype.draw.call(this, ctx);
        ctx.restore();
        ctx.save();
        ctx.translate(this.p.x + BUTTON_SIZE * 0.5, this.p.y + BUTTON_SIZE - 3 - rise);
        ctx.save();
        ctx.translate(0, BUTTON_SIZE * -0.35);
        ctx.fillStyle = '#000';
        ctx.font = 'bold 15px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        if (((_a = this.icon) === null || _a === void 0 ? void 0 : _a.length) < 2)
            ctx.fillText(this.icon, 0, 0);
        ctx.restore();
        if (this.amount > 1 || this.icon === 'gem') {
            ctx.fillStyle = '#000';
            roundRect(ctx, -9, -6, 18, 12, 5);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '8px sans-serif';
            ctx.fillText(this.amount.toString(), 0, 0);
        }
        ctx.translate(0, -BUTTON_SIZE - (current ? 2 : 0));
        if (this.key) {
            if (current)
                ctx.scale(1.1, 1.1);
            ctx.fillStyle = current ? this.curColor : '#fff';
            roundRect(ctx, -8, -8, 16, 16, 5);
            ctx.fill();
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 10px sans-serif';
            ctx.fillStyle = '#000';
            ctx.fillText(this.key, 0, 0);
        }
        if ((_b = this.item) === null || _b === void 0 ? void 0 : _b.station) {
            ctx.save();
            ctx.translate(0, BUTTON_SIZE * 0.5 + this.item.station.iconOffset);
            ctx.scale(this.item.station.iconScale, this.item.station.iconScale);
            this.item.station.draw(ctx, '#000', true);
            ctx.restore();
        }
        ctx.translate(0, BUTTON_SIZE * 0.5 + 3);
        if (this.icon === 'teleport') {
            ctx.rotate(Math.PI);
            ctx.translate(0, -2);
            drawArrows(ctx);
        }
        if (this.icon === 'gem') {
            ctx.lineWidth = 2.5;
            drawCircle(ctx, { x: 0, y: -1 }, 4, this.contentColor, '#000');
        }
        if (this.icon === 'roller') {
            ctx.translate(-6, 6);
            ctx.scale(0.9, 0.9);
            ctx.rotate(Math.PI * 0.25);
            ctx.lineWidth = 2;
            drawRoller(ctx);
        }
        if (this.icon === 'pick') {
            ctx.translate(-2, 3);
            ctx.scale(1.1, 1.1);
            ctx.rotate(Math.PI * 0.25);
            ctx.lineWidth = 2;
            drawPick(ctx);
        }
        if (this.icon === 'wrench') {
            ctx.translate(-2, 3);
            ctx.scale(1.4, 1.4);
            ctx.rotate(Math.PI * 0.25);
            ctx.lineWidth = 2;
            drawWrench(ctx);
        }
        if (this.icon === 'note') {
            ctx.lineWidth = 2.5;
            ctx.translate(0, 2);
            ctx.strokeRect(-5, -7, 10, 12);
            ctx.moveTo(-2, -3);
            ctx.lineTo(2, -3);
            ctx.moveTo(-2, 1);
            ctx.lineTo(2, 1);
            ctx.stroke();
        }
        ctx.restore();
    };
    ToolbarButton.prototype.setOutline = function (outline) {
        this.strokeText = outline;
    };
    return ToolbarButton;
}(ButtonEntity));


;// CONCATENATED MODULE: ./src/toolbar.ts
var toolbar_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var toolbar_assign = (undefined && undefined.__assign) || function () {
    toolbar_assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return toolbar_assign.apply(this, arguments);
};
var toolbar_spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};




var BUTTON_SIZE = 30;
var GAP = 5;
var MAX_STACK_SIZE = 999;
var MATERIAL_PER_DISTANCE = 1;
var Toolbar = /** @class */ (function (_super) {
    toolbar_extends(Toolbar, _super);
    function Toolbar(game, scene, dude) {
        var _this = _super.call(this, game, 0, 0, 0, 0) || this;
        _this.scene = scene;
        _this.dude = dude;
        _this.storage = new Inventory(9);
        _this.buttons = [];
        _this.current = 0;
        _this.storage.setFullMessage('Can\'t carry any more items.');
        _this.teleportButton = new ToolbarButton(game, 'T', 'teleport', '#000', 0, 0, function () {
            if (_this.dude.canTeleport()) {
                _this.dude.teleport();
            }
        });
        _this.buttons = _this.storage.get().map(function (orig, i) {
            var _a;
            var btn = new ToolbarButton(_this.game, (i + 1).toString(), orig === null || orig === void 0 ? void 0 : orig.icon, orig === null || orig === void 0 ? void 0 : orig.color, 40 * i - 80, HEIGHT * 0.5 + 105, function (right) {
                _this.use(i, right);
            });
            btn.setAmount((_a = orig === null || orig === void 0 ? void 0 : orig.amount) !== null && _a !== void 0 ? _a : 0);
            return btn;
        });
        return _this;
    }
    Toolbar.prototype.hasMaterialFor = function (dist) {
        return this.storage.getRockCount() > dist * MATERIAL_PER_DISTANCE;
    };
    Toolbar.prototype.consumeMaterial = function (dist) {
        this.storage.consumeRock(Math.round(dist * MATERIAL_PER_DISTANCE));
        this.storage.updateButtons(this.buttons);
    };
    Toolbar.prototype.getDude = function () {
        return this.dude;
    };
    Toolbar.prototype.hasSpace = function () {
        return this.storage.hasSpace();
    };
    Toolbar.prototype.loseHalf = function () {
        this.storage.halveGems();
        this.storage.updateButtons(this.buttons);
    };
    Toolbar.prototype.clearEmpties = function () {
        this.storage.clearEmpties();
        this.storage.updateButtons(this.buttons);
    };
    Toolbar.prototype.consume = function (costs) {
        this.storage.consume(costs);
        this.storage.updateButtons(this.buttons);
    };
    Toolbar.prototype.getItems = function () {
        return this.storage.get();
    };
    Toolbar.prototype.reHolster = function () {
        var item = this.buttons[this.current].getItem();
        this.dude.switchTool(item ? item.tool : 'none');
    };
    Toolbar.prototype.use = function (index, right) {
        var btn = this.buttons[index];
        var item = btn.getItem();
        var cur = this.buttons.find(function (b) { return b.isHovered(); });
        if (cur && cur !== btn) {
            this.storage.swap(index, this.buttons.indexOf(cur));
            this.storage.updateButtons(this.buttons);
            this.reHolster();
            return;
        }
        var station = this.scene.getStation();
        if (item && station && station.canStore()) {
            if (item.tool === 'pick') {
                this.dude.talk('I really don\'t think I should do that.');
                return;
            }
            station.store(toolbar_assign(toolbar_assign({}, item), { amount: right ? 1 : item.amount }), item, this.dude);
            this.storage.clearEmpties();
            this.storage.updateButtons(this.buttons);
            if (this.dude.hasTool(item.tool)) {
                this.dude.switchTool('none');
            }
            return;
        }
        if (this.current === index) {
            this.useSelected();
        }
        this.current = index;
        this.dude.switchTool(item ? item.tool : 'none');
        this.game.audio.switch();
        if (item) {
            if (item.tool === 'builder' && item.station)
                this.dude.hold(item.station);
        }
    };
    Toolbar.prototype.clearCurrent = function () {
        this.storage.clearSlot(this.current);
        this.storage.updateButtons(this.buttons);
    };
    Toolbar.prototype.addItem = function (item, from, dude) {
        this.storage.add(item, from, dude);
        this.storage.updateButtons(this.buttons);
        this.repositionButtons();
    };
    Toolbar.prototype.repositionButtons = function () {
        var diff = (this.buttons.length + 0.75) * 0.5 * (BUTTON_SIZE + GAP);
        this.buttons.forEach(function (b, i) {
            b.p.x = (BUTTON_SIZE + GAP) * i + WIDTH * 0.5 - diff;
            b.p.y = HEIGHT - BUTTON_SIZE - GAP;
        });
        this.teleportButton.p.x = (BUTTON_SIZE + GAP) * this.buttons.length + WIDTH * 0.5 - diff;
        this.teleportButton.p.y = HEIGHT - BUTTON_SIZE - GAP;
    };
    Toolbar.prototype.getButtons = function () {
        return toolbar_spreadArray(toolbar_spreadArray([], this.buttons, true), [this.teleportButton], false);
    };
    Toolbar.prototype.draw = function (ctx) {
        var _this = this;
        ctx.save();
        this.buttons.forEach(function (b, i) { return b.draw(ctx, i === _this.current); });
        // ctx.translate(-BUTTON_SIZE * 0.5, 0);
        this.teleportButton.draw(ctx);
        ctx.restore();
    };
    Toolbar.prototype.useSelected = function () {
        var item = this.getItems()[this.current];
        if (item && item.tool === 'note') {
            this.dude.talk("The note reads: \"".concat(item.name, "\""));
        }
    };
    return Toolbar;
}(Entity));


;// CONCATENATED MODULE: ./src/station-menu.ts
var station_menu_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var station_menu_spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};







var randomCost = function (amount, count) {
    if (count === void 0) { count = 1; }
    var colors = station_menu_spreadArray([], gems, true).sort(randomSorter);
    return Array.from(Array(count)).map(function (_, i) { return ({ color: colors[i], amount: amount + Math.floor(Math.random() * amount) }); });
};
var StationMenu = /** @class */ (function (_super) {
    station_menu_extends(StationMenu, _super);
    function StationMenu(game, dude, inventory, scene, upgrades) {
        var _this = _super.call(this, game, WIDTH * 0.5, HEIGHT * 0.5, []) || this;
        _this.upgrades = upgrades;
        _this.buttons = [];
        _this.buttons = [
            new ButtonEntity(game, 'CONSTRUCT', 0, 0, 180, 45, function () {
                var _a, _b;
                (_a = _this.station.getPage().button) === null || _a === void 0 ? void 0 : _a.action({ game: game, dude: dude, inventory: inventory, scene: scene, costs: (_b = _this.station.getPage().cost) !== null && _b !== void 0 ? _b : [], upgrades: upgrades });
            }, game.audio, 18),
            new ButtonEntity(game, '<', 0, 0, 50, 50, function () {
                if (_this.station.getPage().flip) {
                    _this.station.getPage().flip(-1);
                    scene.refreshDisplays();
                    return;
                }
                _this.station.changePage(-1);
                _this.updateButtonState;
            }, game.audio, 22),
            new ButtonEntity(game, '>', 0, 0, 50, 50, function () {
                if (_this.station.getPage().flip) {
                    _this.station.getPage().flip(1);
                    scene.refreshDisplays();
                    return;
                }
                _this.station.changePage(1);
                _this.updateButtonState();
            }, game.audio, 22)
        ];
        _this.repositionButtons();
        return _this;
    }
    StationMenu.prototype.showFor = function (station, inventory, left) {
        var _a;
        this.station = station;
        if (station)
            this.station.setUpgrades(this.upgrades);
        if (!station)
            return;
        this.p.x = WIDTH * 0.5 + 230 * (left ? -1 : 1);
        this.repositionButtons();
        (_a = this.station) === null || _a === void 0 ? void 0 : _a.prepareStorage(this.p.x, inventory);
        this.updateButtonState();
        this.buttons[1].visible = this.buttons[2].visible = station.hasMultiplePages() || !!this.station.getPage().flip;
    };
    StationMenu.prototype.updateButtonState = function () {
        var _a, _b;
        var page = this.station.getPage();
        this.buttons[0].visible = !!page.button;
        this.buttons[0].setText((_b = (_a = page.button) === null || _a === void 0 ? void 0 : _a.label) === null || _b === void 0 ? void 0 : _b.toUpperCase());
    };
    StationMenu.prototype.repositionButtons = function () {
        this.buttons[0].p = { x: this.p.x - 180 * 0.5, y: this.p.y + 150 - 50 - 20 };
        this.buttons[1].p = { x: this.p.x - 265 * 0.5 - 25, y: this.p.y - 25 - 110 };
        this.buttons[2].p = { x: this.p.x + 265 * 0.5 - 25, y: this.p.y - 25 - 110 };
    };
    StationMenu.prototype.getButtons = function () {
        return station_menu_spreadArray(station_menu_spreadArray([], this.buttons, true), this.station.getButtons(), true);
    };
    StationMenu.prototype.draw = function (ctx) {
        var _a;
        ctx.save();
        ctx.translate(this.p.x, this.p.y);
        ctx.strokeStyle = '#000';
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.rect(-125, -175, 250, 320);
        ctx.lineWidth = 8;
        ctx.fill();
        ctx.stroke();
        ctx.font = "20px ".concat(font);
        ctx.fillStyle = '#000';
        ctx.textAlign = 'center';
        var page = this.station.getPage();
        var printText = function (text, lineHeight) {
            var words = text.split(' ');
            var maxWidth = 200;
            var line = '';
            for (var n = 0; n < words.length; n++) {
                var testLine = line + words[n] + ' ';
                var metrics = ctx.measureText(testLine);
                var testWidth = metrics.width;
                if (words[n].endsWith('\n')) {
                    ctx.fillText(testLine, 0, 0);
                    ctx.translate(0, lineHeight);
                    line = '';
                    continue;
                }
                if (testWidth > maxWidth && n > 0) {
                    ctx.fillText(line, 0, 0);
                    line = words[n] + ' ';
                    ctx.translate(0, lineHeight);
                }
                else {
                    line = testLine;
                }
            }
            ctx.fillText(line, 0, 0);
            ctx.translate(0, lineHeight);
        };
        ctx.translate(0, -140);
        ctx.fillText(this.station.getName(), 0, 0);
        ctx.translate(0, 20);
        if (this.station.hasMultiplePages() || this.station.showPagination()) {
            ctx.fillStyle = '#666';
            ctx.font = "15px ".concat(font);
            ctx.translate(0, 5);
            ctx.fillText(this.station.getPagination(), 0, 0);
            ctx.translate(0, 20);
        }
        if (page.title) {
            ctx.font = "20px ".concat(font);
            ctx.fillStyle = '#000';
            ctx.translate(0, 10);
            printText(page.title.toUpperCase(), 24);
        }
        if (page.cost) {
            ctx.fillStyle = '#000';
            var lines = Math.ceil(page.cost.length / 2) * 20;
            roundRect(ctx, -80, -15, 160, 23 + lines, 10);
            ctx.fill();
            ctx.font = "10px ".concat(font);
            ctx.fillStyle = '#fff';
            ctx.fillText('MATERIALS:', 0, 0);
            ctx.font = "15px ".concat(font);
            page.cost.forEach(function (c, i) {
                ctx.translate(0, i % 2 == 0 ? 20 : 0);
                ctx.save();
                ctx.textAlign = 'left';
                if (i < page.cost.length - 1 || i % 2 === 1)
                    ctx.translate((i % 2 == 0 ? -1 : 1) * 30, 0);
                var text = "\u00D7 ".concat(c.amount);
                ctx.fillText(text, -7, 0);
                drawCircle(ctx, { x: -20, y: -5.5 }, 6, getGemColor(c.color));
                ctx.restore();
            });
            ctx.textAlign = 'center';
            ctx.translate(0, page.cost.length > 4 ? 18 : 25);
        }
        ctx.translate(0, 10);
        ctx.font = "16px ".concat(font);
        ctx.fillStyle = '#000';
        printText(page.description, 20);
        ctx.restore();
        (_a = this.station) === null || _a === void 0 ? void 0 : _a.getButtons().forEach(function (b) { return b.draw(ctx); });
        if (this.station.isDimmed()) {
            ctx.save();
            ctx.translate(this.p.x, this.p.y);
            ctx.fillStyle = '#ffffff99';
            ctx.beginPath();
            ctx.rect(-125, -175, 250, 320);
            ctx.lineWidth = 8;
            ctx.fill();
            ctx.stroke();
            ctx.font = "28px ".concat(font);
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.fillText('NO POWER', 0, 0);
            ctx.restore();
        }
        this.buttons.forEach(function (b) { return b.draw(ctx); });
    };
    return StationMenu;
}(Container));


;// CONCATENATED MODULE: ./src/station.ts
var station_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var station_assign = (undefined && undefined.__assign) || function () {
    station_assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return station_assign.apply(this, arguments);
};




var Station = /** @class */ (function (_super) {
    station_extends(Station, _super);
    function Station() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.placing = false;
        _this.blocked = false;
        _this.display = '';
        _this.displayColor = '#fff';
        _this.iconOffset = 0;
        _this.iconScale = 0.7;
        _this.powered = false;
        _this.powerSupply = false;
        _this.page = 0;
        _this.pages = [{
                title: 'Temp Station',
                description: 'Lorem ipsum dolor sit amet.'
            }];
        _this.drawTable = true;
        _this.drawScreen = true;
        _this.extraHeight = 7;
        _this.screenSize = { x: 0.8, y: 0.5 };
        _this.displayFontSize = 6;
        _this.displayOffset = 0;
        _this.requiresPower = false;
        _this.wirePos = 0;
        _this.name = 'Station';
        _this.storageButtons = [];
        return _this;
    }
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Station.prototype.postDraw = function (ctx, color) {
    };
    Station.prototype.overlapsWith = function (other, sp) {
        var a = sp;
        var b = other.p;
        var aWidth = this.s.x;
        var aHeight = this.s.y;
        var bWidth = other.s.x;
        var bHeight = other.s.y;
        return a.x < b.x + bWidth && a.x + aWidth > b.x && a.y < b.y + bHeight && a.y + aHeight > b.y;
    };
    Station.prototype.setUpgrades = function (upgrades) {
        this.upgrades = upgrades;
    };
    Station.prototype.init = function () {
        this.animationSpeed = 0.004 + Math.random() * 0.005;
    };
    Station.prototype.hasContents = function () {
        var _a;
        return (_a = this.storage) === null || _a === void 0 ? void 0 : _a.get().some(function (i) { return i && i.amount > 0; });
    };
    Station.prototype.draw = function (ctx, color, forIcon, debug) {
        ctx.save();
        if (!forIcon)
            ctx.translate(this.p.x, this.p.y);
        if (debug) {
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.strokeStyle = '#000';
            ctx.rect(-this.s.x * 0.5, -this.s.y * 0.5 - this.extraHeight, this.s.x, this.s.y + this.extraHeight);
            ctx.stroke();
        }
        // ctx.fillStyle = 'blue';
        // ctx.fillRect(-this.s.x * 0.5, -this.s.y * 0.5, this.s.x, this.s.y);
        ctx.strokeStyle = ctx.fillStyle = color;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        if (this.drawTable) {
            ctx.beginPath();
            ctx.moveTo(-this.s.x * 0.5, this.s.y * 0.15);
            ctx.lineTo(this.s.x * 0.5, this.s.y * 0.15);
            ctx.moveTo(-this.s.x * 0.4, this.s.y * 0.15);
            ctx.lineTo(-this.s.x * 0.5, this.s.y * 0.5);
            ctx.moveTo(this.s.x * 0.4, this.s.y * 0.15);
            ctx.lineTo(this.s.x * 0.5, this.s.y * 0.5);
            ctx.stroke();
        }
        this.drawExtras(ctx);
        var rise = 8;
        if (this.drawScreen) {
            ctx.strokeStyle = ctx.fillStyle = color;
            var w = this.s.x * this.screenSize.x;
            var h = this.s.y * this.screenSize.y;
            var rim = 1.5;
            ctx.fillRect(-2, -rise, 4, rise);
            ctx.fillRect(-this.s.x * 0.3, -2, this.s.x * 0.6, 4);
            ctx.fillRect(-w * 0.5, -h * 0.5 - rise, w, h);
            ctx.fillStyle = '#00000077';
            ctx.fillRect(-w * 0.5 + rim, -h * 0.5 + rim - rise, w - rim * 2, h - rim * 2);
        }
        ctx.fillStyle = this.displayColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = "".concat(this.displayFontSize, "px monospace");
        if (!this.requiresPower || this.powered) {
            ctx.fillText(this.display, 0, -rise + this.displayOffset);
        }
        if (this.placing && this.blocked && !forIcon) {
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            var size = 3;
            ctx.translate(0, 3);
            var s = this.animationPhaseAbs * 0.3 + 1;
            ctx.scale(s, s);
            ctx.moveTo(-size, -size);
            ctx.lineTo(size, size);
            ctx.moveTo(size, -size);
            ctx.lineTo(-size, size);
            ctx.stroke();
        }
        ctx.restore();
    };
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Station.prototype.open = function (scene) {
    };
    Station.prototype.isDimmed = function () {
        return this.requiresPower && !this.powered;
    };
    Station.prototype.needsPower = function () {
        return this.requiresPower;
    };
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Station.prototype.recycle = function (entering) {
    };
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Station.prototype.refreshDisplay = function (counts) {
    };
    Station.prototype.prepareStorage = function (p, inventory) {
        var _this = this;
        if (!this.storage)
            return;
        var items = this.storage.get();
        var rows = Math.ceil(items.length / 5);
        this.storageButtons = items.map(function (item, i) {
            var _a;
            var x = (i % 5) * 40 - 80;
            var y = -(rows - 1) * 40 + Math.floor(i / 5) * 40;
            var btn = new ToolbarButton(_this.game, null, null, item === null || item === void 0 ? void 0 : item.color, p + x, HEIGHT * 0.5 + 105 + y, function (right) {
                var ii = _this.storage.get()[i];
                if (!ii)
                    return;
                inventory.addItem(station_assign(station_assign({}, ii), { amount: right ? 1 : ii.amount }), ii, inventory.getDude());
                _this.storage.clearEmpties();
                _this.storage.updateButtons(_this.storageButtons);
            });
            btn.setAmount((_a = item === null || item === void 0 ? void 0 : item.amount) !== null && _a !== void 0 ? _a : 0);
            return btn;
        });
        this.storage.updateButtons(this.storageButtons);
    };
    Station.prototype.consume = function (costs) {
        if (this.storage) {
            this.storage.consume(costs);
            this.storage.updateButtons(this.storageButtons);
        }
    };
    Station.prototype.getItems = function () {
        return this.storage ? this.storage.get() : [];
    };
    Station.prototype.pick = function () {
        this.powered = false;
    };
    Station.prototype.canStore = function () {
        return !!this.storage;
    };
    Station.prototype.store = function (item, from, dude) {
        if (!this.storage)
            return;
        this.storage.add(item, from, dude);
        this.storage.updateButtons(this.storageButtons);
    };
    Station.prototype.getButtons = function () {
        return this.storageButtons;
    };
    Station.prototype.getPagination = function () {
        return "".concat(this.page + 1, "/").concat(this.getPages().length);
    };
    Station.prototype.showPagination = function () {
        return false;
    };
    Station.prototype.getPages = function () {
        var _this = this;
        return this.pages.filter(function (p) { return !p.visible || p.visible(_this.upgrades); });
    };
    Station.prototype.changePage = function (dir) {
        this.page += dir;
        if (this.page < 0) {
            this.page = this.getPages().length - 1;
        }
        else if (this.page >= this.getPages().length) {
            this.page = 0;
        }
    };
    Station.prototype.getName = function () {
        return this.name;
    };
    Station.prototype.getPage = function () {
        return this.getPages()[this.page];
    };
    Station.prototype.hasMultiplePages = function () {
        return this.getPages().length > 1;
    };
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Station.prototype.drawExtras = function (ctx) {
    };
    Station.prototype.canAdd = function (item) {
        return this.storage && this.storage.canAdd(item);
    };
    Station.prototype.updateStatus = function (scene, rootRaw) {
        var root = offset(rootRaw, this.p.x, this.p.y);
        if (scene.isCloseToStation(this, root)) {
            this.blocked = true;
            return;
        }
        var right = scene.isGround(root.x + this.s.x * 0.5, root.y + this.s.y * 0.5 + 1);
        var left = scene.isGround(root.x - this.s.x * 0.5, root.y + this.s.y * 0.5 + 1);
        var bottomRight = scene.isGround(root.x + this.s.x * 0.5, root.y + this.s.y * 0.5 - 3);
        var bottomLeft = scene.isGround(root.x - this.s.x * 0.5, root.y + this.s.y * 0.5 - 3);
        var midRight = scene.isGround(root.x + this.s.x * 0.5, root.y);
        var midLeft = scene.isGround(root.x - this.s.x * 0.5, root.y);
        var topRight = scene.isGround(root.x + this.s.x * 0.5, root.y - this.s.y * 0.5 - this.extraHeight);
        var topLeft = scene.isGround(root.x - this.s.x * 0.5, root.y - this.s.y * 0.5 - this.extraHeight);
        this.blocked = !(right && left) || midRight || midLeft || topRight || topLeft || bottomRight || bottomLeft;
    };
    Station.prototype.serializeExtras = function () {
        return '';
    };
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    Station.prototype.deserializeExtras = function (data) {
    };
    return Station;
}(Entity));


;// CONCATENATED MODULE: ./src/stations/texts.ts
var itemTexts = {
    trash: {
        name: 'Trash',
        shorter: 'You can trash stuff to get rid of it. Beware, they will be lost forever.',
        description: 'You can put stuff here to get rid of it. Beware, they will be lost forever.'
    },
    storage: {
        name: 'Storage',
        shorter: 'You can store items in one for safe keeping.',
        description: 'You can store items here for safe keeping and take them out when you need them. You can craft with items inside storage containers too.'
    },
    display: {
        name: 'Display Station',
        shorter: 'This station will display the amount of gems in your storage.',
        description: 'This station will display the amount of selected gems in all of your storage containers.'
    },
    decrypter: {
        name: 'Deciphering Station',
        shorter: 'Can be used to decipher encrypted messages.',
        description: 'Can be used to decipher encrypted messages. The cost of deciphering will change with each use.'
    },
    gambler: {
        name: 'Gambler Station',
        shorter: 'Can double or nothing the materials placed inside.',
        description: 'Either doubles the amounts of different materials placed inside or destroys them every time your return to the ship.'
    },
    power: {
        name: 'Power Supply',
        shorter: 'Provides power to nearby stations.',
        description: 'Some stations require additional power to function. This station provides power to such stations though the range is limited.'
    },
    teleporter: {
        name: 'Teleporter',
        shorter: 'Instantly teleports you to closest other teleporter.',
        description: 'Instantly teleports you to closest other teleporter.'
    },
    robotics: {
        name: 'Robotics Station',
        shorter: 'Allows you to craft advanced power requiring stations.',
        description: 'Allows you to craft advanced power requiring stations.'
    },
    stacker: {
        name: 'Auto Stacker',
        shorter: 'Will automatically store your gems in nearby storage containers.',
        description: 'Will automatically store your gems in nearby storage containers when you return to the ship. \n \n Only stacks to containers that already have the same color gems inside.'
    },
    forcer: {
        name: 'Reality Sculptor',
        shorter: 'This station is able to tap into the fabric of reality ifself.',
        description: 'This station taps into the fabric of reality and can change the world around you. \n \n [X].',
    },
    gems: {
        name: 'Gem Database',
        shorter: 'Contains all known information about gemstones found around the world.',
        description: '',
    },
    converter: {
        name: 'Converter',
        shorter: 'Converts all the gems inside to other type of gems.',
        description: 'Converts all the gems inside to other type of gems. Half of the gems will be destroyed in the process.',
    },
    tweaker: {
        name: 'Size Tweaker',
        shorter: 'Allows you to change the size of your pick and paint roller.',
        description: 'Allows you to change the size of your pick and paint roller.',
    },
};

;// CONCATENATED MODULE: ./src/stations/trash.ts
var trash_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var TrashStation = /** @class */ (function (_super) {
    trash_extends(TrashStation, _super);
    function TrashStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = itemTexts.trash.name;
        _this.drawTable = false;
        _this.drawScreen = false;
        _this.extraHeight = -5;
        _this.iconOffset = 1;
        _this.display = '()';
        _this.displayOffset = 12;
        _this.displayColor = '#ffffff33';
        _this.storage = new Inventory(5);
        _this.pages = [
            {
                description: itemTexts.trash.description,
            }
        ];
        return _this;
    }
    TrashStation.prototype.drawExtras = function (ctx) {
        ctx.beginPath();
        ctx.moveTo(-5, 11);
        ctx.lineTo(5, 11);
        ctx.lineTo(7, -2);
        ctx.lineTo(-7, -2);
        ctx.closePath();
        ctx.fill();
    };
    TrashStation.prototype.recycle = function () {
        this.storage.clear();
        this.storage.updateButtons(this.getButtons());
    };
    return TrashStation;
}(Station));


;// CONCATENATED MODULE: ./src/words.ts
var threeLetterWords = ['aah', 'aal', 'aas', 'aba', 'abs', 'aby', 'ace', 'ack', 'act', 'add', 'ado', 'ads', 'adz', 'aff', 'aft', 'aga', 'age', 'ago', 'ags', 'aha', 'ahi', 'ahs', 'aid', 'ail', 'aim', 'ain', 'air', 'ais', 'ait', 'aji', 'ala', 'alb', 'ale', 'all', 'alp', 'als', 'alt', 'ama', 'ami', 'amp', 'amu', 'ana', 'and', 'ane', 'ani', 'ant', 'any', 'ape', 'apo', 'app', 'apt', 'arb', 'arc', 'are', 'arf', 'ark', 'arm', 'aro', 'ars', 'art', 'ash', 'ask', 'asp', 'ass', 'ate', 'ats', 'att', 'auk', 'ava', 'ave', 'avo', 'awa', 'awe', 'awl', 'awn', 'axe', 'aye', 'ays', 'azo', 'baa', 'bad', 'bae', 'bag', 'bah', 'bal', 'bam', 'ban', 'bap', 'bar', 'bas', 'bat', 'bay', 'bed', 'bee', 'beg', 'bel', 'ben', 'bes', 'bet', 'bey', 'bib', 'bid', 'big', 'bin', 'bio', 'bis', 'bit', 'biz', 'boa', 'bob', 'bod', 'bog', 'boo', 'bop', 'bos', 'bot', 'bow', 'box', 'boy', 'bra', 'bro', 'brr', 'bub', 'bud', 'bug', 'bum', 'bun', 'bur', 'bus', 'but', 'buy', 'bye', 'bys', 'cab', 'cad', 'caf', 'cam', 'can', 'cap', 'car', 'cat', 'caw', 'cay', 'cee', 'cel', 'ceo', 'cep', 'chi', 'cia', 'cig', 'cis', 'cob', 'cod', 'cog', 'col', 'con', 'coo', 'cop', 'cor', 'cos', 'cot', 'cow', 'cox', 'coy', 'coz', 'cru', 'cry', 'cub', 'cud', 'cue', 'cum', 'cup', 'cur', 'cut', 'cuz', 'cwm', 'dab', 'dad', 'dag', 'dah', 'dak', 'dal', 'dam', 'dan', 'dap', 'das', 'daw', 'day', 'deb', 'dee', 'def', 'del', 'den', 'dep', 'dev', 'dew', 'dex', 'dey', 'dib', 'did', 'die', 'dif', 'dig', 'dim', 'din', 'dip', 'dis', 'dit', 'doc', 'doe', 'dog', 'doh', 'dol', 'dom', 'don', 'dor', 'dos', 'dot', 'dow', 'dox', 'dry', 'dub', 'dud', 'due', 'dug', 'duh', 'dui', 'dum', 'dun', 'duo', 'dup', 'dye', 'ear', 'eat', 'eau', 'ebb', 'eco', 'ecu', 'edh', 'eds', 'eek', 'eel', 'eew', 'eff', 'efs', 'eft', 'egg', 'ego', 'eke', 'eld', 'elf', 'elk', 'ell', 'elm', 'els', 'eme', 'emo', 'ems', 'emu', 'end', 'eng', 'ens', 'eon', 'era', 'ere', 'erg', 'ern', 'err', 'ers', 'ess', 'est', 'eta', 'eth', 'eve', 'ewe', 'eye', 'fab', 'fad', 'fae', 'fah', 'fam', 'fan', 'far', 'fas', 'fat', 'fav', 'fax', 'fay', 'fed', 'fee', 'feh', 'fen', 'fer', 'fes', 'fet', 'feu', 'few', 'fey', 'fez', 'fib', 'fid', 'fie', 'fig', 'fil', 'fin', 'fir', 'fit', 'fix', 'fiz', 'flu', 'fly', 'fob', 'foe', 'fog', 'foh', 'fon', 'foo', 'fop', 'for', 'fou', 'fox', 'foy', 'fro', 'fry', 'fub', 'fud', 'fug', 'fun', 'fur', 'gab', 'gad', 'gae', 'gag', 'gal', 'gam', 'gan', 'gap', 'gar', 'gas', 'gat', 'gay', 'ged', 'gee', 'gel', 'gem', 'gen', 'get', 'gey', 'ghi', 'gib', 'gid', 'gie', 'gif', 'gig', 'gin', 'gis', 'git', 'gnu', 'goa', 'gob', 'god', 'goo', 'gor', 'gos', 'got', 'gox', 'grr', 'gul', 'gum', 'gun', 'gut', 'guv', 'guy', 'gym', 'had', 'hae', 'hag', 'hah', 'haj', 'ham', 'hao', 'hap', 'has', 'hat', 'haw', 'hay', 'heh', 'hem', 'hen', 'hep', 'her', 'hes', 'het', 'hew', 'hex', 'hey', 'hic', 'hid', 'hie', 'him', 'hin', 'hip', 'his', 'hit', 'hmm', 'hob', 'hod', 'hoe', 'hog', 'hom', 'hon', 'hoo', 'hop', 'hot', 'how', 'hoy', 'hub', 'hue', 'hug', 'huh', 'hum', 'hun', 'hup', 'hut', 'hyp', 'ice', 'ich', 'ick', 'icy', 'ids', 'iff', 'ifs', 'igg', 'ilk', 'ill', 'imp', 'ink', 'inn', 'ins', 'ion', 'ire', 'irk', 'ism', 'its', 'ivy', 'jab', 'jag', 'jam', 'jar', 'jaw', 'jay', 'jee', 'jet', 'jeu', 'jib', 'jig', 'jin', 'job', 'joe', 'jog', 'jot', 'jow', 'joy', 'jug', 'jun', 'jus', 'jut', 'kab', 'kae', 'kaf', 'kas', 'kat', 'kay', 'kea', 'kef', 'keg', 'ken', 'kep', 'kex', 'key', 'khi', 'kid', 'kif', 'kin', 'kip', 'kir', 'kis', 'kit', 'koa', 'kob', 'koi', 'kop', 'kor', 'kos', 'kue', 'kye', 'lab', 'lac', 'lad', 'lag', 'lah', 'lam', 'lap', 'lar', 'las', 'lat', 'lav', 'law', 'lax', 'lay', 'lea', 'led', 'lee', 'leg', 'lei', 'lek', 'leo', 'let', 'leu', 'lev', 'lex', 'ley', 'lib', 'lid', 'lie', 'lin', 'lip', 'lis', 'lit', 'lob', 'log', 'loo', 'lop', 'lot', 'low', 'lox', 'lub', 'lud', 'lug', 'lum', 'lun', 'luv', 'lux', 'lye', 'mac', 'mad', 'mae', 'mag', 'mam', 'man', 'map', 'mar', 'mas', 'mat', 'maw', 'max', 'may', 'med', 'meg', 'meh', 'mel', 'mem', 'men', 'met', 'mew', 'mho', 'mib', 'mic', 'mid', 'mig', 'mil', 'mim', 'mir', 'mis', 'mix', 'mmm', 'moa', 'mob', 'moc', 'mod', 'mog', 'moi', 'mol', 'mom', 'mon', 'moo', 'mop', 'mor', 'mos', 'mot', 'mow', 'mud', 'mug', 'mum', 'mun', 'mus', 'mut', 'mux', 'myc', 'nab', 'nae', 'nag', 'nah', 'nam', 'nan', 'nap', 'nav', 'naw', 'nay', 'neb', 'nee', 'neg', 'net', 'new', 'nib', 'nil', 'nim', 'nip', 'nit', 'nix', 'nob', 'nod', 'nog', 'noh', 'nom', 'noo', 'nor', 'nos', 'not', 'now', 'nth', 'nub', 'nug', 'nun', 'nus', 'nut', 'oaf', 'oak', 'oar', 'oat', 'oba', 'obe', 'obi', 'oca', 'och', 'oda', 'odd', 'ode', 'ods', 'oes', 'off', 'oft', 'ohm', 'oho', 'ohs', 'oik', 'oil', 'oka', 'oke', 'old', 'ole', 'oma', 'oms', 'one', 'ono', 'ons', 'oof', 'ooh', 'oot', 'opa', 'ope', 'ops', 'opt', 'ora', 'orb', 'orc', 'ore', 'org', 'ors', 'ort', 'ose', 'oud', 'our', 'out', 'ova', 'owe', 'owl', 'own', 'owt', 'oxo', 'oxy', 'pac', 'pad', 'pah', 'pak', 'pal', 'pam', 'pan', 'pap', 'par', 'pas', 'pat', 'paw', 'pax', 'pay', 'pea', 'pec', 'ped', 'pee', 'peg', 'peh', 'pen', 'pep', 'per', 'pes', 'pet', 'pew', 'phi', 'pho', 'pht', 'pia', 'pic', 'pie', 'pig', 'pin', 'pip', 'pis', 'pit', 'piu', 'pix', 'ply', 'pod', 'poh', 'poi', 'pol', 'pom', 'poo', 'pop', 'pos', 'pot', 'pow', 'pox', 'pro', 'pry', 'psi', 'pst', 'pub', 'pud', 'pug', 'pul', 'pun', 'pup', 'pur', 'pus', 'put', 'pya', 'pye', 'pyx', 'qat', 'qis', 'qua', 'rad', 'rag', 'rah', 'rai', 'raj', 'ram', 'ran', 'rap', 'ras', 'rat', 'raw', 'rax', 'ray', 'reb', 'rec', 'red', 'ree', 'ref', 'reg', 'rei', 'rem', 'rep', 'res', 'ret', 'rev', 'rex', 'rez', 'rho', 'ria', 'rib', 'rid', 'rif', 'rig', 'rim', 'rin', 'rip', 'rob', 'roc', 'rod', 'roe', 'rom', 'roo', 'rot', 'row', 'rub', 'rue', 'rug', 'rum', 'run', 'rut', 'rya', 'rye', 'ryu', 'sab', 'sac', 'sad', 'sae', 'sag', 'sal', 'san', 'sap', 'sat', 'sau', 'saw', 'sax', 'say', 'sea', 'sec', 'see', 'sei', 'sel', 'sen', 'ser', 'set', 'sev', 'sew', 'sex', 'sha', 'she', 'shh', 'sho', 'shy', 'sib', 'sic', 'sig', 'sim', 'sin', 'sip', 'sir', 'sis', 'sit', 'six', 'ska', 'ski', 'sky', 'sly', 'sob', 'soc', 'sod', 'soh', 'sol', 'som', 'son', 'sop', 'sos', 'sot', 'sou', 'sow', 'sox', 'soy', 'spa', 'spy', 'sri', 'sty', 'sub', 'sue', 'suk', 'sum', 'sun', 'sup', 'suq', 'sus', 'syn', 'tab', 'tad', 'tae', 'tag', 'taj', 'tam', 'tan', 'tao', 'tap', 'tar', 'tas', 'tat', 'tau', 'tav', 'taw', 'tax', 'tea', 'tec', 'ted', 'tee', 'teg', 'tel', 'ten', 'tes', 'tet', 'tew', 'the', 'tho', 'thy', 'tic', 'tie', 'til', 'tin', 'tip', 'tis', 'tit', 'tix', 'tiz', 'tod', 'toe', 'tog', 'tom', 'ton', 'too', 'top', 'tor', 'tot', 'tow', 'toy', 'try', 'tsk', 'tub', 'tug', 'tui', 'tum', 'tun', 'tup', 'tut', 'tux', 'twa', 'two', 'tye', 'udo', 'ugh', 'uke', 'ulu', 'umm', 'ump', 'ums', 'uni', 'uns', 'upo', 'ups', 'urb', 'urd', 'urn', 'urp', 'usa', 'use', 'uta', 'ute', 'uts', 'vac', 'van', 'var', 'vas', 'vat', 'vau', 'vav', 'vaw', 'vax', 'vee', 'veg', 'vet', 'vex', 'via', 'vid', 'vie', 'vig', 'vim', 'vin', 'vis', 'voe', 'vog', 'vow', 'vox', 'vug', 'vum', 'wab', 'wad', 'wae', 'wag', 'wan', 'wap', 'war', 'was', 'wat', 'waw', 'wax', 'way', 'web', 'wed', 'wee', 'wen', 'wet', 'wha', 'who', 'why', 'wig', 'win', 'wis', 'wit', 'wiz', 'woe', 'wok', 'won', 'woo', 'wos', 'wot', 'wow', 'wry', 'wud', 'wye', 'wyn', 'xis', 'yag', 'yah', 'yak', 'yam', 'yap', 'yar', 'yas', 'yaw', 'yay', 'yea', 'yeh', 'yen', 'yep', 'yes', 'yet', 'yew', 'yin', 'yip', 'yob', 'yod', 'yok', 'yom', 'yon', 'you', 'yow', 'yuk', 'yum', 'yup', 'zag', 'zap', 'zas', 'zax', 'zed', 'zee', 'zek', 'zen', 'zep', 'zig', 'zin', 'zip', 'zit', 'zoa', 'zoo', 'zuz', 'zzz'];
// const counts = {};
// threeLetterWords.forEach(word => {
//     word.split('').forEach(letter => {
//         if (!counts[letter]) {
//             counts[letter] = 0;
//         }
//         counts[letter]++;
//     });
// });
// console.log(Object.keys(counts).sort((a, b) => counts[b] - counts[a]).map(letter => `${letter}: ${counts[letter]}`));

;// CONCATENATED MODULE: ./src/stations/info.ts
var info_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




var InfoStation = /** @class */ (function (_super) {
    info_extends(InfoStation, _super);
    function InfoStation(game, x, y, title) {
        var _this = _super.call(this, game, x, y, 20, 20) || this;
        _this.title = title;
        _this.name = '';
        _this.pages = [];
        _this.iconOffset = 5;
        _this.iconScale = 0.6;
        _this.name = title;
        return _this;
    }
    InfoStation.prototype.open = function () {
        if (this.display == '!!') {
            this.display = '';
        }
    };
    InfoStation.prototype.serializeExtras = function () {
        return this.title;
    };
    InfoStation.prototype.drawExtras = function (ctx) {
        if (this.name === itemTexts.gems.name) {
            ctx.save();
            ctx.translate(0, 2);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-7, -8);
            ctx.lineTo(-5, -21);
            ctx.moveTo(7, -8);
            ctx.lineTo(5, -21);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, -16);
            ctx.lineTo(8, -25);
            ctx.lineTo(3, -28);
            ctx.lineTo(-3, -28);
            ctx.lineTo(-8, -25);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }
    };
    InfoStation.prototype.deserializeExtras = function (data) {
        if (!data)
            return;
        this.title = data;
        this.pages = [{
                title: 'Unknown',
                description: 'This thing should not exist!'
            }];
        if (data === 'Basics') {
            this.pages = [
                {
                    title: 'Getting started',
                    description: 'This ship will serve as your base of operations. \n \n Your first priority should be to build the bridge tool at the crafting station.'
                },
                {
                    title: 'Teleporting',
                    description: 'If you fail an expedition, you\'ll lose half of your gathered resources. To avoid this, teleport back to the ship using the portable teleporter.'
                },
                {
                    title: 'Pickaxe',
                    description: 'The pickaxe is your best friend on expeditions. It can be used to mine through granite and loosen precious gemstones that are used as material in crafting.'
                },
                {
                    title: 'Bridge Tool',
                    description: 'The bridge tool is an essential piece of gear that requires granite as fuel. You can use the bridge tool to get to hard to reach places to gather more resources.'
                },
                {
                    title: 'SHORT RANGE TELEPORT',
                    description: 'Allows you to teleport short distances by pressing Q. Can only be used once before requiring a recharge back at the ship.',
                    visible: function (u) { return u.canWarp; }
                }
            ];
        }
        if (data === itemTexts.gems.name) {
            this.iconScale = 0.38;
            this.iconOffset = 8;
            this.screenSize = { x: 1, y: 0.5 };
            this.extraHeight = 15;
            this.pages = gems.map(function (g) { return ({
                title: getGemName(g),
                description: getGemDescription(g),
                cost: [{
                        amount: 1,
                        color: g
                    }]
            }); });
        }
        if (data === 'Cockpit') {
            this.pages = [
                {
                    title: 'Advanced Crafting',
                    description: 'Upgrade station is your key for unlocking more advanced crafting recipes. It is situated in the back of the ship.'
                },
                {
                    title: 'Gems',
                    description: 'Different worlds contain different gems. The letters of the worlds seem to be a hint to what can be found there. The gem database holds more details on the subject.'
                },
                {
                    title: 'Control',
                    description: 'There is a way to have some control over the worlds you visit. There is a special station recipe in the robotics bay that can be used to control the world.'
                },
                {
                    title: 'Special Worlds',
                    description: 'There are tales of special worls that contain peculiar objects. Those weird objects must contain the key to unlocking the secrets of the universe.'
                },
                {
                    title: 'Encrypted Message',
                    description: ENCRYPTED_MESSAGE
                }
            ];
        }
    };
    return InfoStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/storage.ts
var storage_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var StorageStation = /** @class */ (function (_super) {
    storage_extends(StorageStation, _super);
    function StorageStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = itemTexts.storage.name;
        _this.drawTable = false;
        _this.drawScreen = false;
        _this.extraHeight = 0;
        _this.iconOffset = 4;
        _this.iconScale = 0.65;
        _this.storage = new Inventory(10);
        _this.pages = [
            {
                description: itemTexts.storage.description,
            }
        ];
        return _this;
    }
    StorageStation.prototype.changeSize = function (size) {
        this.storage = new Inventory(size);
    };
    StorageStation.prototype.serializeExtras = function () {
        return [this.s.x, this.s.y].join(',');
    };
    StorageStation.prototype.deserializeExtras = function (data) {
        if (!data || data === 'NaN,NaN')
            return;
        var _a = data.split(','), x = _a[0], y = _a[1];
        if (!x || !y)
            return;
        this.s = { x: parseInt(x), y: parseInt(y) };
    };
    StorageStation.prototype.fill = function (count) {
        this.storage.fill(count);
    };
    StorageStation.prototype.drawExtras = function (ctx) {
        ctx.save();
        ctx.translate(0, 1);
        ctx.fillRect(-this.s.x * 0.5, -this.s.y * 0.5, this.s.x, this.s.y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 0.5;
        var rim = 2;
        ctx.beginPath();
        ctx.strokeRect(-this.s.x * 0.5 + rim, -this.s.y * 0.5 + rim, this.s.x - rim * 2, this.s.y - rim * 2);
        ctx.moveTo(0, -this.s.y * 0.5 + rim);
        ctx.lineTo(0, this.s.y * 0.5 - rim);
        ctx.stroke();
        ctx.restore();
    };
    return StorageStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/display.ts
var display_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




var DisplayStation = /** @class */ (function (_super) {
    display_extends(DisplayStation, _super);
    function DisplayStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = itemTexts.display.name;
        _this.screenSize = { x: 1.2, y: 0.8 };
        _this.displayOffset = 1.25;
        _this.displayFontSize = 8;
        _this.iconOffset = 6.5;
        _this.iconScale = 0.52;
        _this.display = '0';
        _this.pages = [
            {
                description: itemTexts.display.description,
                flip: function (dir) { return _this.flip(dir); }
            }
        ];
        _this.cur = 0;
        return _this;
    }
    DisplayStation.prototype.drawExtras = function (ctx) {
        ctx.lineWidth = 2;
        drawCircle(ctx, { x: 0, y: -16 }, 5, getGemColor(gems[this.cur]), ctx.strokeStyle);
    };
    DisplayStation.prototype.showPagination = function () {
        return true;
    };
    DisplayStation.prototype.getPagination = function () {
        return "".concat(this.cur + 1, "/").concat(gems.length);
    };
    DisplayStation.prototype.postDraw = function (ctx, color) {
        ctx.save();
        ctx.translate(this.p.x, this.p.y);
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        // drawCircle(ctx, { x: 0, y: -15 }, 5, gems[this.cur], color);
        ctx.beginPath();
        ctx.ellipse(0, -16, 5, 5, 0, Math.PI, 0);
        ctx.strokeStyle = color;
        ctx.fillStyle = getGemColor(gems[this.cur]);
        ctx.fill();
        ctx.stroke();
        ctx.restore();
    };
    DisplayStation.prototype.serializeExtras = function () {
        return this.cur.toString();
    };
    DisplayStation.prototype.deserializeExtras = function (data) {
        this.cur = parseInt(data, 10);
        if (isNaN(this.cur))
            this.cur = 0;
    };
    DisplayStation.prototype.refreshDisplay = function (counts) {
        var _a;
        this.display = ((_a = counts[gems[this.cur]]) === null || _a === void 0 ? void 0 : _a.toString()) || '0';
        this.pages[0].description = itemTexts.display.description + ' \n \n Currenlty displaying the ' + getGemName(gems[this.cur]).toLowerCase() + ' count.';
    };
    DisplayStation.prototype.flip = function (dir) {
        this.cur += dir;
        if (this.cur < 0)
            this.cur = gems.length - 1;
        if (this.cur >= gems.length)
            this.cur = 0;
        // this.displayColor = gemColors[this.cur];
    };
    return DisplayStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/decrypter.ts
var decrypter_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




var DecrypterStation = /** @class */ (function (_super) {
    decrypter_extends(DecrypterStation, _super);
    function DecrypterStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = itemTexts.decrypter.name;
        _this.drawScreen = false;
        _this.drawTable = false;
        _this.iconScale = 0.4;
        _this.iconOffset = 7;
        _this.extraHeight = 20;
        _this.pages = [
            {
                title: 'Decrypt',
                description: itemTexts.decrypter.description,
                cost: randomCost(5, 1 + Math.round(Math.random())),
                button: {
                    label: 'Run',
                    action: function (args) {
                        if (args.scene.craft(null, args.costs)) {
                            args.scene.decrypt();
                            _this.randomizeCost();
                        }
                    }
                }
            }
        ];
        return _this;
    }
    DecrypterStation.prototype.randomizeCost = function () {
        this.pages[0].cost = randomCost(5, 1 + Math.round(Math.random()));
    };
    DecrypterStation.prototype.drawExtras = function (ctx) {
        this.animationSpeed = 0.002;
        ctx.save();
        fillRect(ctx, 0, 0, 10, 22);
        fillRect(ctx, 0, 0, 14, 10);
        drawCircle(ctx, { x: 0, y: -13 }, 5);
        ctx.translate(0, -18);
        ctx.beginPath();
        ctx.rotate(this.animationPhase * 0.3);
        ctx.ellipse(0, -6, 7, 7, 0, 0, Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.lineWidth = 2;
        ctx.moveTo(0, 0);
        ctx.lineTo(0, -12);
        ctx.stroke();
        ctx.restore();
    };
    return DecrypterStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/power.ts
var power_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




var PowerStation = /** @class */ (function (_super) {
    power_extends(PowerStation, _super);
    function PowerStation(game, x, y) {
        var _this = _super.call(this, game, x, y, 5, 20) || this;
        _this.name = itemTexts.power.name;
        _this.drawScreen = false;
        _this.drawTable = false;
        _this.iconScale = 0.8;
        _this.iconOffset = 2;
        _this.powerSupply = true;
        _this.extraHeight = -2;
        _this.pages = [
            {
                description: itemTexts.power.description,
            }
        ];
        _this.attached = [];
        return _this;
    }
    PowerStation.prototype.attach = function (others) {
        this.attached = others.map(function (s) { return offset(s.p, 0, s.wirePos); });
    };
    PowerStation.prototype.getPagination = function () {
        return "POWERING ".concat(this.attached.length);
    };
    PowerStation.prototype.showPagination = function () {
        return true;
    };
    PowerStation.prototype.drawExtras = function (ctx) {
        var _this = this;
        ctx.save();
        fillRect(ctx, 0, 1, 8, 9);
        ctx.beginPath();
        ctx.lineWidth = 2;
        ctx.moveTo(0, 11);
        ctx.lineTo(0, -5);
        ctx.stroke();
        if (!this.placing) {
            ctx.beginPath();
            ctx.lineWidth = 1.5;
            this.attached.forEach(function (v) {
                ctx.moveTo(0, 0);
                var tp = offset(v, -_this.p.x, -_this.p.y);
                ctx.quadraticCurveTo(tp.x * 0.4, tp.y * 0.5 + 15, tp.x, tp.y);
                ctx.stroke();
            });
            ctx.stroke();
        }
        ctx.restore();
    };
    PowerStation.prototype.pick = function () {
        this.attached = [];
    };
    return PowerStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/teleporter.ts
var teleporter_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var TeleporterStation = /** @class */ (function (_super) {
    teleporter_extends(TeleporterStation, _super);
    function TeleporterStation(game, x, y) {
        var _this = _super.call(this, game, x, y, 26, 18) || this;
        _this.name = itemTexts.teleporter.name;
        _this.drawScreen = false;
        _this.drawTable = false;
        _this.iconScale = 0.6;
        _this.iconOffset = 4;
        _this.requiresPower = true;
        _this.wirePos = 7;
        _this.pages = [
            {
                description: itemTexts.teleporter.description,
            }
        ];
        return _this;
    }
    TeleporterStation.prototype.open = function (scene) {
        var _this = this;
        if (!this.powered)
            return;
        var match = scene.getTeleporters().filter(function (s) { return s !== _this && s.powered; }).sort(function (a, b) { return distance(a.p, _this.p) - distance(b.p, _this.p); })[0];
        if (match) {
            scene.getDude().teleportTo(offset(match.p, 0, scene.isInBase() ? HEIGHT : 0 + 10));
            scene.toggleStationMenu();
        }
    };
    TeleporterStation.prototype.drawExtras = function (ctx) {
        ctx.save();
        fillRect(ctx, 0, 9, 18, 6);
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.ellipse(0, -1, 10, 10, 0, 0, Math.PI * 2);
        ctx.stroke();
        ctx.restore();
    };
    return TeleporterStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/stacker.ts
var stacker_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var StackerStation = /** @class */ (function (_super) {
    stacker_extends(StackerStation, _super);
    function StackerStation(game, x, y) {
        var _this = _super.call(this, game, x, y, 5, 20) || this;
        _this.name = itemTexts.stacker.name;
        _this.drawScreen = false;
        _this.drawTable = false;
        _this.iconScale = 0.6;
        _this.iconOffset = 5;
        _this.requiresPower = true;
        _this.wirePos = -15;
        _this.pages = [
            {
                description: itemTexts.stacker.description,
            }
        ];
        return _this;
    }
    StackerStation.prototype.init = function () {
        this.animationSpeed = 0.002;
    };
    StackerStation.prototype.update = function (tick, mouse) {
        if (this.powered)
            _super.prototype.update.call(this, tick, mouse);
    };
    StackerStation.prototype.drawExtras = function (ctx) {
        ctx.save();
        fillRect(ctx, 0, 3 + this.animationPhase * 5, 10, 5);
        fillRect(ctx, 0, 3 - this.animationPhase * 5, 10, 5);
        ctx.beginPath();
        ctx.lineWidth = 6;
        ctx.moveTo(0, 10);
        ctx.lineTo(0, -5);
        ctx.stroke();
        ctx.lineWidth = 1.5;
        ctx.moveTo(0, 0);
        ctx.lineTo(0, -15);
        ctx.stroke();
        // ctx.translate(0, -7);
        // ctx.rotate(this.animationPhase * Math.PI);
        // ctx.lineWidth = 4;
        // ctx.beginPath();
        // ctx.ellipse(0, 0, 4, 4, 0, 0, Math.PI * 2);
        // ctx.stroke();
        // const od = 5;
        // ctx.lineWidth = 4;
        // ctx.beginPath();
        // ctx.lineCap = 'round';
        // for (let i = 0; i < 8; i++) {
        //     const angle = (Math.PI * 2) / 8 * i;
        //     const x = Math.cos(angle) * od;
        //     const y = Math.sin(angle) * od;
        //     ctx.moveTo(x, y);
        //     ctx.lineTo(x, y);
        // }
        // ctx.stroke();
        // ctx.lineCap = 'round';
        ctx.restore();
    };
    return StackerStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/forcer.ts
var forcer_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var letters = '?ABCDEFGHIJKLMNOPQRSTUVWXYZ';
var ForcerStation = /** @class */ (function (_super) {
    forcer_extends(ForcerStation, _super);
    function ForcerStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = itemTexts.forcer.name;
        _this.screenSize = { x: 1.2, y: 0.8 };
        _this.displayOffset = 1.25;
        _this.displayFontSize = 8;
        _this.iconOffset = 6.5;
        _this.iconScale = 0.52;
        _this.display = '0';
        _this.requiresPower = true;
        _this.pages = [
            {
                description: itemTexts.forcer.description,
                flip: function (dir) { return _this.flip(dir); },
                button: {
                    label: 'Clear',
                    action: function () {
                        _this.cur = 0;
                        _this.refreshDisplay();
                    }
                }
            }
        ];
        _this.cur = 0;
        return _this;
    }
    ForcerStation.prototype.drawExtras = function (ctx) {
        ctx.lineWidth = 2;
        ctx.moveTo(3, -16);
        ctx.lineTo(8, -16 - 5);
        ctx.moveTo(-3, -16);
        ctx.lineTo(-8, -16 - 5);
        ctx.stroke();
    };
    ForcerStation.prototype.showPagination = function () {
        return true;
    };
    ForcerStation.prototype.getPagination = function () {
        return "".concat(this.cur + 1, "/").concat(letters.length);
    };
    ForcerStation.prototype.serializeExtras = function () {
        return this.cur.toString();
    };
    ForcerStation.prototype.deserializeExtras = function (data) {
        this.cur = parseInt(data, 10);
        if (isNaN(this.cur))
            this.cur = 0;
    };
    ForcerStation.prototype.refreshDisplay = function () {
        this.display = letters[this.cur];
        var desc = this.cur > 0 ? "It's currently set to manifest worlds with letter ".concat(this.display) : 'It\'s currently turned off...';
        this.pages[0].description = itemTexts.forcer.description.replace('[X]', desc);
    };
    ForcerStation.prototype.flip = function (dir) {
        this.cur += dir;
        if (this.cur < 0)
            this.cur = letters.length - 1;
        if (this.cur >= letters.length)
            this.cur = 0;
    };
    return ForcerStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/gambler.ts
var gambler_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var GamblerStations = /** @class */ (function (_super) {
    gambler_extends(GamblerStations, _super);
    function GamblerStations() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = itemTexts.gambler.name;
        _this.drawScreen = false;
        _this.drawTable = true;
        _this.iconScale = 0.5;
        _this.iconOffset = 7;
        _this.extraHeight = 10;
        _this.storage = new Inventory(5);
        _this.requiresPower = true;
        _this.pages = [
            {
                title: 'Double or Nothing',
                description: itemTexts.gambler.description,
            }
        ];
        return _this;
    }
    GamblerStations.prototype.recycle = function (entering) {
        var _this = this;
        if (!entering || !this.powered)
            return;
        this.storage.get().forEach(function (item) {
            if (!item)
                return;
            if (Inventory.canStack(item))
                item.amount = Math.min(item.amount * 2, MAX_STACK_SIZE);
            if (Math.random() < 0.5)
                _this.storage.remove(item);
        });
    };
    GamblerStations.prototype.update = function (tick, mouse) {
        if (!this.powered) {
            this.animationPhaseAbs = 0;
            return;
        }
        _super.prototype.update.call(this, tick, mouse);
    };
    // public getPagination(): string {
    //     return '~~~';
    // }
    // public showPagination(): boolean {
    //     return true;
    // }
    GamblerStations.prototype.drawExtras = function (ctx) {
        ctx.save();
        var rise = this.animationPhaseAbs * 3;
        ctx.translate(0, -1);
        fillRect(ctx, 0, 0, 10, 7);
        ctx.translate(0, -12);
        ctx.moveTo(-4, rise);
        ctx.lineTo(-10, 6 + rise * 0.5);
        ctx.lineTo(-4, 12);
        ctx.moveTo(4, rise);
        ctx.lineTo(10, 6 + rise * 0.5);
        ctx.lineTo(4, 12);
        ctx.stroke();
        ctx.translate(0, -3 - rise);
        ctx.rotate(Math.PI * 0.25);
        fillRect(ctx, 0, 0, 9, 9);
        ctx.restore();
    };
    return GamblerStations;
}(Station));


;// CONCATENATED MODULE: ./src/stations/converter.ts
var converter_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var ConverterStation = /** @class */ (function (_super) {
    converter_extends(ConverterStation, _super);
    function ConverterStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = itemTexts.converter.name;
        _this.drawScreen = false;
        _this.drawTable = true;
        _this.iconScale = 0.6;
        _this.iconOffset = 5;
        _this.wirePos = 3;
        _this.extraHeight = 10;
        _this.storage = new Inventory(5);
        _this.requiresPower = true;
        _this.pages = [
            {
                title: 'Gem Conversion',
                description: itemTexts.converter.description,
            }
        ];
        return _this;
    }
    ConverterStation.prototype.recycle = function (entering) {
        var _this = this;
        if (!entering || !this.powered)
            return;
        this.storage.get().forEach(function (item) {
            if (!item || item.id !== 'gem')
                return;
            item.color = randomCell(gems.filter(function (g) { return g !== item.color; }));
            item.amount = Math.floor(item.amount / 2);
            if (item.amount <= 0)
                _this.storage.remove(item);
        });
    };
    ConverterStation.prototype.update = function (tick, mouse) {
        if (!this.powered) {
            this.animationPhaseAbs = 0;
            return;
        }
        _super.prototype.update.call(this, tick, mouse);
    };
    // public getPagination(): string {
    //     return '~~~';
    // }
    // public showPagination(): boolean {
    //     return true;
    // }
    ConverterStation.prototype.drawExtras = function (ctx) {
        ctx.save();
        ctx.translate(0, 15);
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(-7, -12);
        ctx.lineTo(-5, -21);
        ctx.moveTo(7, -12);
        ctx.lineTo(5, -21);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, -16);
        ctx.lineTo(8, -25);
        ctx.lineTo(3, -28);
        ctx.lineTo(-3, -28);
        ctx.lineTo(-8, -25);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    };
    return ConverterStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/robotics.ts
var robotics_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();








var RoboticsStation = /** @class */ (function (_super) {
    robotics_extends(RoboticsStation, _super);
    function RoboticsStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = itemTexts.robotics.name;
        _this.drawScreen = false;
        _this.drawTable = true;
        _this.iconScale = 0.4;
        _this.iconOffset = 9;
        _this.extraHeight = 20;
        _this.requiresPower = true;
        _this.pages = [
            {
                title: itemTexts.teleporter.name,
                description: itemTexts.teleporter.shorter,
                cost: [
                    { color: 'cyan', amount: 30 },
                    { color: 'orange', amount: 10 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new TeleporterStation(_this.game, 0, 0), args.costs);
                    }
                }
            },
            {
                title: itemTexts.stacker.name,
                description: itemTexts.stacker.shorter,
                cost: [
                    { color: 'white', amount: 50 },
                    { color: 'orange', amount: 20 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new StackerStation(_this.game, 0, 0), args.costs);
                    }
                }
            },
            {
                title: itemTexts.forcer.name,
                description: itemTexts.forcer.shorter,
                cost: [
                    { color: 'magenta', amount: 20 },
                    { color: 'orange', amount: 30 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new ForcerStation(_this.game, 0, 0, 20, 20), args.costs);
                    }
                }
            },
            {
                title: itemTexts.gambler.name,
                description: itemTexts.gambler.shorter,
                cost: [
                    { color: 'yellow', amount: 20 },
                    { color: 'green', amount: 25 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new GamblerStations(_this.game, 0, 0, 20, 20), args.costs);
                    }
                }
            },
            {
                title: itemTexts.converter.name,
                description: itemTexts.converter.shorter,
                cost: [
                    { color: 'red', amount: 20 },
                    { color: 'blue', amount: 20 },
                    { color: 'purple', amount: 10 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new ConverterStation(_this.game, 0, 0, 20, 20), args.costs);
                    }
                }
            },
        ];
        _this.angleTargetLower = 0;
        _this.angleTargetUpper = 0;
        _this.angleTargetTip = 0;
        _this.angleLower = 0;
        _this.angleUpper = 0;
        _this.angleTip = 0;
        return _this;
    }
    RoboticsStation.prototype.update = function (tick, mouse) {
        if (!this.powered) {
            this.animationPhaseAbs = 0;
            return;
        }
        _super.prototype.update.call(this, tick, mouse);
        if (Math.random() < 0.02)
            this.angleTargetLower = Math.random() * 2 - 1;
        if (Math.random() < 0.02)
            this.angleTargetUpper = Math.random() * 2 - 1;
        if (Math.random() < 0.02)
            this.angleTargetTip = Math.random() * 2 - 1;
        this.angleLower += (this.angleTargetLower - this.angleLower) * 0.05;
        this.angleUpper += (this.angleTargetUpper - this.angleUpper) * 0.05;
        this.angleTip += (this.angleTargetTip - this.angleTip) * 0.05;
    };
    RoboticsStation.prototype.drawExtras = function (ctx) {
        ctx.save();
        fillRect(ctx, 0, 0, 9, 9);
        ctx.translate(0, -4);
        ctx.rotate(this.angleLower * 0.8);
        ctx.moveTo(0, 0);
        ctx.translate(0, -10);
        ctx.lineTo(0, 0);
        ctx.rotate(this.angleUpper * 1.2);
        ctx.translate(0, -10);
        ctx.lineTo(0, 0);
        ctx.rotate(this.angleTip * 1);
        ctx.quadraticCurveTo(5, -4, 4 - this.animationPhaseAbs * 1.2, -8);
        ctx.moveTo(0, 0);
        ctx.quadraticCurveTo(-5, -4, -4 + this.animationPhaseAbs * 1.2, -8);
        ctx.stroke();
        ctx.restore();
    };
    return RoboticsStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/tweaker.ts
var tweaker_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var TweakerStation = /** @class */ (function (_super) {
    tweaker_extends(TweakerStation, _super);
    function TweakerStation(game, x, y) {
        var _this = _super.call(this, game, x, y, 5, 20) || this;
        _this.name = itemTexts.tweaker.name;
        _this.drawScreen = false;
        _this.drawTable = false;
        _this.iconScale = 0.6;
        _this.iconOffset = 5;
        _this.pages = [
            {
                description: itemTexts.tweaker.description + ' \n \n Currently set to: MAX',
                flip: function (dir) { return _this.flip(dir); }
            }
        ];
        _this.cur = 0;
        return _this;
    }
    TweakerStation.prototype.showPagination = function () {
        return true;
    };
    TweakerStation.prototype.getPagination = function () {
        return "".concat(this.cur + 1, "/").concat(this.getMax());
    };
    TweakerStation.prototype.getMax = function () {
        return this.upgrades.pickSize;
    };
    TweakerStation.prototype.drawExtras = function (ctx) {
        fillRect(ctx, 0, 0, 15, 10);
        ctx.save();
        ctx.beginPath();
        ctx.lineWidth = 3;
        ctx.moveTo(0, 10);
        ctx.lineTo(0, -15);
        ctx.moveTo(4, 10);
        ctx.lineTo(-4, 10);
        ctx.translate(0, -10);
        ctx.moveTo(8, 0);
        ctx.quadraticCurveTo(0, -5, -8, 0);
        ctx.stroke();
        ctx.restore();
    };
    TweakerStation.prototype.flip = function (dir) {
        this.cur += dir;
        var max = this.getMax();
        if (this.cur < 0)
            this.cur = max - 1;
        if (this.cur >= max)
            this.cur = 0;
        this.upgrades.usedPickSize = max - this.cur;
        var size = this.cur === 0 ? 'MAX' : this.upgrades.usedPickSize;
        this.pages[0].description = itemTexts.tweaker.description + " \n \n Currently set to: ".concat(size);
    };
    return TweakerStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/crafting.ts
var crafting_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();











var CraftingStation = /** @class */ (function (_super) {
    crafting_extends(CraftingStation, _super);
    function CraftingStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = 'Crafting Station';
        _this.drawScreen = false;
        _this.extraHeight = 0;
        _this.pages = [
            {
                title: 'Bridge Tool',
                description: 'This tool can be used to build bridges when you need to cross over big gaps.',
                cost: [
                    { color: 'white', amount: 10 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craft({ id: 'tool', name: 'wrench', tool: 'wrench', icon: 'wrench', color: '#000', amount: 1 }, args.costs, true);
                    }
                }
            },
            {
                title: 'Paint Roller',
                description: 'This tool can be used to remove or paint background walls.',
                cost: [
                    { color: 'white', amount: 10 },
                    { color: 'red', amount: 5 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craft({ id: 'tool', name: 'roller', tool: 'roller', icon: 'roller', color: '#000', amount: 1 }, args.costs, true);
                    }
                }
            },
            {
                title: itemTexts.trash.name,
                description: itemTexts.trash.shorter,
                cost: [
                    { color: 'white', amount: 5 },
                    { color: 'red', amount: 1 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new TrashStation(args.game, 0, 0, 20, 20), args.costs);
                    }
                }
            },
            {
                title: itemTexts.storage.name,
                description: itemTexts.storage.shorter,
                cost: [
                    { color: 'white', amount: 15 },
                    { color: 'green', amount: 5 },
                    { color: 'blue', amount: 5 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new StorageStation(_this.game, 0, 0, 15, 20), args.costs);
                    }
                }
            },
            {
                title: itemTexts.display.name,
                description: itemTexts.display.shorter,
                cost: [
                    { color: 'white', amount: 5 },
                    { color: 'yellow', amount: 5 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new DisplayStation(_this.game, 0, 0, 20, 20), args.costs);
                    }
                },
                visible: function (u) { return u.advancedSchematics; }
            },
            {
                title: itemTexts.decrypter.name,
                description: itemTexts.decrypter.shorter,
                cost: [
                    { color: 'orange', amount: 10 },
                    { color: 'magenta', amount: 5 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new DecrypterStation(_this.game, 0, 0, 20, 20), args.costs);
                    }
                },
                visible: function (u) { return u.advancedSchematics; }
            },
            {
                title: itemTexts.power.name,
                description: itemTexts.power.shorter,
                cost: [
                    { color: 'cyan', amount: 5 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new PowerStation(_this.game, 0, 0), args.costs);
                    }
                },
                visible: function (u) { return u.advancedSchematics; }
            },
            {
                title: itemTexts.robotics.name,
                description: itemTexts.robotics.shorter,
                cost: [
                    { color: 'purple', amount: 15 },
                    { color: 'cyan', amount: 15 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        args.scene.craftStation(new RoboticsStation(_this.game, 0, 0, 20, 20), args.costs);
                    }
                },
                visible: function (u) { return u.advancedSchematics; }
            },
            {
                title: itemTexts.gems.name,
                description: itemTexts.gems.shorter,
                cost: [
                    { color: 'red', amount: 20 },
                    { color: 'purple', amount: 10 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        var station = new InfoStation(_this.game, 0, 0, itemTexts.gems.name);
                        args.scene.craftStation(station, args.costs);
                        station.deserializeExtras(itemTexts.gems.name);
                    }
                },
                visible: function (u) { return u.advancedSchematics; }
            },
            {
                title: itemTexts.tweaker.name,
                description: itemTexts.tweaker.shorter,
                cost: [
                    { color: 'white', amount: 9 },
                    { color: 'cyan', amount: 6 },
                    { color: 'orange', amount: 4 },
                    { color: 'yellow', amount: 2 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        var station = new TweakerStation(_this.game, 0, 0);
                        args.scene.craftStation(station, args.costs);
                    }
                },
                visible: function (u) { return u.advancedSchematics; }
            },
        ];
        return _this;
    }
    CraftingStation.prototype.drawExtras = function (ctx) {
        fillRect(ctx, 0, 0, 3, 3);
        fillRect(ctx, 5, 0, 3, 3);
        fillRect(ctx, -5, 0, 3, 3);
    };
    return CraftingStation;
}(Station));


;// CONCATENATED MODULE: ./src/stations/upgrade.ts
var upgrade_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var UpgradeStation = /** @class */ (function (_super) {
    upgrade_extends(UpgradeStation, _super);
    function UpgradeStation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.name = 'Upgrade Station';
        _this.drawScreen = false;
        _this.time = 0;
        _this.iconOffset = 3.5;
        _this.iconScale = 0.6;
        _this.pages = [
            {
                title: 'Advanced Schematics',
                description: 'Unlocks advanced crafting recipes on the crafting station.',
                cost: [
                    { color: 'white', amount: 20 },
                    { color: 'yellow', amount: 10 }
                ],
                button: {
                    label: 'Unlock',
                    action: function (args) {
                        if (args.scene.craft(null, args.costs)) {
                            args.upgrades.advancedSchematics = true;
                        }
                    }
                },
                visible: function (u) { return !u.advancedSchematics; }
            },
            {
                title: 'Pick Upgrade',
                description: 'Increases the dig radius and range of your pickaxe.',
                cost: [
                    { color: 'white', amount: 5 },
                    { color: 'red', amount: 5 },
                    { color: 'green', amount: 5 },
                    { color: 'blue', amount: 5 },
                ],
                button: {
                    label: 'Upgrade',
                    action: function (args) {
                        if (args.scene.craft(null, args.costs)) {
                            args.upgrades.pickSize++;
                            args.upgrades.usedPickSize = args.upgrades.pickSize;
                            args.upgrades.pickRange += 3;
                            _this.pages[1].cost = randomCost(5, 2 + Math.round(Math.random()));
                        }
                    }
                }
            },
            {
                title: 'Station Remover',
                description: 'Allows you to pick up stations with your pickaxe.',
                cost: [
                    { color: 'cyan', amount: 10 },
                    { color: 'yellow', amount: 10 },
                ],
                button: {
                    label: 'Upgrade',
                    action: function (args) {
                        if (args.scene.craft(null, args.costs)) {
                            args.upgrades.canRemoveStations = true;
                            _this.changePage(-1);
                        }
                    }
                },
                visible: function (u) { return !u.canRemoveStations; }
            },
            {
                title: 'Jetpack',
                description: 'Allows you to get some extra air time by jumping again.',
                cost: [
                    { color: 'purple', amount: 9 },
                    { color: 'cyan', amount: 9 },
                    { color: 'magenta', amount: 9 },
                    { color: 'red', amount: 9 },
                    { color: 'yellow', amount: 9 },
                    { color: 'orange', amount: 9 },
                ],
                button: {
                    label: 'Construct',
                    action: function (args) {
                        if (args.scene.craft(null, args.costs)) {
                            args.upgrades.doubleJump = true;
                            _this.changePage(-1);
                        }
                    }
                },
                visible: function (u) { return !u.doubleJump; }
            },
            {
                title: 'Auto Pick',
                description: 'Enhances your pickace with an automatically swinging arm.',
                cost: [
                    { color: 'white', amount: 50 },
                ],
                button: {
                    label: 'Upgrade',
                    action: function (args) {
                        if (args.scene.craft(null, args.costs)) {
                            args.upgrades.autoDig = true;
                            _this.changePage(-1);
                        }
                    }
                },
                visible: function (u) { return !u.autoDig; }
            },
            {
                title: 'Build Range',
                description: 'Increases the build range of your bridge tool.',
                cost: [
                    { color: 'white', amount: 20 },
                    { color: 'purple', amount: 10 },
                    { color: 'yellow', amount: 5 },
                ],
                button: {
                    label: 'Upgrade',
                    action: function (args) {
                        if (args.scene.craft(null, args.costs)) {
                            args.upgrades.buildRange += 10;
                        }
                    }
                }
            },
            {
                title: 'SHORT RANGE TELEPORT',
                description: 'Allows you to teleport short distances by pressing Q.',
                cost: [
                    { color: 'cyan', amount: 20 },
                    { color: 'magenta', amount: 30 },
                ],
                button: {
                    label: 'Upgrade',
                    action: function (args) {
                        if (args.scene.craft(null, args.costs)) {
                            args.upgrades.canWarp = true;
                            args.scene.notifyStation('Basics');
                            _this.changePage(-1);
                        }
                    }
                },
                visible: function (u) { return !u.canWarp; }
            },
        ];
        return _this;
    }
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    UpgradeStation.prototype.update = function (tick, mouse) {
        this.time = tick;
    };
    UpgradeStation.prototype.drawExtras = function (ctx) {
        ctx.save();
        fillRect(ctx, 0, 0, 18, 10);
        ctx.translate(0, -5);
        ctx.rotate(this.time * 0.001);
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.ellipse(0, 0, 4, 4, 0, 0, Math.PI * 2);
        ctx.stroke();
        var od = 5;
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.lineCap = 'round';
        for (var i = 0; i < 8; i++) {
            var angle = (Math.PI * 2) / 8 * i;
            var x = Math.cos(angle) * od;
            var y = Math.sin(angle) * od;
            ctx.moveTo(x, y);
            ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.lineCap = 'round';
        ctx.restore();
    };
    return UpgradeStation;
}(Station));


;// CONCATENATED MODULE: ./src/upgrades.ts
var Upgrades = /** @class */ (function () {
    function Upgrades() {
        this.pickSize = 4;
        this.pickRange = 50;
        this.buildRange = 50;
        this.collectRadius = 10;
        this.doubleJump = false;
        this.vision = 50;
        this.advancedSchematics = false;
        this.autoDig = false;
        this.autoDigDelay = 200;
        this.canWarp = false;
        this.canRemoveStations = false;
        this.usedPickSize = 4;
    }
    Upgrades.prototype.serialize = function () {
        return JSON.stringify([
            this.pickSize,
            this.pickRange,
            this.buildRange,
            this.collectRadius,
            this.doubleJump,
            this.vision,
            this.advancedSchematics,
            this.autoDig,
            this.autoDigDelay,
            this.canWarp,
            this.canRemoveStations,
            this.usedPickSize
        ]);
    };
    Upgrades.prototype.deserialize = function (data) {
        var _a;
        if (!data)
            return;
        var values = JSON.parse(data);
        this.pickSize = values[0];
        this.pickRange = values[1];
        this.buildRange = values[2];
        this.collectRadius = values[3];
        this.doubleJump = values[4];
        this.vision = values[5];
        this.advancedSchematics = values[6];
        this.autoDig = values[7];
        this.autoDigDelay = values[8];
        this.canWarp = values[9];
        this.canRemoveStations = values[10];
        this.usedPickSize = (_a = values[11]) !== null && _a !== void 0 ? _a : this.pickSize;
    };
    return Upgrades;
}());


;// CONCATENATED MODULE: ./src/stations/trophy.ts
var trophy_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var TrophyStation = /** @class */ (function (_super) {
    trophy_extends(TrophyStation, _super);
    function TrophyStation(game, x, y, index, world, fill) {
        if (fill === void 0) { fill = 0; }
        var _this = _super.call(this, game, x, y, 20, 20) || this;
        _this.index = index;
        _this.world = world;
        _this.fill = fill;
        _this.name = 'Trophy';
        _this.drawTable = false;
        _this.drawScreen = false;
        _this.extraHeight = 5;
        _this.iconScale = 0.55;
        _this.iconOffset = 5;
        _this.pages = [];
        _this.display = index.toString();
        _this.setupPages();
        return _this;
    }
    TrophyStation.prototype.setupPages = function () {
        this.pages = [{
                title: "Found from ".concat(this.world, " world"),
                description: 'I should bring it back to the ship for further inspection.',
            }];
    };
    TrophyStation.prototype.serializeExtras = function () {
        return [this.index, this.world].join(',');
    };
    TrophyStation.prototype.deserializeExtras = function (data) {
        var _a = data.split(','), index = _a[0], world = _a[1];
        this.index = parseInt(index, 10);
        this.display = isNaN(this.index) ? '' : index.toString();
        this.world = world;
        this.setupPages();
        this.recycle();
    };
    TrophyStation.prototype.recycle = function () {
        if (this.storage)
            return;
        this.pages[0].description = 'There is a hidden compartment in the trophy with some items in it.';
        this.storage = new Inventory(5);
        if (this.fill > 0)
            this.storage.fill(this.fill);
    };
    TrophyStation.prototype.getPagination = function () {
        return "".concat(this.index, "/8");
    };
    TrophyStation.prototype.showPagination = function () {
        return true;
    };
    TrophyStation.prototype.drawExtras = function (ctx) {
        this.displayOffset = -1;
        ctx.beginPath();
        ctx.moveTo(-7, 11);
        ctx.lineTo(7, 11);
        ctx.lineTo(5, 5);
        ctx.lineTo(2, 2);
        ctx.lineTo(2, -2);
        ctx.lineTo(7, -15);
        ctx.lineTo(-7, -15);
        ctx.lineTo(-2, -2);
        ctx.lineTo(-2, 2);
        ctx.lineTo(-5, 5);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(5, -10);
        ctx.quadraticCurveTo(15, -10, 0, -3);
        ctx.moveTo(-5, -10);
        ctx.quadraticCurveTo(-15, -10, 0, -3);
        ctx.stroke();
    };
    return TrophyStation;
}(Station));


;// CONCATENATED MODULE: ./src/back-word.ts
var back_word_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var BackWord = /** @class */ (function (_super) {
    back_word_extends(BackWord, _super);
    function BackWord(points, fontSize, index) {
        var _this = _super.call(this, null, 0, 0, 0, 0) || this;
        _this.fontSize = fontSize;
        _this.letters = [];
        var word = Math.random() < 0.6 ? randomCell(threeLetterWords).toUpperCase() : '';
        _this.letters = word.split('').map(function (l, i) {
            var x = -100 + (WIDTH / points.length) * (index + i - 1);
            var y = 100 * points[index + i - 1];
            var angle = (Math.random() * 2 - 1) * 0.2;
            return { letter: l, x: x, y: y, angle: angle };
        });
        return _this;
    }
    BackWord.prototype.draw = function (ctx, color, offset) {
        var _this = this;
        this.letters.forEach(function (l) {
            ctx.save();
            ctx.translate(l.x, l.y + offset - _this.fontSize * 0.1);
            ctx.rotate(l.angle);
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            // ctx.textBaseline = 'alphabetic';
            ctx.font = "".concat(_this.fontSize, "px ").concat(font);
            ctx.fillText(l.letter, 0, 0);
            ctx.restore();
        });
    };
    return BackWord;
}(Entity));


;// CONCATENATED MODULE: ./src/engine/zip.ts
var zip_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var zip_generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g = Object.create((typeof Iterator === "function" ? Iterator : Object).prototype);
    return g.next = verb(0), g["throw"] = verb(1), g["return"] = verb(2), typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var zip = function (str) { return zip_awaiter(void 0, void 0, void 0, function () {
    var byteArray, cs, writer, resp;
    return zip_generator(this, function (_a) {
        byteArray = new TextEncoder().encode(str);
        cs = new CompressionStream('gzip');
        writer = cs.writable.getWriter();
        writer.write(byteArray);
        writer.close();
        resp = new Response(cs.readable).arrayBuffer();
        return [2 /*return*/, resp.then(function (data) { return Array.from(new Uint8Array(data)).map(function (v) { return String.fromCharCode(v); }).join(''); })];
    });
}); };
var unzip = function (data) { return zip_awaiter(void 0, void 0, void 0, function () {
    var coded, buffer, cs, writer, arrayBuffer;
    return zip_generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                coded = data.split('').map(function (v) { return v.charCodeAt(0); });
                buffer = new Uint8Array(coded);
                cs = new DecompressionStream('gzip');
                writer = cs.writable.getWriter();
                writer.write(buffer);
                writer.close();
                return [4 /*yield*/, new Response(cs.readable).arrayBuffer()];
            case 1:
                arrayBuffer = _a.sent();
                return [2 /*return*/, new TextDecoder().decode(arrayBuffer)];
        }
    });
}); };

;// CONCATENATED MODULE: ./src/scene.ts
var scene_extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var scene_assign = (undefined && undefined.__assign) || function () {
    scene_assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return scene_assign.apply(this, arguments);
};
var scene_spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};

































var BRIDGE = 7;
var SHIP_OFFSET = { x: 40, y: 60 };
var ENCRYPTED_MESSAGE = '#@\n &?+!\n #:-\n =-/,\n )%$!';
var Scene = /** @class */ (function (_super) {
    scene_extends(Scene, _super);
    function Scene(game) {
        var _this = _super.call(this, game, 0, 0) || this;
        _this.debug = false;
        _this.building = false;
        _this.inBase = false;
        _this.gems = [];
        _this.stations = [];
        _this.tempStations = [];
        _this.bgColor = '#999';
        _this.midColor = '#333';
        _this.stationColor = '#111';
        _this.showInventory = false;
        _this.upgrades = new Upgrades();
        _this.prevTick = 0;
        _this.hue = 200;
        _this.backMountains = [];
        _this.frontMountains = [];
        _this.decryptedMessage = ENCRYPTED_MESSAGE;
        _this.ready = false;
        _this.restrictions = {};
        _this.dude = new Dude(game, _this, _this.upgrades);
        _this.world = document.createElement('canvas');
        _this.world.width = 800;
        _this.world.height = 400;
        _this.worldContext = _this.world.getContext('2d', { willReadFrequently: true });
        _this.ship = document.createElement('canvas');
        _this.ship.width = 800;
        _this.ship.height = 400;
        _this.backMountains = Array.from(Array(12)).map(function () { return Math.random(); });
        _this.frontMountains = Array.from(Array(10)).map(function () { return Math.random(); });
        _this.backWords = [
            new BackWord(_this.backMountains, randomInt(50, 80), randomInt(1, 5)),
            new BackWord(_this.backMountains, randomInt(80, 100), randomInt(7, 10))
        ];
        _this.frontWord = new BackWord(_this.frontMountains, 120, randomInt(1, _this.frontMountains.length - 2));
        _this.generateClouds();
        _this.generateLines();
        _this.baseContext = _this.ship.getContext('2d', { willReadFrequently: true });
        _this.ensurePlatform();
        _this.generateWorldWith('404');
        _this.recipe = new StationMenu(game, _this.dude, _this.inventory, _this, _this.upgrades);
        _this.inventory = new Toolbar(game, _this, _this.dude);
        _this.loadSave();
        return _this;
    }
    Scene.prototype.generateLines = function () {
        this.lines = Array.from(Array(70)).map(function () { return ({
            x: -WIDTH + Math.random() * WIDTH * 2,
            y: Math.random() * HEIGHT,
            speed: Math.random(),
            width: Math.random(),
            length: Math.random()
        }); });
    };
    Scene.prototype.generateClouds = function () {
        this.clouds = Array.from(Array(randomInt(5, 15))).map(function () { return ({
            x: -WIDTH + Math.random() * WIDTH * 2,
            y: Math.random() * HEIGHT,
            speed: -1 + 2 * Math.random(),
            scale: 0.7 + Math.random() * 1
        }); });
    };
    Scene.prototype.createNote = function (message) {
        return { id: 'note', name: message, tool: 'note', icon: 'note', color: '#000', amount: 1, customIcon: true };
    };
    Scene.prototype.craftStation = function (station, costs) {
        this.craft(this.wrapStation(station), costs, true);
    };
    Scene.prototype.wrapStation = function (station) {
        return { id: 'station', name: station.constructor.name, tool: 'builder', icon: null, color: '#000', amount: 1, customIcon: true, station: station };
    };
    Scene.prototype.craft = function (item, costs, needsSpace) {
        if (needsSpace === void 0) { needsSpace = false; }
        var all = this.getGemCounts();
        var hasMaterials = costs.every(function (c) { return all[c.color] && all[c.color] >= c.amount; });
        if (!hasMaterials) {
            this.game.camera.shake(1, 0.25, 0.03);
            this.game.audio.noMaterials();
            this.dude.talk('I don\'t have the required materials.');
            return false;
        }
        if (needsSpace && !this.inventory.hasSpace()) {
            this.game.camera.shake(1, 0.25, 0.03);
            this.game.audio.noMaterials();
            this.dude.talk('I don\'t have space for that.');
            return false;
        }
        this.consume(costs);
        if (item)
            this.inventory.addItem(item);
        this.game.audio.craft();
        this.game.camera.shake(1, 0.25, 0.03);
        var p = offset(this.dude.p, 0, -5);
        this.throwBits(p, 20, '#fff', 1, true);
        this.add(new Pulse(this.game, p.x, p.y, 20, 0.6, 4, 40));
        this.refreshDisplays();
        return true;
    };
    Scene.prototype.decrypt = function () {
        var normal = 'THE\n END!\n YOU\n WIN,\n PAL!';
        for (var i = 0; i < 10; i++) {
            var index = Math.floor(Math.random() * normal.length);
            if (normal[index] !== this.decryptedMessage[index]) {
                var start = this.decryptedMessage.substring(0, index);
                var end = this.decryptedMessage.substring(index + 1);
                this.decryptedMessage = start + normal[index] + end;
                var cockpit = this.notifyStation('Cockpit');
                if (cockpit)
                    cockpit.getPages()[cockpit.getPages().length - 1].description = this.decryptedMessage;
                return;
            }
        }
    };
    Scene.prototype.notifyStation = function (name) {
        var station = this.stations.find(function (s) { return s.serializeExtras() === name; });
        if (station)
            station.display = '!!';
        return station;
    };
    Scene.prototype.getGemCounts = function () {
        return scene_spreadArray(scene_spreadArray([], this.inventory.getItems(), true), this.stations.flatMap(function (s) { return s.getItems(); }), true).filter(function (i) { return (i === null || i === void 0 ? void 0 : i.id) === 'gem'; }).reduce(function (totals, item) {
            if (!totals[item.color]) {
                totals[item.color] = 0;
            }
            totals[item.color] += item.amount;
            return totals;
        }, {});
    };
    Scene.prototype.recycleStations = function () {
        var _this = this;
        this.stations.forEach(function (s) { return s.recycle(true); });
        if (this.stations.some(function (s) { return s.getName() === itemTexts.stacker.name && s.powered; })) {
            var items = this.inventory.getItems().filter(function (g) { return g && g.id === 'gem'; });
            items.forEach(function (item) {
                var target = _this.stations.find(function (s) { return s.canAdd(item); });
                if (target) {
                    target.store(scene_assign({}, item), item);
                }
            });
            this.inventory.clearEmpties();
        }
    };
    Scene.prototype.refreshDisplays = function () {
        var counts = this.getGemCounts();
        this.stations.forEach(function (s) { return s.refreshDisplay(counts); });
    };
    Scene.prototype.consume = function (costs) {
        var left = scene_spreadArray([], costs.map(function (c) { return (scene_assign({}, c)); }), true);
        this.inventory.consume(left);
        this.stations.forEach(function (s) {
            s.consume(left);
        });
    };
    Scene.prototype.swapTo = function (index) {
        this.inventory.use(index, false);
    };
    Scene.prototype.isMenuOpen = function () {
        return !!this.station;
    };
    Scene.prototype.createShip = function () {
        this.inventory.addItem({ id: 'tool', name: 'pick', tool: 'pick', icon: 'pick', color: '#000', amount: 1, customIcon: true });
        // this.inventory.addItem({ id: 'tool', name: 'wrench', tool: 'wrench', icon: 'wrench', color: '#000', amount: 1, customIcon: true });
        // this.inventory.addItem(this.createNote('CLOSE, BUT NO CIGAR'));
        var bc = this.baseContext;
        bc.save();
        bc.translate(SHIP_OFFSET.x, SHIP_OFFSET.y);
        bc.save();
        bc.translate(WIDTH * 0.5, HEIGHT * 0.5);
        bc.fillStyle = this.midColor;
        bc.beginPath();
        bc.moveTo(-10, 0);
        bc.quadraticCurveTo(0, 40, 80, 80);
        bc.lineTo(50, 0);
        bc.closePath();
        bc.fill();
        bc.beginPath();
        bc.moveTo(-70, 0);
        bc.quadraticCurveTo(-70, 30, -10, 60);
        bc.lineTo(-20, 0);
        bc.closePath();
        bc.fill();
        bc.strokeStyle = this.midColor;
        bc.lineWidth = 4;
        bc.translate(-190, -15);
        bc.strokeRect(-10, -10, 20, 20);
        bc.moveTo(10, 0);
        bc.lineTo(30, 0);
        bc.lineTo(30, -20);
        bc.moveTo(-10, 0);
        bc.lineTo(-30, 0);
        bc.lineTo(-30, -20);
        bc.stroke();
        bc.lineWidth = 3;
        bc.translate(0, -1);
        drawArrows(bc);
        bc.restore();
        bc.fillStyle = '#000';
        bc.lineWidth = 15;
        bc.beginPath();
        bc.moveTo(WIDTH * 0.5 + 200, HEIGHT * 0.5 - 70);
        bc.lineTo(WIDTH * 0.5 + 160, HEIGHT * 0.5 - 50);
        bc.lineTo(WIDTH * 0.5 + 100, HEIGHT * 0.5 - 50);
        bc.lineTo(WIDTH * 0.5 + 100, HEIGHT * 0.5);
        bc.lineTo(WIDTH * 0.5 - 100, HEIGHT * 0.5);
        bc.lineTo(WIDTH * 0.5 - 130, HEIGHT * 0.5 - 30);
        bc.lineTo(WIDTH * 0.5 - 170, HEIGHT * 0.5 - 30);
        bc.moveTo(WIDTH * 0.5 - 210, HEIGHT * 0.5 - 30);
        bc.lineTo(WIDTH * 0.5 - 260, HEIGHT * 0.5 - 30);
        bc.lineTo(WIDTH * 0.5 - 300, HEIGHT * 0.5 - 55);
        bc.quadraticCurveTo(WIDTH * 0.5 - 260, HEIGHT * 0.5 - 120, WIDTH * 0.5 - 160, HEIGHT * 0.5 - 120);
        bc.stroke();
        bc.restore();
        bc.save();
        bc.translate(-7 + SHIP_OFFSET.x, 60 + SHIP_OFFSET.y);
        bc.beginPath();
        bc.moveTo(WIDTH * 0.5 + 100, HEIGHT * 0.5 - 100 + 20);
        bc.lineTo(WIDTH * 0.5 + 135, HEIGHT * 0.5 - 100 + 30);
        bc.lineTo(WIDTH * 0.5 + 135, HEIGHT * 0.5 - 100 + 10);
        bc.closePath();
        bc.fillStyle = '#000';
        bc.fill();
        bc.restore();
        this.addStations();
    };
    Scene.prototype.addStations = function () {
        var x = WIDTH * 0.5 + SHIP_OFFSET.x;
        var y = HEIGHT * 0.5 + SHIP_OFFSET.y;
        this.stations.push(new CraftingStation(this.game, x - 70, y - HEIGHT - 18, 20, 20));
        this.stations.push(new TrashStation(this.game, x + 80, y - HEIGHT - 18, 20, 20));
        this.stations.push(new UpgradeStation(this.game, x + 125, y - HEIGHT - 18 - 50, 20, 20));
        // this.stations.push(new DisplayStation(this.game, x + 50, y - HEIGHT - 18, 20, 20));
        // this.stations.push(new DecrypterStation(this.game, x + 50, y - HEIGHT - 18, 20, 20));
        // this.stations.push(new TrophyStation(this.game, x + 50, y - HEIGHT - 18, 1, 'SEA'));
        // this.stations.push(new GamblerStations(this.game, x + 50, y - HEIGHT - 18, 20, 20));
        var cockpit = new InfoStation(this.game, x - 235, y - HEIGHT - 18 - 30, 'Cockpit');
        this.stations.push(cockpit);
        cockpit.deserializeExtras(cockpit.serializeExtras());
        var basics = new InfoStation(this.game, x - 150, y - HEIGHT - 18 - 30, 'Basics');
        basics.deserializeExtras(basics.serializeExtras());
        this.stations.push(basics);
    };
    Scene.prototype.isInBase = function () {
        return this.inBase;
    };
    Scene.prototype.ensurePlatform = function () {
        this.baseContext.save();
        this.baseContext.lineCap = 'butt';
        this.baseContext.translate(SHIP_OFFSET.x, SHIP_OFFSET.y);
        this.baseContext.fillStyle = '#000';
        this.baseContext.lineWidth = 15;
        this.baseContext.beginPath();
        this.baseContext.moveTo(WIDTH * 0.5 - 30, HEIGHT * 0.5 - 3);
        this.baseContext.lineTo(WIDTH * 0.5 + 30, HEIGHT * 0.5 - 3);
        this.baseContext.moveTo(WIDTH * 0.5 - 20, HEIGHT * 0.5 - 10);
        this.baseContext.lineTo(WIDTH * 0.5 + 20, HEIGHT * 0.5 - 10);
        this.baseContext.moveTo(WIDTH * 0.5 - 15, HEIGHT * 0.5 - 12);
        this.baseContext.lineTo(WIDTH * 0.5 + 15, HEIGHT * 0.5 - 12);
        this.baseContext.stroke();
        this.baseContext.restore();
    };
    Scene.prototype.resetWarps = function () {
        this.dude.warps = 1;
    };
    Scene.prototype.generateWorldWith = function (content) {
        this.resetWarps();
        var letters = this.stations.filter(function (s) { return s.getName() === itemTexts.forcer.name && s.powered; }).map(function (s) { return s.display; }).filter(function (s) { return s !== '?'; }).sort(randomSorter);
        if (letters.length > 0) {
            var pool_1 = scene_spreadArray([], threeLetterWords, true);
            letters.forEach(function (l) {
                var available = pool_1.filter(function (w) { return w.includes(l.toLowerCase()); });
                if (available.length > 0) {
                    pool_1 = available;
                }
            });
            content = randomCell(pool_1).toUpperCase();
        }
        // content = 'YOU';
        this.hue = Math.floor(Math.random() * 360);
        var ctx = this.worldContext;
        ctx.save();
        ctx.clearRect(0, 0, this.world.width, this.world.height);
        if (content === 'WON') {
            var safe = new StorageStation(this.game, WIDTH * 0.5 + 35, HEIGHT * 0.5 + 83, 10, 10);
            safe.changeSize(3);
            safe.store(this.createNote('CLOSE, BUT NO CIGAR'));
            this.tempStations.push(safe);
            safe.fill(3);
        }
        if (content === 'PAL') {
            this.tempStations.push(new TrophyStation(this.game, WIDTH * 0.5 - 5, HEIGHT * 0.5 + 28, 5, 'PAL', 5));
        }
        if (content === 'WIN') {
            this.restrictions.mine = true;
            this.restrictions.build = true;
            ctx.translate(0, -10);
            this.tempStations.push(new TrophyStation(this.game, WIDTH * 0.5 + 34, HEIGHT * 0.5 + 133, 4, 'WIN', 8));
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(WIDTH * 0.5 - 30 + 54, HEIGHT * 0.5 + 155);
            ctx.lineTo(WIDTH * 0.5 - 10 + 54, HEIGHT * 0.5 + 155);
            ctx.stroke();
        }
        if (content === 'YOU') {
            this.tempStations.push(new TrophyStation(this.game, WIDTH * 0.5 - 8, HEIGHT * 0.5 + 78, 3, 'YOU', 2));
        }
        if (content === 'THE') {
            this.restrictions.mine = true;
            this.restrictions.build = true;
            this.tempStations.push(new TrophyStation(this.game, WIDTH * 0.75, HEIGHT * 0.5 - 18, 1, 'THE', 2));
        }
        if (content === 'END') {
            ctx.translate(0, -10);
            this.restrictions.teleport = true;
            this.restrictions.mine = true;
            this.tempStations.push(new TrophyStation(this.game, WIDTH * 0.5 - 20, HEIGHT * 0.5 + 90, 2, 'END', 5));
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(WIDTH * 0.5 - 30, HEIGHT * 0.5 + 113);
            ctx.lineTo(WIDTH * 0.5 - 10, HEIGHT * 0.5 + 113);
            ctx.stroke();
        }
        ctx.fillStyle = '#000';
        ctx.font = 'bold 300px arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(content, this.world.width * 0.5, this.world.height * 0.6);
        ctx.restore();
        this.addGems(ctx.measureText(content[1]).width, content.split(''));
    };
    Scene.prototype.addGems = function (middleWidth, letters) {
        this.gems = [];
        for (var i = 0; i < 100; i++) {
            var x = Math.floor(Math.random() * this.world.width);
            var y = Math.floor(Math.random() * this.world.height);
            if (!this.isGround(x, y))
                continue;
            var letter = letters[1];
            if (x > WIDTH * 0.5 + middleWidth * 0.5)
                letter = letters[2];
            if (x < WIDTH * 0.5 - middleWidth * 0.5)
                letter = letters[0];
            var color = this.getGemForLetter(letter);
            if (Math.random() < gems.indexOf(color) * 0.075)
                continue;
            this.gems.push({ x: x, y: y, color: color });
        }
    };
    // 0: "a: 345"
    // 1: "e: 289"
    // 2: "o: 278"
    // 3: "i: 187"
    // 4: "s: 170"
    // 5: "t: 160"
    // 6: "u: 152"
    // 7: "p: 138"
    // 8: "r: 134"
    // 9: "d: 129"
    // 10: "n: 129"
    // 11: "m: 127"
    // 12: "g: 117"
    // 13: "b: 115"
    // 14: "h: 107"
    // 15: "l: 102"
    // 16: "y: 101"
    // 17: "w: 87"
    // 18: "f: 79"
    // 19: "c: 75"
    // 20: "k: 58"
    // 21: "v: 43"
    // 22: "x: 40"
    // 23: "z: 30"
    // 24: "j: 26"
    // 25: "q: 4"
    Scene.prototype.getGemForLetter = function (letter) {
        switch (letter) {
            case 'I':
            case 'S':
            case 'T':
                return 'blue';
            case 'U':
            case 'P':
            case 'R':
                return 'green';
            case 'D':
            case 'N':
            case 'M':
                return 'red';
            case 'G':
            case 'B':
            case 'H':
                return 'yellow';
            case 'L':
            case 'Y':
            case 'W':
                return 'purple';
            case 'F':
            case 'C':
            case 'K':
                return 'cyan';
            case 'V':
            case 'X':
            case 'Z':
                return 'orange';
            case 'J':
            case 'Q':
                return 'magenta';
            default:
                return 'white';
        }
    };
    Scene.prototype.throwBits = function (p, amount, color, sizeMod, alreadyShifted) {
        var _this = this;
        if (sizeMod === void 0) { sizeMod = 1; }
        if (alreadyShifted === void 0) { alreadyShifted = false; }
        p = offset(p, 0, this.inBase && !alreadyShifted ? HEIGHT : 0);
        var bits = Array.from(Array(amount)).map(function () {
            var angle = (-1 + Math.random()) * Math.PI;
            var speed = Math.random() * 1 + 1;
            var size = Math.random() * 3 * sizeMod;
            return new RectParticle(_this.game, p.x, Math.min(p.y, HEIGHT), size, size, 0.3, { x: Math.cos(angle) * speed * 1.2, y: Math.sin(angle) * speed }, { force: { x: 0, y: 0.1 }, color: color });
        });
        this.add.apply(this, bits);
    };
    Scene.prototype.getButtons = function () {
        return scene_spreadArray(scene_spreadArray([], this.inventory.getButtons(), true), this.station ? this.recipe.getButtons() : [], true);
    };
    Scene.prototype.addGem = function (color) {
        this.inventory.addItem(Scene.createGem(color, 1));
    };
    Scene.createGem = function (color, amount) {
        return { id: 'gem', name: color, tool: 'none', icon: 'gem', color: color, outline: true, amount: amount };
    };
    Scene.prototype.toggleStationMenu = function () {
        if (this.station) {
            this.game.audio.shutDown();
        }
        this.station = this.prompted !== this.station ? this.prompted : null;
        this.recipe.showFor(this.station, this.inventory, this.dude.p.x > WIDTH * 0.5);
        if (this.station) {
            this.game.audio.station();
            this.station.open(this);
            return;
        }
    };
    Scene.prototype.getTeleporters = function () {
        return this.stations.filter(function (s) { return s instanceof TeleporterStation; });
    };
    Scene.prototype.loseHalf = function () {
        this.inventory.loseHalf();
    };
    Scene.prototype.isWarpRestricted = function () {
        return this.restrictions.teleport;
    };
    Scene.prototype.getDude = function () {
        return this.dude;
    };
    Scene.prototype.update = function (tick, mouse) {
        var _this = this;
        var _a;
        _super.prototype.update.call(this, tick, mouse);
        this.dude.update(tick, mouse);
        this.prevTick = tick;
        this.getButtons().forEach(function (b) { return b.update(tick, mouse); });
        scene_spreadArray(scene_spreadArray([], this.stations, true), this.tempStations, true).forEach(function (s) { return s.update(tick, mouse); });
        var m = offset(mouse, 0, this.inBase ? -HEIGHT : 0);
        var collected = this.gems.filter(function (g) { return g.loose && distance(g, _this.dude.p) < _this.upgrades.collectRadius; });
        if (collected.length > 0)
            this.game.audio.gem();
        collected.forEach(function (g) {
            _this.throwBits(g, 10, g.color, 0.75);
            _this.add(new Pulse(_this.game, g.x, g.y, 15, 0.4, 4, 20));
            _this.addGem(g.color);
        });
        this.gems = this.gems.filter(function (g) { return !collected.includes(g); });
        // console.log(collected);
        var curStations = scene_spreadArray([], this.inBase ? this.stations : this.tempStations, true);
        var dp = offset(this.dude.p, 0, this.inBase ? -HEIGHT : 0);
        var closest = curStations
            .sort(function (a, b) { return distance(a.p, dp) - distance(b.p, dp); })
            .map(function (a) {
            // console.log(distance(a.p, ));
            return a;
        })
            .find(function (s) { return distance(dp, s.p) < 10; });
        if (closest !== this.prompted) {
            this.prompted = closest;
            this.dude.showPrompt = !!this.prompted;
            if (closest)
                this.game.audio.prompt();
            if (!closest && this.station)
                this.toggleStationMenu();
        }
        var autoing = mouse.holding && this.upgrades.autoDig && tick - this.digTick > this.upgrades.autoDigDelay;
        if (mouse.pressing || this.dude.hasTool('pick', 'roller') && autoing) {
            this.digTick = tick;
            this.inventory.useSelected();
            if (this.getButtons().some(function (b) { return b.isInside(mouse); }))
                return;
            var range = this.dude.hasTool('pick', 'roller') ? this.upgrades.pickRange : this.upgrades.buildRange;
            var close_1 = this.isClose(m, range);
            if (close_1) {
                if (this.dude.hasTool('pick'))
                    this.dig(m.x, m.y, this.upgrades.usedPickSize);
                if (this.dude.hasTool('roller'))
                    this.dig(m.x, m.y, this.upgrades.usedPickSize, true);
                if (this.dude.hasTool('wrench')) {
                    if (this.restrictions.build) {
                        this.game.audio.fail();
                        this.dude.talk('Some force is preventing me from building here!');
                        return;
                    }
                    this.game.audio.build();
                    if (this.building) {
                        var dist = distance(this.bridgeStart, m);
                        var hasMaterial = this.inventory.hasMaterialFor(dist);
                        if (!hasMaterial) {
                            this.game.audio.fail();
                            this.dude.talk('Don\'t have enough materials for that!');
                            return;
                        }
                        this.building = false;
                        this.build(m);
                        this.inventory.consumeMaterial(dist);
                        return;
                    }
                    else {
                        this.dude.swing();
                        this.building = true;
                        this.bridgeStart = scene_assign({}, m);
                    }
                }
            }
            else {
                if (this.dude.hasTool('wrench')) {
                    this.game.audio.fail();
                    this.dude.talk('That\'s too far!');
                }
            }
            if (this.dude.hasTool('builder')) {
                this.place(m);
                this.dude.swing();
                this.game.audio.build();
            }
        }
        (_a = this.dude.getHeld()) === null || _a === void 0 ? void 0 : _a.updateStatus(this, offset(mouse, 0, -10));
    };
    Scene.prototype.getStation = function () {
        return this.station;
    };
    Scene.prototype.canSeeSky = function () {
        for (var i = this.dude.p.y; i > 0; i--) {
            var pixel = this.getContext().getImageData(this.dude.p.x, i, 1, 1);
            if (this.isBlack(pixel)) {
                return false;
            }
        }
        return true;
    };
    Scene.prototype.getActiveStations = function () {
        return this.inBase ? this.stations : this.tempStations;
    };
    Scene.prototype.isCloseToStation = function (station, root) {
        var pp = offset(root, this.p.x, this.inBase ? -HEIGHT : 0 + this.p.y);
        return this.getActiveStations().some(function (s) { return station.overlapsWith(s, pp); });
    };
    Scene.prototype.build = function (end) {
        var start = this.getWorldPos(this.bridgeStart.x, this.bridgeStart.y);
        var p = this.getWorldPos(end.x, end.y);
        var ctx = this.getContext();
        ctx.lineCap = 'round';
        ctx.beginPath();
        var diff = this.inBase ? HEIGHT : 0;
        ctx.moveTo(start.x, start.y + diff);
        ctx.lineTo(p.x, p.y + diff);
        ctx.lineWidth = BRIDGE * this.getRatio();
        ctx.strokeStyle = '#000';
        ctx.stroke();
        this.dude.swing();
    };
    Scene.prototype.canTeleport = function () {
        return !this.inBase && this.canSeeSky();
    };
    Scene.prototype.getRatio = function () {
        return this.world.width / WIDTH;
    };
    Scene.prototype.switchArea = function () {
        this.showInventory = true;
        this.resetTool();
        this.inBase = !this.inBase;
        if (this.inBase) {
            this.hue = Math.floor(Math.random() * 360);
            this.dude.p.x = WIDTH * 0.5 + SHIP_OFFSET.x;
            this.generateLines();
            this.ensurePlatform();
            this.recycleStations();
        }
        this.dude.p.y = this.inBase ? HEIGHT * 0.5 - 50 + SHIP_OFFSET.y : 0;
        this.restrictions = {};
        this.tempStations = [];
        if (!this.inBase) {
            this.save();
            this.generateWorldWith(randomCell(threeLetterWords).toUpperCase());
            this.generateClouds();
        }
        this.refreshDisplays();
        this.resetWarps();
    };
    Scene.prototype.packItemsForSave = function (items) {
        return items.map(function (i) { return i ? [
            i.id,
            i.amount,
            i.color,
            i.station ? i.station.serializeExtras() : i.icon,
            i.name,
            i.tool
        ] : null; });
    };
    Scene.prototype.createStationOf = function (type, extra) {
        switch (type) {
            case 'CraftingStation':
                return new CraftingStation(this.game, 0, 0, 20, 20);
            case 'TrashStation':
                return new TrashStation(this.game, 0, 0, 20, 20);
            case 'UpgradeStation':
                return new UpgradeStation(this.game, 0, 0, 20, 20);
            case 'StorageStation':
                return new StorageStation(this.game, 0, 0, 15, 20);
            case 'TrophyStation':
                return new TrophyStation(this.game, 0, 0, 1, '???');
            case 'InfoStation':
                // eslint-disable-next-line no-case-declarations
                var station = new InfoStation(this.game, 0, 0, extra);
                station.deserializeExtras(extra);
                return station;
            case 'PowerStation':
                return new PowerStation(this.game, 0, 0);
            case 'DecrypterStation':
                return new DecrypterStation(this.game, 0, 0, 20, 20);
            case 'GamblerStations':
                return new GamblerStations(this.game, 0, 0, 20, 20);
            case 'DisplayStation':
                return new DisplayStation(this.game, 0, 0, 20, 20);
            case 'TeleporterStation':
                return new TeleporterStation(this.game, 0, 0);
            case 'RoboticsStation':
                return new RoboticsStation(this.game, 0, 0, 20, 20);
            case 'StackerStation':
                return new StackerStation(this.game, 0, 0);
            case 'ForcerStation':
                return new ForcerStation(this.game, 0, 0, 20, 20);
            case 'ConverterStation':
                return new ConverterStation(this.game, 0, 0, 20, 20);
            case 'TweakerStation':
                return new TweakerStation(this.game, 0, 0);
            default:
                return null;
        }
    };
    Scene.prototype.loadSave = function () {
        var _this = this;
        var data = localStorage.getItem('world-404-v3');
        if (!data) {
            this.createShip();
            this.ready = true;
            return;
        }
        try {
            var outerParts_1 = JSON.parse(data);
            unzip(outerParts_1[1]).then(function (uncompressed) {
                var parts = JSON.parse(uncompressed);
                // console.log(parts);
                parts[1].forEach(function (i) { return _this.inventory.addItem(_this.unpack(i)); });
                var w = _this.baseContext.canvas.width;
                var h = _this.baseContext.canvas.height;
                var image = _this.baseContext.createImageData(w, h);
                unzip(outerParts_1[0]).then(function (uncompressed) {
                    var arr = uncompressed.split('');
                    arr.forEach(function (v, i) {
                        var code = (v.charCodeAt(0) - 32).toString();
                        var val = Math.round(parseInt(code[code.length - 1]) / 9 * 255);
                        var alpha = code.length > 1 ? Math.round(parseInt(code[0]) / 9 * 255) : 0;
                        image.data[i * 4] = val;
                        image.data[i * 4 + 1] = val;
                        image.data[i * 4 + 2] = val;
                        image.data[i * 4 + 3] = alpha;
                    });
                    _this.baseContext.putImageData(image, 0, 0);
                    _this.ready = true;
                });
                _this.baseContext.putImageData(image, 0, 0);
                _this.inBase = true;
                _this.dude.p.x = WIDTH * 0.5 + SHIP_OFFSET.x;
                _this.dude.p.y = -200;
                _this.showInventory = true;
                setTimeout(function () {
                    _this.dude.p.x = WIDTH * 0.5 + SHIP_OFFSET.x;
                    _this.dude.p.y = HEIGHT * 0.5 - 50 + SHIP_OFFSET.y;
                }, 100);
                _this.upgrades.deserialize(parts[2]);
                parts[0].forEach(function (s) {
                    var station = _this.createStationOf(s[0], s[3]);
                    if (!station)
                        return;
                    station.init();
                    if (station) {
                        station.p.x = s[1];
                        station.p.y = s[2];
                        station.deserializeExtras(s[3]);
                        if (s[4]) {
                            var items = s[4].map(function (a) { return _this.unpack(a); });
                            items.forEach(function (item) { return station.store(item); });
                        }
                        _this.stations.push(station);
                    }
                });
                _this.powerStations();
                _this.refreshDisplays();
            });
        }
        catch (e) {
            console.error('Error loading save', e);
            this.createShip();
            this.ready = true;
        }
    };
    Scene.prototype.save = function () {
        var _this = this;
        var w = this.baseContext.canvas.width;
        var h = this.baseContext.canvas.height;
        var image = this.baseContext.getImageData(0, 0, w, h);
        var data = image.data.reduce(function (a, v, i) {
            if (i % 4 == 0) {
                var amt = Math.round(v / 255 * 9);
                var alpha = Math.round(image.data[i + 3] / 255 * 9);
                a.push(String.fromCharCode(32 + amt + alpha * 10));
            }
            return a;
        }, []).join('');
        var others = JSON.stringify([
            this.stations.map(function (s) { return ([
                s.constructor.name,
                s.p.x,
                s.p.y,
                s.serializeExtras(),
                _this.packItemsForSave(s.getItems())
            ]); }),
            this.packItemsForSave(this.inventory.getItems()),
            this.upgrades.serialize()
        ]);
        zip(data).then(function (compressed) {
            zip(others).then(function (compressedOthers) {
                // console.log('world size', compressed.length);
                localStorage.setItem('world-404-v3', JSON.stringify([
                    compressed,
                    compressedOthers
                ]));
            });
        });
    };
    Scene.prototype.unpack = function (data) {
        return data && data[0] ? {
            id: data[0],
            amount: data[1],
            color: data[2],
            icon: data[3],
            name: data[4],
            tool: data[5],
            station: data[0] === 'station' ? this.createStationOf(data[4], data[3]) : null,
        } : null;
    };
    Scene.prototype.getWorldPos = function (x, y) {
        var ratio = this.getRatio();
        return {
            x: Math.round(x * ratio),
            y: Math.round(y * ratio)
        };
    };
    Scene.prototype.collides = function (x, y, radius) {
        var _this = this;
        var points = scene_spreadArray([
            { x: 0, y: 0 },
            { x: 0, y: 1 },
            { x: 0, y: -1 }
        ], Array.from(Array(5)).flatMap(function (_, i) { return ([
            { x: 0.25 * _this.dude.getDir(), y: 0.2 * i },
            // { x: -0.25, y: 0.2 * i }
        ]); }), true);
        return points.some(function (p) { return _this.isGround(x + p.x * radius, y + p.y * radius); });
    };
    Scene.prototype.resetTool = function () {
        this.building = false;
    };
    Scene.prototype.isGround = function (x, y) {
        var p = this.getWorldPos(x, y);
        if (p.x < 0 || p.x >= this.world.width || p.y < 0 || p.y >= this.world.height)
            return false;
        var pixel = this.getContext().getImageData(p.x, p.y, 1, 1);
        return this.isBlack(pixel);
    };
    Scene.prototype.isBlack = function (pixel) {
        return pixel.data[0] < 10 && pixel.data[1] < 10 && pixel.data[2] < 10 && pixel.data[3] > 100;
    };
    Scene.prototype.isNonBlack = function (pixel) {
        return pixel.data[0] > 0 || pixel.data[1] > 0 || pixel.data[2] > 0 || pixel.data[3] <= 100;
    };
    Scene.prototype.getContext = function () {
        return this.inBase ? this.baseContext : this.worldContext;
    };
    Scene.prototype.getGroundPos = function (x, y) {
        var p = this.getWorldPos(x, y);
        for (var i = 0; i < 10; i++) {
            var pixel = this.getContext().getImageData(p.x, p.y - i, 1, 1);
            if (!this.isBlack(pixel)) {
                return (i - 1);
            }
        }
        return 0;
    };
    Scene.prototype.dig = function (x, y, radius, painting) {
        var _this = this;
        this.dude.swing();
        var ctx = this.getContext();
        var diff = this.inBase ? HEIGHT : 0;
        var p = this.getWorldPos(x, y + diff);
        if (this.upgrades.canRemoveStations && !painting) {
            var curStations = scene_spreadArray([], this.inBase ? this.stations : this.tempStations, true);
            var detatched = curStations.filter(function (s) { return distance(offset(s.p, 0, diff), p) < radius; });
            detatched.forEach(function (s) {
                if (!_this.inventory.hasSpace()) {
                    _this.game.audio.fail();
                    _this.dude.talk('I don\'t have space for that!');
                    return;
                }
                if (s.hasContents() && _this.inBase) {
                    _this.dude.talk('This station has items inside.\nI should probably place it down soon.\nOr the items might dematerialize!');
                }
                _this.stations = _this.stations.filter(function (st) { return st !== s; });
                _this.tempStations = _this.tempStations.filter(function (st) { return st !== s; });
                _this.game.audio.loosen();
                _this.game.audio.detatch();
                s.pick();
                _this.throwBits({ x: x, y: y }, 10, '#000', 0.75);
                _this.add(new Pulse(_this.game, s.p.x, s.p.y, 40, 0.6, 4, 60));
                s.p = { x: 0, y: 0 };
                _this.inventory.addItem(_this.wrapStation(s));
                _this.restrictions = {};
            });
            this.refreshDisplays();
            this.powerStations();
            if (detatched.length > 0)
                return;
        }
        if (this.restrictions.mine) {
            this.game.audio.fail();
            this.dude.talk('The ground is too hard to dig here!');
            return;
        }
        if (!this.inBase) {
            var loosen = this.gems.filter(function (g) { return !g.loose && distance(g, p) < radius; });
            if (loosen.length > 0)
                this.game.audio.loosen();
            loosen.forEach(function (g) { return g.loose = true; });
        }
        var mined = 0;
        for (var i = -radius; i < radius; i++) {
            for (var j = -radius; j < radius; j++) {
                var d = Math.sqrt(i * i + j * j);
                if (d < radius) {
                    var pixel = ctx.getImageData(p.x + i, p.y + j, 1, 1);
                    if (!painting && this.isBlack(pixel)) {
                        mined++;
                        // this.worldContext.clearRect(p.x + i, p.y + j, 1, 1);
                        ctx.fillStyle = this.midColor;
                        ctx.fillRect(p.x + i, p.y + j, 1, 1);
                    }
                    if (painting && this.isNonBlack(pixel)) {
                        mined++;
                        // this.worldContext.clearRect(p.x + i, p.y + j, 1, 1);
                        ctx.clearRect(p.x + i, p.y + j, 1, 1);
                    }
                }
            }
        }
        if (mined > 0) {
            this.game.audio.dig();
            var amount = Math.ceil(mined * 0.1);
            this.throwBits({ x: x, y: y }, amount, '#000');
            if (!painting) {
                this.inventory.addItem({ id: 'rock', name: 'black', tool: 'none', icon: 'gem', color: '#000', outline: true, amount: amount });
            }
        }
        else {
            this.game.audio.miss();
        }
    };
    Scene.prototype.getRange = function () {
        return this.dude.hasTool('pick', 'roller') ? this.upgrades.pickRange : this.upgrades.buildRange;
    };
    Scene.prototype.draw = function (ctx) {
        var _this = this;
        if (!this.ready) {
            ctx.fillStyle = '#000';
            ctx.fillRect(-100, -HEIGHT - 100, ctx.canvas.width + 200, ctx.canvas.height * 2 + 200);
            ctx.fill();
            return;
        }
        ctx.save();
        ctx.fillStyle = this.bgColor;
        var hOff = this.inBase ? HEIGHT : 0;
        ctx.fillRect(-100, -HEIGHT - 100, ctx.canvas.width + 200, ctx.canvas.height * 2 + 200);
        ctx.lineCap = 'round';
        // background
        if (this.inBase) {
            ctx.strokeStyle = '#ffffff11';
            ctx.lineWidth = 25 + 5 * this.animationPhaseAbs;
            // ctx.setLineDash([0, 35]);
            ctx.beginPath();
            for (var i = 0; i < 60; i++) {
                ctx.save();
                ctx.translate((this.prevTick % 2000) * 0.25 + i * 100 - 500, 0);
                ctx.rotate(Math.PI * 0.3);
                ctx.moveTo(i, -2000);
                ctx.lineTo(i, 5000);
                ctx.restore();
            }
            ctx.stroke();
            ctx.strokeStyle = '#ffffff22';
            ctx.setLineDash([]);
            this.lines.forEach(function (l) {
                ctx.beginPath();
                ctx.lineWidth = 3 + 10 * l.width;
                ctx.moveTo(l.x, l.y);
                ctx.lineTo(l.x + l.length * 200, l.y);
                l.x += (1 + 1 * l.speed) * 1 * _this.delta;
                if (l.x > WIDTH * 2)
                    l.x = -WIDTH;
                ctx.stroke();
            });
        }
        var drawMountains = function (color, mid, line, gap, points) {
            ctx.strokeStyle = ctx.fillStyle = color;
            ctx.lineWidth = line;
            ctx.setLineDash([0, gap]);
            ctx.beginPath();
            ctx.moveTo(-100, HEIGHT + 100);
            ctx.lineTo(-100, HEIGHT * 0.6);
            var prev = HEIGHT * mid;
            points.forEach(function (m, i) {
                var w = i * (WIDTH / points.length);
                ctx.quadraticCurveTo(w - 200, prev, w - 100, HEIGHT * mid + m * 100);
                prev = HEIGHT * mid + m * 100;
            });
            ctx.lineTo(WIDTH + 100, HEIGHT * 0.6);
            ctx.lineTo(WIDTH + 100, HEIGHT + 100);
            ctx.stroke();
            ctx.fill();
        };
        // clouds
        var drawClouds = function (start, end) {
            _this.clouds.slice(start, end).forEach(function (c) {
                ctx.lineWidth = 100 * c.scale;
                ctx.setLineDash([0, 80 * c.scale]);
                // ctx.lineDashOffset = Math.sin(c.x * 0.001) * 100;
                ctx.beginPath();
                ctx.strokeStyle = '#ffffff33';
                ctx.ellipse(c.x, c.y, 140 * c.scale, 30 * c.scale, 0, 0, Math.PI * 2);
                c.x -= c.speed * _this.delta * 0.01;
                if (c.x < -WIDTH && c.speed > 0)
                    c.x = 2 * WIDTH + Math.random() * WIDTH;
                if (c.x > 2 * WIDTH && c.speed < 0)
                    c.x = -WIDTH - Math.random() * WIDTH;
                ctx.stroke();
            });
        };
        if (!this.inBase) {
            drawClouds(6, undefined);
            drawMountains('#777', 0.5, 30, 20, this.backMountains);
            this.backWords.forEach(function (bw) { return bw.draw(ctx, '#777', HEIGHT * 0.5); });
            drawMountains('#666', 0.75, 50, 30, this.frontMountains);
            this.frontWord.draw(ctx, '#666', HEIGHT * 0.75);
            drawClouds(0, 5);
        }
        var m = offset(this.game.getMouse(), 0, -hOff);
        ctx.setLineDash([]);
        ctx.beginPath();
        ctx.lineWidth = 1;
        if (this.inBase) {
            ctx.drawImage(this.ship, 0, 0, this.ship.width, this.ship.height, 0, 0, WIDTH, HEIGHT);
            ctx.translate(0, HEIGHT);
        }
        ctx.imageSmoothingEnabled = false;
        // ctx.textRendering = 'geometricPrecision';
        ctx.drawImage(this.world, 0, 0, this.world.width, this.world.height, 0, 0, WIDTH, HEIGHT);
        this.stations.forEach(function (s) { return s.draw(ctx, _this.stationColor, false, _this.debug); });
        this.tempStations.forEach(function (s) { return s.draw(ctx, _this.stationColor, false, _this.debug); });
        if (this.dude.hasTool('builder') && this.dude.getHeld()) {
            ctx.strokeStyle = '#ffffff33';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(this.dude.p.x, this.dude.p.y - hOff);
            var sp = this.dude.getHeld().p;
            ctx.lineTo(m.x + sp.x, m.y + sp.y);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.save();
            ctx.translate(m.x, m.y - 10);
            this.dude.getHeld().draw(ctx, this.stationColor, false, this.debug);
            ctx.restore();
        }
        ctx.globalCompositeOperation = 'color';
        ctx.fillStyle = "hsl(".concat(this.hue, ", 60%, 60%)");
        ctx.fillRect(-100, -HEIGHT - 100, ctx.canvas.width + 200, ctx.canvas.height * 2 + 200);
        // ctx.globalAlpha = 0.7;
        // // ctx.globalCompositeOperation = 'luminosity';
        // const color = `hsl(${(this.hue + 180) % 360}, 60%, 60%)`;
        // const gradient = ctx.createLinearGradient(0, this.inBase ? -HEIGHT : 0, 0, this.inBase ? 0 : HEIGHT);
        // // gradient.addColorStop(0, color);
        // gradient.addColorStop(0.25, 'transparent');
        // gradient.addColorStop(0.3, 'transparent');
        // gradient.addColorStop(1, color);
        // ctx.fillStyle = gradient;
        // ctx.fillRect(-100, this.inBase ? -HEIGHT : 0, ctx.canvas.width + 200, HEIGHT);
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 1;
        this.stations.forEach(function (s) { return s.postDraw(ctx, _this.stationColor); });
        this.tempStations.forEach(function (s) { return s.postDraw(ctx, _this.stationColor); });
        ctx.fillStyle = '#fff';
        var close = this.isClose(m, this.getRange());
        if (!this.dude.hasTool('none', 'builder')) {
            var rad = this.dude.hasTool('pick', 'roller') ? this.upgrades.usedPickSize : 5;
            drawCircle(ctx, m, close ? rad : 4, 'transparent', close ? '#fff' : '#ffffff33');
        }
        if (this.building) {
            var dist = distance(this.bridgeStart, m);
            var canBuild = close && this.inventory.hasMaterialFor(dist);
            if (!canBuild)
                ctx.setLineDash([10, 5]);
            ctx.lineCap = 'round';
            ctx.lineWidth = canBuild ? BRIDGE : 3;
            ctx.strokeStyle = '#000';
            ctx.beginPath();
            ctx.moveTo(this.bridgeStart.x, this.bridgeStart.y);
            ctx.lineTo(m.x, m.y);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        ctx.restore();
        if (!this.inBase) {
            this.gems.forEach(function (g) {
                if (!_this.isClose(g, _this.upgrades.vision))
                    return;
                ctx.save();
                ctx.translate(g.x, g.y);
                _this.worldContext.fillStyle = g.color;
                drawCircle(ctx, { x: 0, y: 0 }, 2 + 4 * _this.animationPhaseAbs, '#ffffff22');
                ctx.beginPath();
                ctx.fillStyle = getGemColor(g.color);
                var rad = 3;
                ctx.moveTo(Math.cos(0) * rad, Math.sin(0) * rad);
                for (var index = 0; index < 5; index++) {
                    var angle = Math.PI * 0.4 * index;
                    ctx.lineTo(Math.cos(angle) * rad, Math.sin(angle) * rad);
                }
                ctx.closePath();
                ctx.fill();
                // ctx.lineWidth = 3;
                // ctx.strokeStyle = '#ffffff11';
                // ctx.rotate(this.tick * 0.005);
                // ctx.moveTo(-10, 0);
                // ctx.lineTo(10, 0);
                // ctx.moveTo(0, -10);
                // ctx.lineTo(0, 10);
                // ctx.stroke();
                ctx.restore();
                // drawCircle(ctx, g, 2, g.color);
            });
        }
        _super.prototype.draw.call(this, ctx);
        this.dude.draw(ctx);
        // ctx.beginPath();
        // const points: Vector[] = [
        //     { x: 0, y: 0 },
        //     { x: 0, y: 1 },
        //     { x: 0, y: -1 },
        //     ...Array.from(Array(10)).flatMap((_, i) => ([
        //         { x: 0.5, y: 0.1 * i },
        //         { x: -0.5, y: 0.1 * i }
        //     ])),
        // ];
        // const rad = 8;
        // points.forEach(p => {
        //     ctx.fillRect(p.x * rad + this.dude.p.x, p.y * rad + this.dude.p.y, 1, 1);
        // });
        // ctx.closePath();
        // ctx.stroke();
        if (this.showInventory)
            this.inventory.draw(ctx);
        if (this.station)
            this.recipe.draw(ctx);
    };
    Scene.prototype.isClose = function (m, range) {
        return distance(offset(this.dude.p, 0, this.inBase ? -HEIGHT : 0), m) < range;
    };
    Scene.prototype.place = function (p) {
        var station = this.dude.getHeld();
        if (!station)
            return;
        if (station.blocked) {
            this.game.audio.fail();
            this.dude.talk('I can\'t place it there.');
            return;
        }
        station.placing = false;
        station.blocked = false;
        station.p = offset(p, station.p.x, -10 + station.p.y);
        this.throwBits(station.p, 10, '#000', 0.75);
        this.add(new Pulse(this.game, station.p.x, station.p.y + (this.inBase ? HEIGHT : 0), 20, 0.6, 5, 30));
        this.game.camera.shake(0.5, 0.15, 0);
        station.init();
        (this.inBase ? this.stations : this.tempStations).push(station);
        this.dude.removeHeld();
        this.inventory.clearCurrent();
        this.resetTool();
        this.refreshDisplays();
        station.recycle(false);
        this.powerStations();
    };
    Scene.prototype.powerStations = function () {
        var needed = this.stations.filter(function (s) { return s.needsPower(); });
        needed.forEach(function (s) { return s.powered = false; });
        this.stations.filter(function (s) { return s.powerSupply; }).forEach(function (s) {
            var near = needed.filter(function (st) { return st !== s && distance(s.p, st.p) < 100; });
            near.forEach(function (s) { return s.powered = true; });
            s === null || s === void 0 ? void 0 : s.attach(near);
        });
    };
    return Scene;
}(Container));


;// CONCATENATED MODULE: ./src/index.ts



// import 'tauri-plugin-gamepad-api';
var WIDTH = 800;
var HEIGHT = 400;
var canvas = document.createElement('canvas');
var ctx = canvas.getContext('2d');
var mouse = { x: 0, y: 0 };
var audio = new AudioManager(false, false, false);
audio.prepare();
audio.startMusic();
var game = new Game(audio, canvas);
game.scene = new Scene(game);
canvas.id = 'game';
canvas.width = WIDTH;
canvas.height = HEIGHT;
document.body.appendChild(canvas);
var ratio = 1;
var x = 0;
var y = 0;
var resize = function () {
    ratio = Math.min(window.innerWidth / WIDTH, window.innerHeight / HEIGHT);
    canvas.style.transformOrigin = 'top left';
    x = (window.innerWidth - WIDTH * ratio) * 0.5;
    y = (window.innerHeight - HEIGHT * ratio) * 0.5;
    canvas.style.transform = "translate(".concat(x, "px,").concat(y, "px) scale(").concat(ratio, ")");
};
resize();
window.onresize = resize;
var isFull = false;
document.onfullscreenchange = function () { return isFull = !isFull; };
document.onmousemove = function (e) {
    mouse.x = isFull ? (e.offsetX - x) / ratio : e.offsetX;
    mouse.y = isFull ? (e.offsetY - y) / ratio : e.offsetY;
};
window.onkeydown = function (e) {
    audio.startMusic();
    game.pressed(e);
};
window.onkeyup = function (e) {
    game.released(e);
};
document.oncontextmenu = function (e) {
    e.preventDefault();
};
document.onmousedown = function (e) {
    audio.startMusic();
    mouse.pressing = true;
    mouse.holding = true;
    game.click(mouse, e.button === 2);
    // setTimeout(() => mouse.x = -999, 100);
};
document.onmouseup = function () { return mouse.holding = false; };
var tick = function (t) {
    requestAnimationFrame(tick);
    ctx.resetTransform();
    game.update(t, mouse);
    game.draw(ctx);
};
requestAnimationFrame(tick);

/******/ })()
;</script></body></html>